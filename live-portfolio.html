<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Portfolio Dashboard - UCSB Dean's Investment Group</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="portfolio-config.js"></script>
    <script src="tearsheet-generator.js"></script>
    <script src="individual-tearsheet-generator.js"></script>
    <style>
        /* ...existing code... (reset) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            overflow-x: hidden;
            background: transparent;
        }

        /* Background + particles to match index.html */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f1419, #1e3c72, #2a3c5f, #0f1419);
            background-size: 300% 300%;
            animation: gradientShift 20s ease infinite;
            z-index: -2;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            animation: float 12s ease-in-out infinite;
            opacity: 0.3;
        }

        .particle.gold {
            background: radial-gradient(circle, rgba(254, 188, 17, 0.6), rgba(255, 215, 0, 0.3));
            box-shadow: 0 0 10px rgba(254, 188, 17, 0.2);
        }

        .particle.blue {
            background: radial-gradient(circle, rgba(30, 60, 114, 0.6), rgba(42, 60, 95, 0.3));
            box-shadow: 0 0 10px rgba(30, 60, 114, 0.2);
        }

        .particle.white {
            background: radial-gradient(circle, rgba(255,255,255,0.4), rgba(255,255,255,0.2));
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); opacity: 0.3; }
            25% { transform: translateY(-20px) rotate(45deg) scale(1.1); opacity: 0.5; }
            50% { transform: translateY(-40px) rotate(90deg) scale(0.9); opacity: 0.2; }
            75% { transform: translateY(-20px) rotate(135deg) scale(1.05); opacity: 0.4; }
        }

        /* Shared header/nav to match index.html */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            z-index: 1000;
            padding: 1rem 0;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(254, 188, 17, 0.2);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }

        .logo i {
            color: #febc11;
            font-size: 2rem;
            transition: transform 0.3s ease;
        }

        .logo:hover i {
            transform: scale(1.1);
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 3rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            left: 0;
            background: #febc11;
            transition: width 0.3s ease;
        }

        .nav-links a:hover::after {
            width: 100%;
        }

        .nav-links a:hover {
            color: #febc11;
            transform: translateY(-2px);
        }

        .live-portfolio-link {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
            padding: 0.5rem 1rem !important;
            border-radius: 20px !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
        }

        .live-portfolio-link:hover {
            background: linear-gradient(135deg, #20c997, #28a745) !important;
            color: white !important;
            transform: translateY(-3px) !important;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3) !important;
        }

        .mobile-menu-toggle {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 0.5rem;
        }

        .mobile-menu-toggle span {
            width: 25px;
            height: 3px;
            background: #febc11;
            margin: 3px 0;
            transition: 0.3s;
            border-radius: 2px;
        }

        .mobile-menu-toggle.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .mobile-menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-toggle.active span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: flex;
            }

            .nav-links {
                position: fixed;
                top: 80px;
                left: -100%;
                width: 100%;
                height: calc(100vh - 80px);
                background: rgba(0, 0, 0, 0.95);
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                padding-top: 3rem;
                transition: left 0.3s ease;
                backdrop-filter: blur(20px);
            }

            .nav-links.active {
                left: 0;
            }

            .nav-links li {
                margin: 1rem 0;
            }

            .nav-links a {
                font-size: 1.5rem;
            }
        }

        /* Page shell similar to index (hero-like header + content) */
        .page-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 7rem 2rem 3rem; /* top padding for fixed header */
            color: white;
        }

        .dashboard-hero {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .dashboard-hero h1 {
            font-size: 3rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(135deg, #ffffff, #febc11, #ffffff);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 6s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .dashboard-hero .subtitle {
            font-size: 1.4rem;
            opacity: 0.9;
            margin-bottom: 0.75rem;
        }

        .dashboard-hero p {
            font-size: 1rem;
            opacity: 0.8;
            max-width: 800px;
            margin: 0.5rem auto 1.5rem;
        }

        .dashboard-tagline {
            font-size: 0.9rem;
            opacity: 0.75;
        }

        .cta-row {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.25rem;
        }

        .cta-button {
            display: inline-block;
            padding: 0.9rem 1.9rem;
            background: linear-gradient(135deg, #febc11, #ffd700);
            color: #1e3c72;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(254, 188, 17, 0.3);
        }

        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(254, 188, 17, 0.4);
        }

        .cta-secondary {
            background: transparent;
            border: 2px solid #febc11;
            color: #febc11;
        }

        .cta-secondary:hover {
            background: #febc11;
            color: #1e3c72;
        }

        .section-separator {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.25), transparent);
            margin: 2.5rem 0;
        }

        /* Card system to echo index.html */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .summary-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            border-radius: 12px;
            padding: 1.8rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.35);
            border: 1px solid rgba(254, 188, 17, 0.2);
            backdrop-filter: blur(16px);
        }

        .summary-card h3 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #e5e5e5;
            margin-bottom: 0.5rem;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #febc11;
            margin-bottom: 0.4rem;
        }

        .summary-card .change {
            font-size: 0.9rem;
            color: #c9d1d9;
        }

        .change.positive { color: #3fbf7f; }
        .change.negative { color: #ff6b6b; }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-live {
            background: rgba(40, 167, 69, 0.15);
            color: #4ade80;
            border: 1px solid rgba(40, 167, 69, 0.5);
        }

        .status-static {
            background: rgba(255, 193, 7, 0.12);
            color: #ffe27a;
            border: 1px solid rgba(255, 193, 7, 0.5);
        }

        .controls-shell {
            background: rgba(10, 14, 23, 0.85);
            border-radius: 16px;
            padding: 1.5rem 1.75rem;
            box-shadow: 0 12px 40px rgba(0,0,0,0.45);
            border: 1px solid rgba(255,255,255,0.06);
            margin-bottom: 2.2rem;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1.75rem;
            flex-wrap: wrap;
        }

        .api-setup {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            align-items: center;
        }

        .api-setup input {
            padding: 0.6rem 0.8rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.4);
            color: #e5e5e5;
            min-width: 260px;
            font-size: 0.85rem;
        }

        .api-setup input::placeholder {
            color: rgba(229,229,229,0.55);
        }

        .btn {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 0.55rem 1.2rem;
            border-radius: 999px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.25s ease;
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 28px rgba(0,0,0,0.55);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: #212529;
        }

        .controls-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .info-text {
            font-size: 0.78rem;
            color: #c9d1d9;
            line-height: 1.4;
        }

        code.inline-code {
            background: rgba(255,255,255,0.08);
            padding: 0.05rem 0.4rem;
            border-radius: 4px;
            font-size: 0.78rem;
        }

        /* Main layout (holdings + charts) styled as glass cards */
        .main-content {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .card-panel {
            background: rgba(255,255,255,0.06);
            border-radius: 16px;
            padding: 1.8rem 1.6rem;
            box-shadow: 0 12px 36px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(18px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding-bottom: 0.8rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
        }

        .section-stats {
            font-size: 0.8rem;
            color: #c9d1d9;
        }

        .portfolio-tabs {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 1.2rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding-bottom: 0.4rem;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            font-size: 0.8rem;
            color: #c9d1d9;
            border-radius: 999px;
            transition: all 0.2s ease;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.06);
            color: #febc11;
        }

        .tab-btn.active {
            background: rgba(254, 188, 17, 0.15);
            color: #febc11;
            font-weight: 600;
        }

        .holdings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            color: #e5e5e5;
        }

        .holdings-table th,
        .holdings-table td {
            padding: 0.55rem 0.45rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.07);
        }

        .holdings-table th {
            background: rgba(0,0,0,0.35);
            font-weight: 600;
            color: #f0f0f0;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .holdings-table tr:hover {
            background: rgba(255,255,255,0.04);
        }

        .symbol {
            font-weight: 600;
            color: #febc11;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .symbol:hover {
            color: #ffd666;
            text-decoration: underline;
            transform: scale(1.04);
        }

        /* Hover tooltip for symbol actions */
        .symbol-tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            background: linear-gradient(135deg, #003660 0%, #004d8a 100%);
            border: 2px solid #febc11;
            border-radius: 8px;
            padding: 8px;
            display: none;
            z-index: 9999;
            box-shadow: 0 6px 20px rgba(0,0,0,0.7);
            min-width: 180px;
            white-space: nowrap;
        }

        .symbol:hover .symbol-tooltip {
            display: block;
        }

        .tooltip-option {
            display: block;
            padding: 6px 12px;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            margin: 2px 0;
            text-align: left;
        }

        .tooltip-option:hover {
            background: rgba(254, 188, 17, 0.2);
            transform: translateX(3px);
        }

        .tooltip-option i {
            margin-right: 8px;
            width: 16px;
            display: inline-block;
        }

        .last-updated {
            font-size: 0.78rem;
            color: #c9d1d9;
            margin-top: 0.8rem;
            text-align: right;
        }

        .chart-container {
            position: relative;
            height: 260px;
            max-height: 260px;
            width: 100%;
            max-width: 100%;
            margin-bottom: 1.4rem;
            overflow: hidden;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .chart-info {
            font-size: 0.8rem;
            color: #c9d1d9;
            text-align: center;
            margin-bottom: 0.3rem;
        }

        .sector-breakdown {
            margin-top: 1.2rem;
            background: rgba(0,0,0,0.45);
            border-radius: 14px;
            padding: 1.3rem 1.1rem 1.4rem;
            border: 1px solid rgba(254,188,17,0.25);
            color: #ffffff; /* ensure text inside sector breakdown is white */
        }

        .sector-breakdown .section-title,
        .sector-breakdown .chart-info,
        .sector-breakdown .metric-card h4,
        .sector-breakdown .metric-detail,
        .sector-breakdown .metric-holdings {
            color: #f8fafc;
        }

        .metrics-grid .metric-card {
            color: #ffffff;
        }

        .sector-details-modal,
        .sector-details-modal .modal-content,
        .sector-details-modal .modal-body,
        .sector-details-modal .sector-summary .stat span,
        .sector-details-modal .sector-holdings-table th,
        .sector-details-modal .sector-holdings-table td {
            color: #ffffff;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.9rem;
            margin-top: 0.9rem;
            color: #ffffff; /* default white text in metric cards */
        }

        .metric-card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255,255,255,0.08);
            color: #ffffff; /* improve readability */
        }

        .metric-card h4 {
            font-size: 0.85rem;
            color: #ffffff;
            margin-bottom: 0.25rem;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #febc11;
            margin-bottom: 0.2rem;
        }

        .metric-detail {
            font-size: 0.78rem;
            color: #e5e5e5;
        }

        .metric-holdings {
            font-size: 0.72rem;
            color: #d1d5db;
            margin-top: 0.15rem;
        }

        /* Error + toast styles */
        .error-message {
            background: rgba(220, 53, 69, 0.14);
            color: #ffb3c0;
            padding: 0.9rem 1.1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border: 1px solid rgba(220, 53, 69, 0.5);
            font-size: 0.85rem;
        }

        /* Sector details modal: dark glass */
        .sector-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            color: #ffffff; /* base text white in modal */
        }

        .modal-content {
            background: radial-gradient(circle at top left, rgba(30,60,114,0.9), rgba(15,20,25,0.98));
            border-radius: 18px;
            width: 92%;
            max-width: 860px;
            max-height: 82vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.12);
            color: #ffffff;
        }

        .modal-body {
            padding: 1.2rem 1.4rem 1.5rem;
            color: #f5f5f5; /* slightly softer white for body copy */
        }

        .sector-summary .stat span {
            font-size: 1rem;
            font-weight: 600;
            color: #febc11;
        }

        .sector-holdings-table th,
        .sector-holdings-table td {
            padding: 0.55rem 0.45rem;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            color: #f9fafb; /* light text in sector holdings table */
        }

        .sector-holdings-table th {
            background: rgba(0,0,0,0.4);
            color: #ffffff;
        }

        .sector-holdings-table .symbol {
            color: #febc11;
        }

        .sector-detail-chart-title {
            font-size: 0.9rem;
            text-align: center;
            color: #f5f5f5;
            margin-bottom: 0.4rem;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            /* prevent charts from growing too tall on smaller screens */
            .chart-container {
                height: 220px;
                max-height: 220px;
            }
        }

        @media (max-width: 768px) {
            .page-wrapper {
                padding: 6.5rem 1.2rem 2.5rem;
            }

            .dashboard-hero h1 {
                font-size: 2.3rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls-actions {
                justify-content: flex-start;
            }

            /* slightly smaller charts on mobile */
            .chart-container {
                height: 200px;
                max-height: 200px;
            }
        }

        /* ======== PORTFOLIO HISTORY EXPLORER ======== */
        .history-section {
            margin-top: 3rem;
        }
        .history-toggle-bar {
            display: flex; align-items: center; justify-content: space-between;
            background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
            padding: 1.2rem 1.8rem; cursor: pointer; transition: all 0.3s ease;
        }
        .history-toggle-bar:hover { border-color: rgba(254,188,17,0.4); background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03)); }
        .history-toggle-bar h2 { font-size: 1.3rem; color: white; display: flex; align-items: center; gap: 0.8rem; }
        .history-toggle-bar h2 i { color: #febc11; }
        .history-toggle-bar .toggle-arrow { color: #febc11; font-size: 1.2rem; transition: transform 0.3s ease; }
        .history-toggle-bar .toggle-arrow.open { transform: rotate(180deg); }

        .history-content { display: none; margin-top: 1.5rem; animation: fadeInUp 0.4s ease; }
        .history-content.visible { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .history-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .history-tab {
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7); padding: 0.5rem 1.2rem; border-radius: 8px;
            font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;
        }
        .history-tab:hover { background: rgba(254,188,17,0.1); border-color: rgba(254,188,17,0.3); color: #febc11; }
        .history-tab.active { background: rgba(254,188,17,0.15); border-color: #febc11; color: #febc11; }
        .history-tab-content { display: none; }
        .history-tab-content.active { display: block; }

        .history-filters {
            display: flex; gap: 0.8rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;
        }
        .history-filter {
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15);
            color: white; padding: 0.5rem 0.8rem; border-radius: 6px; font-size: 0.85rem; outline: none;
        }
        .history-filter option { background: #1e3c72; color: white; }

        .history-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        .history-table th {
            text-align: left; padding: 0.6rem 0.7rem; background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.65); font-weight: 600; font-size: 0.72rem;
            text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky; top: 0; z-index: 1; cursor: pointer;
        }
        .history-table th:hover { color: #febc11; }
        .history-table td { padding: 0.5rem 0.7rem; border-bottom: 1px solid rgba(255,255,255,0.04); color: rgba(255,255,255,0.8); }
        .history-table tr:hover td { background: rgba(255,255,255,0.03); }

        .action-badge {
            display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px;
            font-size: 0.72rem; font-weight: 700; text-transform: uppercase;
        }
        .action-buy { background: rgba(40,167,69,0.2); color: #28a745; }
        .action-sell { background: rgba(220,53,69,0.2); color: #dc3545; }
        .action-dividend { background: rgba(254,188,17,0.2); color: #febc11; }
        .action-other { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.5); }

        .history-card-panel {
            background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(16px);
        }
        .history-card-panel h3 { font-size: 1rem; color: #febc11; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; }
        .history-chart-box { position: relative; height: 300px; }
        .history-stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .history-stat { text-align: center; padding: 1rem; background: rgba(255,255,255,0.04); border-radius: 8px; }
        .history-stat .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.5); }
        .history-stat .stat-value { font-size: 1.3rem; font-weight: 800; color: #febc11; margin-top: 0.2rem; }

        @media (max-width: 768px) {
            .history-toggle-bar { padding: 1rem; flex-direction: column; gap: 0.5rem; }
            .history-tabs { gap: 0.3rem; }
            .history-tab { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        }

        /* ============================================
           PERFORMANCE INTELLIGENCE SECTION
           ============================================ */

        /* Scrolling ticker tape */
        .perf-ticker {
            width: 100%;
            overflow: hidden;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(254,188,17,0.15);
            border-radius: 10px;
            padding: 0.6rem 0;
            margin-bottom: 1.5rem;
            position: relative;
        }
        .perf-ticker::before, .perf-ticker::after {
            content: '';
            position: absolute;
            top: 0; bottom: 0;
            width: 60px;
            z-index: 2;
            pointer-events: none;
        }
        .perf-ticker::before { left: 0; background: linear-gradient(to right, rgba(15,20,25,1), transparent); }
        .perf-ticker::after { right: 0; background: linear-gradient(to left, rgba(15,20,25,1), transparent); }
        .perf-ticker-inner {
            display: flex;
            gap: 3rem;
            animation: tickerScroll 30s linear infinite;
            white-space: nowrap;
            width: max-content;
        }
        .perf-ticker-inner:hover { animation-play-state: paused; }
        @keyframes tickerScroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #c9d1d9;
        }
        .ticker-item .ticker-label {
            font-weight: 600;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }
        .ticker-item .ticker-value {
            font-weight: 800;
            font-size: 0.95rem;
        }
        .ticker-item .ticker-value.positive { color: #20c997; }
        .ticker-item .ticker-value.negative { color: #ff6b6b; }
        .ticker-item .ticker-value.neutral { color: #febc11; }
        .ticker-sep { color: rgba(254,188,17,0.3); font-size: 0.6rem; }

        /* Performance scoreboard grid */
        .perf-scoreboard {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        @media (max-width: 992px) {
            .perf-scoreboard { grid-template-columns: 1fr; }
        }

        /* Returns comparison card */
        .perf-returns-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(254,188,17,0.15);
            border-radius: 14px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }
        .perf-returns-card h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 1rem;
        }
        .perf-returns-card h3 i { color: #febc11; margin-right: 0.5rem; }
        .perf-sparkline-container {
            position: relative;
            height: 200px;
            margin-bottom: 1rem;
        }
        .perf-returns-table {
            width: 100%;
            border-collapse: collapse;
        }
        .perf-returns-table th {
            text-align: left;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.4);
            padding: 0.4rem 0.6rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .perf-returns-table td {
            padding: 0.5rem 0.6rem;
            font-size: 0.85rem;
            color: #e5e5e5;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .perf-returns-table tr:first-child td { font-weight: 700; }
        .perf-returns-table .ret-positive { color: #20c997; }
        .perf-returns-table .ret-negative { color: #ff6b6b; }
        .perf-returns-table .ret-label { font-weight: 600; color: #fff; }
        .perf-returns-table .alpha-row td {
            color: #febc11;
            font-weight: 700;
            border-top: 1px solid rgba(254,188,17,0.2);
        }

        /* Risk metrics panel */
        .perf-risk-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(254,188,17,0.15);
            border-radius: 14px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        .perf-risk-card h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 1rem;
        }
        .perf-risk-card h3 i { color: #febc11; margin-right: 0.5rem; }
        .risk-radar-container {
            position: relative;
            height: 200px;
            margin-bottom: 1rem;
            flex: 1;
        }
        .risk-metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem;
        }
        .risk-metric-pill {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.06);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .risk-metric-pill .rmp-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: rgba(255,255,255,0.5);
        }
        .risk-metric-pill .rmp-value {
            font-size: 0.95rem;
            font-weight: 800;
        }
        .risk-metric-pill .rmp-value.good { color: #20c997; }
        .risk-metric-pill .rmp-value.warn { color: #fcc419; }
        .risk-metric-pill .rmp-value.bad { color: #ff6b6b; }

        /* Heatmap */
        .perf-heatmap-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(254,188,17,0.15);
            border-radius: 14px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            margin-bottom: 1.5rem;
        }
        .perf-heatmap-card h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 0.5rem;
        }
        .perf-heatmap-card h3 i { color: #febc11; margin-right: 0.5rem; }
        .heatmap-period-tabs {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 1rem;
        }
        .heatmap-period-tab {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 0.75rem;
            padding: 0.3rem 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .heatmap-period-tab.active, .heatmap-period-tab:hover {
            background: rgba(254,188,17,0.2);
            border-color: rgba(254,188,17,0.4);
            color: #febc11;
        }
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 6px;
        }
        .heatmap-cell {
            position: relative;
            border-radius: 8px;
            padding: 0.6rem 0.4rem;
            text-align: center;
            cursor: default;
            transition: transform 0.15s, box-shadow 0.15s;
            overflow: hidden;
            min-height: 65px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .heatmap-cell:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 2;
        }
        .heatmap-cell .hm-symbol {
            font-weight: 800;
            font-size: 0.85rem;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            line-height: 1.1;
        }
        .heatmap-cell .hm-return {
            font-size: 0.75rem;
            font-weight: 700;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .heatmap-cell .hm-weight {
            font-size: 0.6rem;
            color: rgba(255,255,255,0.6);
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Loading state */
        .perf-loading {
            text-align: center;
            padding: 3rem;
            color: rgba(255,255,255,0.4);
        }
        .perf-loading .spinner {
            width: 36px; height: 36px;
            border: 3px solid rgba(254,188,17,0.2);
            border-top-color: #febc11;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .perf-scoreboard { grid-template-columns: 1fr; }
            .heatmap-grid { grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); }
            .risk-metrics-grid { grid-template-columns: 1fr; }
            .perf-sparkline-container { height: 160px; }
        }

        /* Chart expand button */
        .perf-card-header { display: flex; justify-content: space-between; align-items: center; }
        .chart-expand-btn {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 6px;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            padding: 0.3rem 0.5rem;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        .chart-expand-btn:hover { background: rgba(254,188,17,0.2); color: #febc11; border-color: rgba(254,188,17,0.4); }

        /* Chart modal overlay */
        .chart-modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0,0,0,0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            opacity: 0;
            transition: opacity 0.25s;
        }
        .chart-modal-overlay.visible { opacity: 1; }
        .chart-modal-content {
            background: rgba(20,25,35,0.98);
            border: 1px solid rgba(254,188,17,0.2);
            border-radius: 16px;
            width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            overflow: hidden;
        }
        .chart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .chart-modal-header h3 {
            font-size: 1rem;
            color: #febc11;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
        }
        .chart-modal-close {
            background: none;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 50%;
            color: #c9d1d9;
            width: 32px;
            height: 32px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .chart-modal-close:hover { background: rgba(255,100,100,0.2); color: #ff6b6b; border-color: rgba(255,100,100,0.4); }
        .chart-modal-body {
            flex: 1;
            padding: 1.5rem;
            overflow: auto;
            min-height: 400px;
        }
        .chart-modal-body canvas { width: 100% !important; height: 100% !important; }
        .chart-modal-body .modal-heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }
        .chart-modal-actions {
            display: flex;
            gap: 0.8rem;
            padding: 0.8rem 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.08);
            justify-content: flex-end;
        }
        .chart-download-btn {
            background: rgba(254,188,17,0.15);
            border: 1px solid rgba(254,188,17,0.3);
            border-radius: 8px;
            color: #febc11;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.5rem 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chart-download-btn:hover { background: rgba(254,188,17,0.3); }

        /* Period selector + mode toggle */
        .perf-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }
        .perf-period-selector {
            display: flex;
            gap: 0.35rem;
        }
        .perf-period-btn {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 0.72rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .perf-period-btn.active, .perf-period-btn:hover {
            background: rgba(254,188,17,0.2);
            border-color: rgba(254,188,17,0.4);
            color: #febc11;
        }
        .perf-mode-toggle {
            display: flex;
            gap: 0.3rem;
            background: rgba(255,255,255,0.04);
            border-radius: 8px;
            padding: 3px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .perf-mode-btn {
            background: transparent;
            border: none;
            border-radius: 6px;
            color: rgba(255,255,255,0.5);
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.25rem 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .perf-mode-btn.active {
            background: rgba(254,188,17,0.2);
            color: #febc11;
        }
        .perf-inline-loading {
            position: absolute;
            inset: 0;
            background: rgba(15,20,25,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 14px;
            z-index: 5;
            color: rgba(255,255,255,0.5);
            font-size: 0.85rem;
            gap: 0.6rem;
        }
        .perf-inline-loading .spinner { width: 20px; height: 20px; margin: 0; }

        @media (max-width: 768px) {
            .chart-modal-content { width: 98vw; max-height: 95vh; }
            .chart-modal-body { padding: 1rem; min-height: 300px; }
            .perf-controls-row { flex-direction: column; align-items: flex-start; }
            .perf-period-selector { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <!-- Background -->
    <div class="bg-animation"></div>
    <div class="particles" id="particles"></div>

    <!-- Shared Header/Nav -->
    <header>
        <nav>
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <span>DIG</span>
            </div>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html#home">Home</a></li>
                <li><a href="index.html#board">Advisory Board</a></li>
                <li><a href="live-portfolio.html" class="live-portfolio-link">ðŸ“Š Live Portfolio</a></li>
                <li><a href="stock-history.html">ðŸ“œ Stock History</a></li>
                <li><a href="valuation.html">ðŸ’Ž Valuation</a></li>
                <li><a href="TrackingError/tracking_error_analyzer.html">ðŸ“ˆ Tracking Error</a></li>
            </ul>
            <div class="mobile-menu-toggle" id="mobileMenuToggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>
    </header>

    <div class="page-wrapper">
        <!-- Dashboard Hero -->
        <section class="dashboard-hero">
            <h1>Live Portfolio Dashboard</h1>
            <div class="subtitle">Current View of DIG Holdings & Sector Positioning</div>
            <p>Portfolio dashboard with current market prices from Polygon.io. Click "Refresh" to update prices on demand. Single source of truth for symbol-level exposure and analytics.</p>
            <div class="dashboard-tagline">Tip: Hover over symbols for PDF/CSV/JSON downloads â€¢ Click Refresh or Ctrl+R to update prices â€¢ Ctrl+S to toggle sector view â€¢ Ctrl+E to export CSV</div>
            <div class="cta-row">
                <a href="index.html" class="cta-button cta-secondary"><i class="fas fa-arrow-left"></i> Back to Home Snapshot</a>
            </div>
        </section>

        <div class="section-separator"></div>

        <!-- Controls wrapped in glass card -->
        <section class="controls-shell">
            <div class="controls">
                <div class="controls-actions">
                    <button class="btn" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-success" onclick="generateTearSheet()">
                        <i class="fas fa-file-pdf"></i> Download Tear Sheet
                    </button>
                    <button class="btn btn-warning" onclick="exportCSV()">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                </div>
            </div>
        </section>

        <!-- Summary Cards -->
        <section id="summaryCards" class="summary-cards">
            <!-- Populated by JS -->
        </section>

        <!-- Performance Intelligence -->
        <section id="perfIntelSection" style="margin-top:1.5rem;">
            <!-- Scrolling Ticker Tape -->
            <div class="perf-ticker" id="perfTicker" style="display:none;">
                <div class="perf-ticker-inner" id="perfTickerInner"></div>
            </div>

            <!-- Scoreboard: Returns + Risk -->
            <div class="perf-scoreboard" id="perfScoreboard" style="display:none;">
                <!-- Returns vs Benchmark -->
                <div class="perf-returns-card" style="position:relative;">
                    <div class="perf-card-header">
                        <h3><i class="fas fa-trophy"></i> Portfolio vs S&P 500</h3>
                        <button class="chart-expand-btn" onclick="openChartModal('sparkline')" title="Expand chart"><i class="fas fa-expand-alt"></i></button>
                    </div>
                    <div class="perf-controls-row">
                        <div class="perf-period-selector" id="perfPeriodSelector">
                            <button class="perf-period-btn" data-period="3m">3M</button>
                            <button class="perf-period-btn" data-period="6m">6M</button>
                            <button class="perf-period-btn" data-period="ytd">YTD</button>
                            <button class="perf-period-btn active" data-period="1y">1Y</button>
                            <button class="perf-period-btn" data-period="2y">2Y</button>
                            <button class="perf-period-btn" data-period="all">ALL</button>
                        </div>
                        <div class="perf-mode-toggle" id="perfModeToggle">
                            <button class="perf-mode-btn active" data-mode="current" title="Uses current holdings weights for all periods">Current Weights</button>
                            <button class="perf-mode-btn" data-mode="historical" title="Reconstructs actual holdings from transaction history">True Historical</button>
                        </div>
                    </div>
                    <div class="perf-sparkline-container" style="position:relative;">
                        <canvas id="perfSparklineChart"></canvas>
                        <div class="perf-inline-loading" id="perfInlineLoading" style="display:none;">
                            <div class="spinner"></div>
                            <span id="perfInlineLoadingMsg">Loading...</span>
                        </div>
                    </div>
                    <table class="perf-returns-table" id="perfReturnsTable">
                        <thead>
                            <tr><th></th><th>1M</th><th>3M</th><th>6M</th><th>YTD</th><th>1Y</th></tr>
                        </thead>
                        <tbody id="perfReturnsBody"></tbody>
                    </table>
                </div>

                <!-- Risk Radar -->
                <div class="perf-risk-card" style="position:relative;">
                    <div class="perf-card-header">
                        <h3><i class="fas fa-shield-alt"></i> Risk Profile</h3>
                        <button class="chart-expand-btn" onclick="openChartModal('radar')" title="Expand chart"><i class="fas fa-expand-alt"></i></button>
                    </div>
                    <div class="risk-radar-container">
                        <canvas id="riskRadarChart"></canvas>
                    </div>
                    <div class="risk-metrics-grid" id="riskMetricsGrid"></div>
                </div>
            </div>

            <!-- Holdings Heatmap -->
            <div class="perf-heatmap-card" id="perfHeatmap" style="display:none;">
                <div class="perf-card-header">
                    <h3><i class="fas fa-th"></i> Holdings Performance Heatmap</h3>
                    <button class="chart-expand-btn" onclick="openChartModal('heatmap')" title="Expand heatmap"><i class="fas fa-expand-alt"></i></button>
                </div>
                <div class="heatmap-period-tabs" id="heatmapTabs">
                    <button class="heatmap-period-tab active" data-period="ret1d">1D</button>
                    <button class="heatmap-period-tab" data-period="ret1w">1W</button>
                    <button class="heatmap-period-tab" data-period="ret1m">1M</button>
                    <button class="heatmap-period-tab" data-period="ret3m">3M</button>
                    <button class="heatmap-period-tab" data-period="retYtd">YTD</button>
                </div>
                <div class="heatmap-grid" id="heatmapGrid"></div>
            </div>

            <!-- Chart Modal -->
            <div class="chart-modal-overlay" id="chartModal" style="display:none;" onclick="closeChartModalBackdrop(event)">
                <div class="chart-modal-content">
                    <div class="chart-modal-header">
                        <h3 id="chartModalTitle"></h3>
                        <button onclick="closeChartModal()" class="chart-modal-close">&times;</button>
                    </div>
                    <div class="chart-modal-body" id="chartModalBody">
                        <canvas id="chartModalCanvas"></canvas>
                        <div id="chartModalHeatmap" class="modal-heatmap-grid" style="display:none;"></div>
                    </div>
                    <div class="chart-modal-actions">
                        <button onclick="downloadChartPNG()" class="chart-download-btn"><i class="fas fa-download"></i> Download PNG</button>
                    </div>
                </div>
            </div>

            <!-- Loading state -->
            <div class="perf-loading" id="perfLoading">
                <div class="spinner"></div>
                <div>Loading Performance Intelligence...</div>
                <div style="font-size:0.75rem; margin-top:0.5rem; color:rgba(255,255,255,0.3);">Crunching 1 year of daily returns across all holdings</div>
            </div>
        </section>

        <!-- Main Content -->
        <section class="main-content">
            <div class="card-panel">
                <div class="portfolio-tabs">
                    <button class="tab-btn active" onclick="showPortfolioSection('all', event)">All Holdings</button>
                    <button class="tab-btn" onclick="showPortfolioSection('broad-market', event)">Broad Market ETFs (3)</button>
                    <button class="tab-btn" onclick="showPortfolioSection('equity', event)">DIG Active Positions (19)</button>
                </div>

                <div class="section-header">
                    <h2 class="section-title" id="sectionTitle">All Portfolio Holdings</h2>
                    <div class="section-stats" id="sectionStats"></div>
                </div>

                <div style="overflow-x: visible; overflow-y: auto; max-height: 520px;">
                    <table class="holdings-table" id="holdingsTable">
                        <thead>
                            <tr>
                                <th data-holdkey="symbol" onclick="sortHoldingsTable('symbol')" style="cursor:pointer;">Symbol<span class="h-sort-arrow"> â†•</span></th>
                                <th data-holdkey="description" onclick="sortHoldingsTable('description')" style="cursor:pointer;">Description<span class="h-sort-arrow"> â†•</span></th>
                                <th data-holdkey="sector" onclick="sortHoldingsTable('sector')" style="cursor:pointer;">GICS Sector<span class="h-sort-arrow"> â†•</span></th>
                                <th data-holdkey="quantity" onclick="sortHoldingsTable('quantity')" style="cursor:pointer;">Quantity<span class="h-sort-arrow"> â†•</span></th>
                                <th data-holdkey="price" onclick="sortHoldingsTable('price')" style="cursor:pointer;">Price<span class="h-sort-arrow"> â†•</span></th>
                                <th data-holdkey="mv" onclick="sortHoldingsTable('mv')" style="cursor:pointer;">Market Value<span class="h-sort-arrow"> â†•</span></th>
                                <th data-holdkey="weight" onclick="sortHoldingsTable('weight')" style="cursor:pointer;">% of Portfolio<span class="h-sort-arrow"> â†“</span></th>
                                <th data-holdkey="daychange" onclick="sortHoldingsTable('daychange')" style="cursor:pointer;">Day Change<span class="h-sort-arrow"> â†•</span></th>
                            </tr>
                        </thead>
                        <tbody id="holdingsBody"></tbody>
                    </table>
                </div>
                <div class="last-updated">Last updated: <span id="updateTime">Loading...</span></div>
            </div>

            <div class="card-panel">
                <h3 class="section-title">Portfolio Composition</h3>
                <div style="text-align:right; margin-bottom:0.7rem;">
                    <button class="btn" onclick="toggleSectorView()">
                        <i class="fas fa-layer-group"></i> Toggle Sector View: <span id="sectorViewLabel">Original</span>
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="compositionChart"></canvas>
                </div>
                <div class="chart-info">Click Equity/Specialized ETFs slice for detailed sector allocation.</div>

                <div id="sectorBreakdown" class="sector-breakdown" style="display:none;">
                    <div class="section-header">
                        <span class="section-title" id="sectorBreakdownTitle">Equity/Specialized ETFs - Sector Allocation</span>
                        <button type="button" class="btn" style="padding:0.2rem 0.6rem; border-radius:999px;" onclick="closeSectorBreakdown()">Ã—</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="sectorChart"></canvas>
                    </div>
                    <div id="sectorMetrics"></div>
                </div>

                <h3 class="section-title" style="margin-top:1.3rem;">Top Non-Index Holdings</h3>
                <div class="chart-container">
                    <canvas id="holdingsChart"></canvas>
                </div>
            </div>
        </section>

        <!-- ======== PORTFOLIO HISTORY EXPLORER ======== -->
        <div class="section-separator"></div>
        <section class="history-section">
            <div class="history-toggle-bar" onclick="toggleHistorySection()">
                <h2><i class="fas fa-history"></i> Portfolio History Explorer (2021 - 2026)</h2>
                <span class="toggle-arrow" id="historyArrow"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="history-content" id="historyContent">
                <div class="history-tabs">
                    <button class="history-tab active" onclick="switchHistoryTab('timeline', event)"><i class="fas fa-list"></i> Transaction Timeline</button>
                    <button class="history-tab" onclick="switchHistoryTab('dividends', event)"><i class="fas fa-dollar-sign"></i> Dividend Income</button>
                    <button class="history-tab" onclick="switchHistoryTab('cashbalance', event)"><i class="fas fa-chart-line"></i> Cash Balance</button>
                    <button class="history-tab" onclick="switchHistoryTab('trades', event)"><i class="fas fa-exchange-alt"></i> Trade History</button>
                    <button class="history-tab" onclick="switchHistoryTab('turnover', event)"><i class="fas fa-sync-alt"></i> Turnover</button>
                </div>

                <!-- Tab: Transaction Timeline -->
                <div class="history-tab-content active" id="tab-timeline">
                    <div class="history-filters">
                        <select class="history-filter" id="filterYear" onchange="filterTransactions()">
                            <option value="all">All Years</option>
                            <option value="2021">2021</option><option value="2022">2022</option>
                            <option value="2023">2023</option><option value="2024">2024</option>
                            <option value="2025">2025</option><option value="2026">2026</option>
                        </select>
                        <select class="history-filter" id="filterAction" onchange="filterTransactions()">
                            <option value="all">All Actions</option>
                            <option value="BUY">Buys</option><option value="SELL">Sells</option>
                            <option value="DIVIDEND">Dividends</option><option value="OTHER">Other</option>
                        </select>
                        <input type="text" class="history-filter" id="filterSymbol" placeholder="Search symbol..." oninput="filterTransactions()" style="width:140px;" />
                        <span id="txnCount" style="font-size:0.8rem;opacity:0.5;margin-left:auto;"></span>
                    </div>
                    <div style="overflow-x:auto; max-height: 500px; overflow-y: auto;">
                        <table class="history-table" id="timelineTable">
                            <thead><tr>
                                <th onclick="sortHistory('date')">Date <i class="fas fa-sort"></i></th>
                                <th onclick="sortHistory('action')">Action</th>
                                <th onclick="sortHistory('symbol')">Symbol</th>
                                <th>Description</th>
                                <th onclick="sortHistory('quantity')">Qty</th>
                                <th onclick="sortHistory('price')">Price</th>
                                <th onclick="sortHistory('amount')">Amount</th>
                                <th onclick="sortHistory('balance')">Cash Balance</th>
                            </tr></thead>
                            <tbody id="timelineBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Dividend Income -->
                <div class="history-tab-content" id="tab-dividends">
                    <div class="history-stats-row" id="dividendStats"></div>
                    <div class="history-card-panel" style="margin-bottom:1.5rem;">
                        <h3><i class="fas fa-chart-bar"></i> Annual Dividend Income</h3>
                        <div class="history-chart-box"><canvas id="dividendChart"></canvas></div>
                    </div>
                    <div class="history-card-panel">
                        <h3><i class="fas fa-table"></i> Dividends by Holding</h3>
                        <div style="overflow-x:auto;max-height:400px;overflow-y:auto;">
                            <table class="history-table" id="dividendTable">
                                <thead><tr>
                                    <th data-divkey="symbol" onclick="sortDividendTable('symbol')" style="cursor:pointer;">Symbol<span class="div-sort-arrow"> â†•</span></th>
                                    <th data-divkey="total" onclick="sortDividendTable('total')" style="cursor:pointer;">Total Dividends<span class="div-sort-arrow"> â†“</span></th>
                                    <th data-divkey="count" onclick="sortDividendTable('count')" style="cursor:pointer;">Count<span class="div-sort-arrow"> â†•</span></th>
                                    <th data-divkey="avg" onclick="sortDividendTable('avg')" style="cursor:pointer;">Avg per Payment<span class="div-sort-arrow"> â†•</span></th>
                                </tr></thead>
                                <tbody id="dividendBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab: Cash Balance -->
                <div class="history-tab-content" id="tab-cashbalance">
                    <div class="history-card-panel">
                        <h3><i class="fas fa-chart-area"></i> Cash Balance Over Time</h3>
                        <div class="history-chart-box"><canvas id="cashBalanceChart"></canvas></div>
                    </div>
                </div>

                <!-- Tab: Trade History -->
                <div class="history-tab-content" id="tab-trades">
                    <div class="history-stats-row" id="tradeStats"></div>
                    <div class="history-card-panel">
                        <h3><i class="fas fa-exchange-alt"></i> All Trades by Symbol</h3>
                        <div style="overflow-x:auto;max-height:500px;overflow-y:auto;">
                            <table class="history-table" id="tradeTable">
                                <thead><tr><th>Date</th><th>Action</th><th>Symbol</th><th>Qty</th><th>Price</th><th>Amount</th></tr></thead>
                                <tbody id="tradeBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab: Turnover -->
                <div class="history-tab-content" id="tab-turnover">
                    <div class="history-card-panel" style="margin-bottom:1.5rem;">
                        <h3><i class="fas fa-sync-alt"></i> Annual Trading Activity</h3>
                        <div class="history-chart-box"><canvas id="turnoverChart"></canvas></div>
                    </div>
                    <div class="history-card-panel">
                        <h3><i class="fas fa-table"></i> Annual Summary</h3>
                        <div style="overflow-x:auto;">
                            <table class="history-table" id="turnoverTable">
                                <thead><tr>
                                    <th data-tokey="year" onclick="sortTurnoverTable('year')" style="cursor:pointer;">Year<span class="to-sort-arrow"> â†•</span></th>
                                    <th data-tokey="buys" onclick="sortTurnoverTable('buys')" style="cursor:pointer;">Total Buys ($)<span class="to-sort-arrow"> â†•</span></th>
                                    <th data-tokey="sells" onclick="sortTurnoverTable('sells')" style="cursor:pointer;">Total Sells ($)<span class="to-sort-arrow"> â†•</span></th>
                                    <th data-tokey="net" onclick="sortTurnoverTable('net')" style="cursor:pointer;">Net Trades<span class="to-sort-arrow"> â†•</span></th>
                                    <th data-tokey="divs" onclick="sortTurnoverTable('divs')" style="cursor:pointer;">Dividends<span class="to-sort-arrow"> â†•</span></th>
                                    <th data-tokey="total" onclick="sortTurnoverTable('total')" style="cursor:pointer;">Total Transactions<span class="to-sort-arrow"> â†•</span></th>
                                </tr></thead>
                                <tbody id="turnoverBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Single clean script block with working JS -->
    <script>
    // Aggregated sector mapping for DIG custom view
    const aggregatedSectorMap = {
        'Information Technology': 'Tech/Comm',
        'Communication Services': 'Tech/Comm',
        'Consumer Discretionary': 'Consumer',
        'Consumer Staples': 'Consumer',
        'Utilities': 'Utilities/Real Estate',
        'Real Estate': 'Utilities/Real Estate',
        'Industrials': 'Industrials/Materials',
        'Materials': 'Industrials/Materials',
        'Financials': 'Financials',
        'Health Care': 'Health Care',
        'Energy': 'Utilities/Real Estate'
    };

    let useAggregatedSectors = false;
    let isLiveMode = false;
    let lastUpdateTime = null;
    let compositionChart = null;
    let sectorChart = null;
    let holdingsChart = null;
    let sectorDetailChart = null;
    let currentSectorBreakdown = null;
    let currentSection = 'all';

    // Current holdings as of Feb 17, 2026 (reconstructed from DIG Activity CSVs 2021-2026)
    // Static prices updated Feb 17, 2026 â€” overridden by live API when connected
    const broadMarketETFs = [
        { symbol: 'VOO', description: 'Vanguard S&P 500 ETF', quantity: 590.669, sector: 'Broad Market ETF', gicsSector: 'N/A', lastPrice: 627.99, type: 'etf', change: 0, changePercent: 0 },
        { symbol: 'VTV', description: 'Vanguard Value ETF', quantity: 131.11, sector: 'Broad Market ETF', gicsSector: 'N/A', lastPrice: 205.85, type: 'etf', change: 0, changePercent: 0 },
        { symbol: 'SPY', description: 'SPDR S&P 500 ETF Trust', quantity: 34.281, sector: 'Broad Market ETF', gicsSector: 'N/A', lastPrice: 682.85, type: 'etf', change: 0, changePercent: 0 }
    ];

    const equityHoldings = [
        { symbol: 'TSM', description: 'Taiwan Semiconductor Manufacturing ADR', quantity: 137.398, sector: 'Semiconductor', gicsSector: 'Information Technology', lastPrice: 364.20, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'GOOGL', description: 'Alphabet Inc Class A', quantity: 137.343, sector: 'Interactive Media', gicsSector: 'Communication Services', lastPrice: 302.02, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'MSFT', description: 'Microsoft Corp', quantity: 55.274, sector: 'Software', gicsSector: 'Information Technology', lastPrice: 396.86, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'AMZN', description: 'Amazon.com Inc', quantity: 112.118, sector: 'Internet Retail', gicsSector: 'Consumer Discretionary', lastPrice: 201.15, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'ASML', description: 'ASML Holding NV', quantity: 19.917, sector: 'Semiconductor Equipment', gicsSector: 'Information Technology', lastPrice: 1419.78, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'SNOW', description: 'Snowflake Inc', quantity: 62.096, sector: 'Application Software', gicsSector: 'Information Technology', lastPrice: 177.10, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'NUKZ', description: 'Range Nuclear Renaissance ETF', quantity: 226.815, sector: 'Nuclear Energy ETF', gicsSector: 'Energy', lastPrice: 70.80, type: 'etf', change: 0, changePercent: 0 },
        { symbol: 'VRT', description: 'Vertiv Holdings Co', quantity: 77, sector: 'Electrical Equipment', gicsSector: 'Industrials', lastPrice: 243.53, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'COST', description: 'Costco Wholesale Corp', quantity: 15, sector: 'Consumer Staples Retail', gicsSector: 'Consumer Staples', lastPrice: 1012.05, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'XLV', description: 'Health Care Select Sector SPDR', quantity: 94.93, sector: 'Health Care ETF', gicsSector: 'Health Care', lastPrice: 157.37, type: 'etf', change: 0, changePercent: 0 },
        { symbol: 'CEG', description: 'Constellation Energy Corp', quantity: 33.189, sector: 'Independent Power', gicsSector: 'Utilities', lastPrice: 303.01, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'JPM', description: 'JPMorgan Chase & Co', quantity: 40, sector: 'Diversified Banks', gicsSector: 'Financials', lastPrice: 307.13, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'PANW', description: 'Palo Alto Networks Inc', quantity: 54, sector: 'Network Security', gicsSector: 'Information Technology', lastPrice: 163.50, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'FLUT', description: 'Flutter Entertainment PLC', quantity: 35.91, sector: 'Casinos & Gaming', gicsSector: 'Consumer Discretionary', lastPrice: 123.91, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'SCHW', description: 'Charles Schwab Corp', quantity: 92.199, sector: 'Investment Banking', gicsSector: 'Financials', lastPrice: 93.08, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'REMX', description: 'VanEck Rare Earth/Strategic Metals ETF', quantity: 61.438, sector: 'Rare Earth Metals ETF', gicsSector: 'Materials', lastPrice: 88.99, type: 'etf', change: 0, changePercent: 0 },
        { symbol: 'FCX', description: 'Freeport-McMoRan Inc', quantity: 195.831, sector: 'Copper', gicsSector: 'Materials', lastPrice: 61.09, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'DXCM', description: 'DexCom Inc', quantity: 112.945, sector: 'Health Care Equipment', gicsSector: 'Health Care', lastPrice: 70.43, type: 'stock', change: 0, changePercent: 0 },
        { symbol: 'PSA', description: 'Public Storage', quantity: 20.725, sector: 'Specialized REITs', gicsSector: 'Real Estate', lastPrice: 302.00, type: 'stock', change: 0, changePercent: 0 }
    ];

    const portfolioData = [...broadMarketETFs, ...equityHoldings];

    function toggleSectorView() {
        useAggregatedSectors = !useAggregatedSectors;
        updateSectorViewLabel();
        if (currentSectorBreakdown) updateSectorChart();
    }

    function updateSectorViewLabel() {
        const label = document.getElementById('sectorViewLabel');
        if (label) label.textContent = useAggregatedSectors ? 'DIG' : 'Original';
    }

    function normalizeBaseUrl(raw) {
        if (!raw) return '';
        let url = raw.trim();
        if (!url) return '';
        if (!/^https?:\/\//i.test(url)) {
            url = 'http://' + url;
        }
        try {
            const u = new URL(url);
            if (!u.port) {
                u.port = '3001';
            }
            return u.origin;
        } catch (e) {
            console.warn('Invalid API base URL provided, falling back to relative requests.', e);
            return '';
        }
    }

    function attachTooltipListeners() {
        // Add delayed hide behavior to tooltips - only one open at a time
        let currentlyOpenTooltip = null;
        let hideTimeout;

        const symbols = document.querySelectorAll('.symbol');
        symbols.forEach(symbol => {
            symbol.addEventListener('mouseenter', () => {
                clearTimeout(hideTimeout);

                // Hide any currently open tooltip
                if (currentlyOpenTooltip && currentlyOpenTooltip !== symbol) {
                    const oldTooltip = currentlyOpenTooltip.querySelector('.symbol-tooltip');
                    if (oldTooltip) {
                        oldTooltip.style.display = 'none';
                    }
                }

                // Show this tooltip
                const tooltip = symbol.querySelector('.symbol-tooltip');
                if (tooltip) {
                    tooltip.style.display = 'block';
                    currentlyOpenTooltip = symbol;
                }
            });

            symbol.addEventListener('mouseleave', () => {
                const tooltip = symbol.querySelector('.symbol-tooltip');
                if (tooltip) {
                    hideTimeout = setTimeout(() => {
                        tooltip.style.display = 'none';
                        if (currentlyOpenTooltip === symbol) {
                            currentlyOpenTooltip = null;
                        }
                    }, 500); // Keep visible for 0.5 seconds
                }
            });

            // If mouse re-enters tooltip, keep it visible
            const tooltip = symbol.querySelector('.symbol-tooltip');
            if (tooltip) {
                tooltip.addEventListener('mouseenter', () => {
                    clearTimeout(hideTimeout);
                });

                tooltip.addEventListener('mouseleave', () => {
                    hideTimeout = setTimeout(() => {
                        tooltip.style.display = 'none';
                        if (currentlyOpenTooltip === symbol) {
                            currentlyOpenTooltip = null;
                        }
                    }, 500);
                });
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // particles + nav behavior
        createParticles();
        initMobileMenu();
        initScrollHeader();

        // charts + data
        initializeCharts();
        updateDashboard();
        updateSectorViewLabel();

        // Attach tooltip listeners after initial render
        setTimeout(() => attachTooltipListeners(), 100);

        const apiBaseInput = document.getElementById('apiBaseUrlInput');
        if (apiBaseInput) {
            apiBaseInput.addEventListener('keydown', e => {
                if (e.key === 'Enter') connectAPI();
            });
        }

        // Auto-connect to API on any HTTP/HTTPS host (production + dev)
        setTimeout(() => {
            if (window.location.protocol.startsWith('http')) {
                try {
                    updateStatus('static');
                    testAPIConnection();
                } catch (err) {
                    console.warn('Auto API connection attempt failed:', err.message);
                }
            }
        }, 300);

        // keyboard shortcuts
        document.addEventListener('keydown', e => {
            if (!e.ctrlKey) return;
            const key = e.key.toLowerCase();
            if (key === 'r') {
                e.preventDefault();
                refreshData();
            } else if (key === 's') {
                e.preventDefault();
                toggleSectorView();
            } else if (key === 'p') {
                e.preventDefault();
                generateTearSheet();
            } else if (key === 'e') {
                e.preventDefault();
                exportCSV();
            }
        });
    });

    function createParticles() {
        const container = document.getElementById('particles');
        if (!container) return;
        container.innerHTML = '';
        const colors = ['gold', 'blue', 'white'];
        const count = window.innerWidth < 768 ? 25 : 45;
        for (let i = 0; i < count; i++) {
            const el = document.createElement('div');
            el.className = `particle ${colors[Math.floor(Math.random() * colors.length)]}`;
            const size = Math.random() * 6 + 4;
            el.style.width = size + 'px';
            el.style.height = size + 'px';
            el.style.left = Math.random() * 100 + '%';
            el.style.top = Math.random() * 100 + '%';
            el.style.animationDelay = (Math.random() * 12) + 's';
            el.style.animationDuration = (10 + Math.random() * 10) + 's';
            container.appendChild(el);
        }
        window.addEventListener('resize', () => {
            clearTimeout(window.__particleResizeTimer);
            window.__particleResizeTimer = setTimeout(createParticles, 400);
        }, { once: true });
    }

    function initMobileMenu() {
        const toggle = document.getElementById('mobileMenuToggle');
        const links = document.getElementById('navLinks');
        if (!toggle || !links) return;
        toggle.addEventListener('click', () => {
            toggle.classList.toggle('active');
            links.classList.toggle('active');
        });
        links.querySelectorAll('a').forEach(a => {
            a.addEventListener('click', () => {
                links.classList.remove('active');
                toggle.classList.remove('active');
            });
        });
    }

    function initScrollHeader() {
        const header = document.querySelector('header');
        if (!header) return;
        window.addEventListener('scroll', () => {
            if (window.scrollY > 10) {
                header.style.boxShadow = '0 6px 25px rgba(0,0,0,0.45)';
                header.style.borderBottomColor = 'rgba(254,188,17,0.35)';
            } else {
                header.style.boxShadow = '0 2px 20px rgba(0,0,0,0.2)';
                header.style.borderBottomColor = 'rgba(254,188,17,0.2)';
            }
        });
    }

    function updateStatus(mode) {
        const statusEl = document.getElementById('status');
        const hintEl = document.getElementById('serverHint');
        if (!statusEl) return;
        statusEl.classList.remove('status-live', 'status-static');
        const icon = statusEl.querySelector('i');
        const textSpan = statusEl.querySelector('span');
        if (mode === 'live') {
            statusEl.classList.add('status-live');
            if (icon) icon.className = 'fas fa-bolt';
            if (textSpan) textSpan.textContent = 'Live Data Connected';
            if (hintEl) hintEl.style.display = 'none';
        } else {
            statusEl.classList.add('status-static');
            if (icon) icon.className = 'fas fa-database';
            if (textSpan) textSpan.textContent = 'Portfolio Data Loaded';
            if (hintEl) hintEl.style.display = 'block';
        }
    }

    async function connectAPI() {
        const input = document.getElementById('apiBaseUrlInput');
        const base = input ? normalizeBaseUrl(input.value) : '';
        window.apiBaseURL = base;
        await testAPIConnection();
    }

    async function testAPIConnection() {
        const attempted = [];
        const provided = window.apiBaseURL;
        const candidates = [];
        if (provided) candidates.push(provided);
        // Try same-origin first (works on production Vercel), then dev ports
        if (window.location.origin && window.location.origin !== 'null') {
            candidates.push(window.location.origin);
            candidates.push(window.location.origin.replace(/:\d+$/, ':3002'));
            candidates.push(window.location.origin.replace(/:\d+$/, ':3001'));
        }
        candidates.push('http://127.0.0.1:3002', 'http://127.0.0.1:3001');
        let healthyBase = null;

        for (const base of candidates) {
            if (!base || attempted.includes(base)) continue;
            attempted.push(base);
            try {
                const res = await fetch(base + '/api/health', { cache: 'no-store' });
                if (!res.ok) continue;
                const data = await res.json();
                if (data && data.status === 'OK') {
                    healthyBase = base;
                    break;
                }
            } catch (e) {
                continue;
            }
        }

        if (!healthyBase) {
            isLiveMode = false;
            updateStatus('static');
            console.log('Running in offline mode with sample data. API tried:', attempted.join(', '));
            // Display sample data instead of showing error
            updateDashboard();
            showSuccessMessage('ðŸ“Š Running in Demo Mode with sample data. To use live data, start the server (node server.js) and access via http://localhost:3002/live-portfolio.html');
            return;
        }

        window.apiBaseURL = healthyBase;
        isLiveMode = true;
        updateStatus('live');
        showSuccessMessage('Connected to live API at ' + healthyBase);
        await refreshData();
    }

    async function refreshData() {
        if (!isLiveMode) {
            updateDashboard();
            return;
        }
        const symbols = portfolioData.map(h => h.symbol);
        showProgressIndicator('Refreshing market data for ' + symbols.length + ' holdings...');
        let updatedCount = 0;

        function applyLiveData(h, live) {
            if (!live) return;
            // Server always returns price (from snapshot or agg bars fallback)
            // and change/changePercent computed from close vs prevClose
            const price = live.price || 0;
            if (price > 0) {
                h.lastPrice = price;
                // Use explicit null checks â€” change of 0.00 is valid (flat day)
                h.change = (live.change != null) ? live.change : 0;
                h.changePercent = (live.changePercent != null) ? live.changePercent : 0;
                h._hasLiveData = true; // flag that this stock got real API data
                updatedCount++;
            }
        }

        try {
            let usedBatch = false;
            if (window.apiBaseURL) {
                try {
                    const batchRes = await fetch(window.apiBaseURL + '/api/stocks/batch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbols })
                    });
                    if (batchRes.ok) {
                        const batchResponse = await batchRes.json();
                        const batchData = batchResponse.results || batchResponse;
                        const map = new Map(batchData.map(d => [d.symbol, d]));
                        portfolioData.forEach(h => applyLiveData(h, map.get(h.symbol)));
                        usedBatch = true;
                    }
                } catch (e) {
                    console.warn('Batch request failed, falling back to per-symbol.', e);
                }
            }

            if (!usedBatch && window.apiBaseURL) {
                for (const h of portfolioData) {
                    try {
                        const res = await fetch(window.apiBaseURL + '/api/stock/' + h.symbol);
                        if (!res.ok) continue;
                        const data = await res.json();
                        applyLiveData(h, data);
                    } catch (e) {
                        continue;
                    }
                }
            }

            lastUpdateTime = new Date();
            updateDashboard();
            showSuccessMessage(`Updated ${updatedCount} of ${symbols.length} holdings from live API.`);
        } catch (err) {
            console.error(err);
            showError('Error while refreshing data from API. Falling back to static embedded prices.');
            isLiveMode = false;
            updateStatus('static');
            updateDashboard();
        } finally {
            hideProgressIndicator();
        }
    }

    function showProgressIndicator(message) {
        let overlay = document.getElementById('progressOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'progressOverlay';
            overlay.style.cssText = 'position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.55); z-index:1600;';
            overlay.innerHTML = '<div style="background:rgba(15,20,25,0.96); padding:1.1rem 1.4rem; border-radius:12px; border:1px solid rgba(254,188,17,0.4); color:#fff; font-size:0.9rem; box-shadow:0 18px 45px rgba(0,0,0,0.6);"><span id="progressMessage"></span></div>';
            document.body.appendChild(overlay);
        }
        const msgEl = document.getElementById('progressMessage');
        if (msgEl) msgEl.textContent = message || 'Working...';
        overlay.style.display = 'flex';
    }

    function updateProgressIndicator(message) {
        const msgEl = document.getElementById('progressMessage');
        if (msgEl && message) msgEl.textContent = message;
    }

    function hideProgressIndicator() {
        const overlay = document.getElementById('progressOverlay');
        if (overlay) overlay.style.display = 'none';
    }

    function updateDashboard() {
        updateSummaryCards();
        updateHoldingsTable(currentSection);
        updateCharts();
        updateLastUpdatedTime();
    }

    function updateSummaryCards() {
        let totalValue = 0;
        let totalDayChange = 0;
        let liveStockCount = 0;
        portfolioData.forEach(h => {
            const mv = h.quantity * h.lastPrice;
            totalValue += mv;
            if (h._hasLiveData) {
                totalDayChange += h.quantity * (h.change || 0);
                liveStockCount++;
            }
        });

        // Show day change from live API data, with fallback options
        let dayChangeStr = '';
        let dayChangeClass = '';
        if (liveStockCount > 0) {
            // We have live data â€” compute day change from real-time price changes
            const base = totalValue - totalDayChange || 1;
            const dayChangePercent = (totalDayChange / base) * 100;
            dayChangeStr = `${formatCurrency(totalDayChange)} (${dayChangePercent >= 0 ? '+' : ''}${dayChangePercent.toFixed(2)}%)`;
            dayChangeClass = totalDayChange >= 0 ? 'positive' : 'negative';
        } else if (perfIntelData && perfIntelData.stockPerformance && perfIntelData.stockPerformance.length > 0) {
            // Fallback: estimate from Performance Intelligence historical data
            let weightedReturn = 0;
            perfIntelData.stockPerformance.forEach(s => {
                if (s.ret1d != null) weightedReturn += (s.weight / 100) * s.ret1d;
            });
            const estimatedDayChange = totalValue * (weightedReturn / 100);
            dayChangeStr = `${formatCurrency(estimatedDayChange)} (${weightedReturn >= 0 ? '+' : ''}${weightedReturn.toFixed(2)}%) last trading day`;
            dayChangeClass = weightedReturn >= 0 ? 'positive' : 'negative';
        } else if (!isLiveMode) {
            dayChangeStr = 'Static data â€” connect to server for live prices';
            dayChangeClass = '';
        } else {
            dayChangeStr = 'Loading market data...';
            dayChangeClass = '';
        }

        const sortedBySize = [...portfolioData].sort((a, b) => (b.quantity * b.lastPrice) - (a.quantity * a.lastPrice));

        const summaryData = [
            {
                title: 'Total Portfolio Value',
                value: formatCurrency(totalValue),
                change: dayChangeStr,
                changeClass: dayChangeClass
            },
            {
                title: 'Number of Holdings',
                value: portfolioData.length.toString(),
                change: 'Excluding cash positions',
                changeClass: ''
            },
            {
                title: 'Largest Non-Index Position',
                value: (() => {
                    const indexFunds = ['SPY', 'QQQ', 'IWM', 'DIA', 'VOO', 'VTI', 'IVV'];
                    const nonIndexPositions = sortedBySize.filter(h => !indexFunds.includes(h.symbol));
                    return nonIndexPositions.length > 0 ? nonIndexPositions[0].symbol : 'N/A';
                })(),
                change: (() => {
                    const indexFunds = ['SPY', 'QQQ', 'IWM', 'DIA', 'VOO', 'VTI', 'IVV'];
                    const nonIndexPositions = sortedBySize.filter(h => !indexFunds.includes(h.symbol));
                    if (nonIndexPositions.length === 0) return 'No non-index positions';
                    const largest = nonIndexPositions[0];
                    return `${((largest.quantity * largest.lastPrice) / totalValue * 100).toFixed(1)}% of portfolio`;
                })(),
                changeClass: ''
            }
        ];

        const html = summaryData.map(item => `
            <div class="summary-card">
                <h3>${item.title}</h3>
                <div class="value">${item.value}</div>
                <div class="change ${item.changeClass}">${item.change}</div>
            </div>
        `).join('');
        document.getElementById('summaryCards').innerHTML = html;
    }

    let holdingsSortField = 'weight';
    let holdingsSortAsc = false;
    let lastHoldingsSectionFilter = 'all';

    function sortHoldingsTable(field) {
        if (holdingsSortField === field) {
            holdingsSortAsc = !holdingsSortAsc;
        } else {
            holdingsSortField = field;
            holdingsSortAsc = false;
        }
        // Update header arrows
        document.querySelectorAll('#holdingsTable thead th[data-holdkey]').forEach(th => {
            const arrow = th.querySelector('.h-sort-arrow');
            if (!arrow) return;
            if (th.dataset.holdkey === field) {
                arrow.textContent = holdingsSortAsc ? ' â†‘' : ' â†“';
            } else {
                arrow.textContent = ' â†•';
            }
        });
        updateHoldingsTable(lastHoldingsSectionFilter);
    }

    function updateHoldingsTable(sectionFilter = 'all') {
        lastHoldingsSectionFilter = sectionFilter;
        const tbody = document.getElementById('holdingsBody');
        const titleEl = document.getElementById('sectionTitle');
        const statsEl = document.getElementById('sectionStats');
        if (!tbody) return;

        let data = portfolioData;
        if (sectionFilter === 'broad-market') data = broadMarketETFs;
        else if (sectionFilter === 'equity') data = equityHoldings;

        const totalPortfolioValue = portfolioData.reduce((s, h) => s + (h.quantity * h.lastPrice), 0) || 1;

        // Sort data
        data = data.slice().sort((a, b) => {
            let aVal, bVal;
            switch (holdingsSortField) {
                case 'symbol':      aVal = a.symbol; bVal = b.symbol; return holdingsSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                case 'description': aVal = a.description; bVal = b.description; return holdingsSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                case 'sector':      aVal = a.gicsSector || ''; bVal = b.gicsSector || ''; return holdingsSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                case 'quantity':    aVal = a.quantity; bVal = b.quantity; break;
                case 'price':       aVal = a.lastPrice; bVal = b.lastPrice; break;
                case 'mv':          aVal = a.quantity * a.lastPrice; bVal = b.quantity * b.lastPrice; break;
                case 'weight':      aVal = a.quantity * a.lastPrice; bVal = b.quantity * b.lastPrice; break;
                case 'daychange':   aVal = a.changePercent || 0; bVal = b.changePercent || 0; break;
                default:            aVal = a.quantity * a.lastPrice; bVal = b.quantity * b.lastPrice;
            }
            return holdingsSortAsc ? aVal - bVal : bVal - aVal;
        });
        const rowsHtml = data.map(h => {
            const mv = h.quantity * h.lastPrice;
            const weight = mv / totalPortfolioValue * 100;
            const dayChg = h.change ? h.quantity * h.change : 0;
            const dayPct = h.changePercent || 0;
            return `
                <tr>
                    <td>
                        <span class="symbol">
                            ${h.symbol}
                            <div class="symbol-tooltip">
                                <a href="javascript:void(0)" class="tooltip-option" onclick="event.stopPropagation(); generateIndividualTearSheet('${h.symbol}')">
                                    <i class="fas fa-file-pdf"></i>PDF Tear Sheet
                                </a>
                                <a href="javascript:void(0)" class="tooltip-option" onclick="event.stopPropagation(); downloadTearSheetData('${h.symbol}')">
                                    <i class="fas fa-download"></i>JSON Data
                                </a>
                                <a href="javascript:void(0)" class="tooltip-option" onclick="event.stopPropagation(); downloadSymbolCSV('${h.symbol}')">
                                    <i class="fas fa-file-csv"></i>CSV Data
                                </a>
                            </div>
                        </span>
                    </td>
                    <td>${h.description}</td>
                    <td>${h.gicsSector}</td>
                    <td>${h.quantity.toFixed(3)}</td>
                    <td>${formatCurrency(h.lastPrice)}</td>
                    <td>${formatCurrency(mv)}</td>
                    <td>${weight.toFixed(2)}%</td>
                    <td class="${dayChg >= 0 ? 'change positive' : 'change negative'}">${formatCurrency(dayChg)} (${dayPct >= 0 ? '+' : ''}${dayPct.toFixed(2)}%)</td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = rowsHtml;

        // Add tooltip positioning logic
        attachTooltipListeners();

        if (titleEl && statsEl) {
            if (sectionFilter === 'broad-market') {
                titleEl.textContent = 'Broad Market ETFs';
            } else if (sectionFilter === 'equity') {
                titleEl.textContent = 'DIG Active Positions';
            } else {
                titleEl.textContent = 'All Portfolio Holdings';
            }
            const sectionValue = data.reduce((s, h) => s + (h.quantity * h.lastPrice), 0);
            const sectionWeight = sectionValue / totalPortfolioValue * 100;
            statsEl.textContent = `${data.length} holdings â€¢ ${formatCurrency(sectionValue)} â€¢ ${sectionWeight.toFixed(1)}% of portfolio`;
        }
    }

    function showPortfolioSection(section, ev) {
        currentSection = section;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        if (ev && ev.target) ev.target.classList.add('active');
        updateHoldingsTable(section);
    }

    function initializeCharts() {
        const compositionCtx = document.getElementById('compositionChart').getContext('2d');
        compositionChart = new Chart(compositionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Index Funds', 'Equity/Specialized ETFs', 'Cash'],
                datasets: [{
                    data: [],
                    backgroundColor: ['#febc11', '#4dabf7', '#20c997'],
                    borderWidth: 3,
                    borderColor: '#0f1419'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#e5e5e5',
                            boxWidth: 16,
                            padding: 12,
                            font: { size: 11, weight: 'bold' }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: ${ctx.parsed.toFixed(1)}%`
                        }
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const idx = elements[0].index;
                        const label = compositionChart.data.labels[idx];
                        if (label === 'Equity/Specialized ETFs') showSectorBreakdown();
                    }
                },
                onHover: (event, elements) => {
                    if (!event || !event.native) return;
                    const isEquitySlice = elements.length > 0 && compositionChart.data.labels[elements[0].index] === 'Equity/Specialized ETFs';
                    event.native.target.style.cursor = isEquitySlice ? 'pointer' : 'default';
                }
            }
        });

        const sectorCtx = document.getElementById('sectorChart').getContext('2d');
        const sectorColors = [
            '#ef4444', // red
            '#f97316', // orange
            '#facc15', // amber
            '#22c55e', // green
            '#16a34a', // darker green
            '#0ea5e9', // cyan/blue accent if more sectors
            '#6366f1',
            '#8b5cf6',
            '#ec4899',
            '#f59e0b',
            '#4ade80'
        ];
        sectorChart = new Chart(sectorCtx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: sectorColors,
                    borderWidth: 2,
                    borderColor: '#0f1419'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#f5f5f5',
                            boxWidth: 14,
                            padding: 10,
                            font: { size: 10 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: ${ctx.parsed.toFixed(1)}%`
                        }
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const idx = elements[0].index;
                        const sectorName = sectorChart.data.labels[idx];
                        showSectorDetails(sectorName);
                    }
                },
                onHover: (event, elements) => {
                    if (!event || !event.native) return;
                    event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                }
            }
        });

        const holdingsCtx = document.getElementById('holdingsChart').getContext('2d');
        holdingsChart = new Chart(holdingsCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{ data: [], backgroundColor: '#4dabf7' }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#e5e5e5' } },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: {
                            color: '#e5e5e5',
                            callback: v => v + '%'
                        }
                    }
                }
            }
        });

        updateCharts();
    }

    function updateCharts() {
        updateCompositionChart();
        updateHoldingsChart();
        if (currentSectorBreakdown) updateSectorChart();
    }

    function updateCompositionChart() {
        if (!compositionChart) return;
        const totalValue = portfolioData.reduce((s, h) => s + (h.quantity * h.lastPrice), 0) || 1;
        const indexValue = broadMarketETFs.reduce((s, h) => s + (h.quantity * h.lastPrice), 0);
        const equityValue = equityHoldings.reduce((s, h) => s + (h.quantity * h.lastPrice), 0);
        const cashValue = Math.max(totalValue - indexValue - equityValue, 0);
        const pctIndex = indexValue / totalValue * 100;
        const pctEquity = equityValue / totalValue * 100;
        const pctCash = cashValue / totalValue * 100;
        compositionChart.data.datasets[0].data = [pctIndex, pctEquity, pctCash];
        compositionChart.update();
    }

    function showSectorBreakdown() {
        currentSectorBreakdown = 'equity';
        const el = document.getElementById('sectorBreakdown');
        if (!el) return;
        el.style.display = 'block';
        document.getElementById('sectorBreakdownTitle').textContent = 'Equity/Specialized ETFs - Sector Allocation';
        updateSectorChart();
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function closeSectorBreakdown() {
        currentSectorBreakdown = null;
        const el = document.getElementById('sectorBreakdown');
        if (el) el.style.display = 'none';
    }

    function updateSectorChart() {
        if (!currentSectorBreakdown) return;
        const equityTotalValue = equityHoldings.reduce((s, h) => s + (h.quantity * h.lastPrice), 0);
        const sectorData = {};
        equityHoldings.forEach(h => {
            const mv = h.quantity * h.lastPrice;
            let key;
            if (useAggregatedSectors && h.type === 'etf' && h.symbol === 'NUKZ') {
                key = aggregatedSectorMap[h.gicsSector] || aggregatedSectorMap[h.sector] || h.gicsSector || h.sector;
            } else if (useAggregatedSectors) {
                key = aggregatedSectorMap[h.gicsSector] || h.gicsSector;
            } else {
                key = h.gicsSector;
            }
            sectorData[key] = (sectorData[key] || 0) + mv;
        });

        Object.keys(sectorData).forEach(k => {
            sectorData[k] = (sectorData[k] / equityTotalValue) * 100;
        });

        const sectors = Object.keys(sectorData).sort((a, b) => sectorData[b] - sectorData[a]);
        const percentages = sectors.map(s => sectorData[s]);

        sectorChart.data.labels = sectors;
        sectorChart.data.datasets[0].data = percentages;
        sectorChart.update();

        updateSectorMetrics(sectorData);
    }

    function updateSectorMetrics(sectorData) {
        const container = document.getElementById('sectorMetrics');
        if (!container) return;
        const equityTotalValue = equityHoldings.reduce((s, h) => s + (h.quantity * h.lastPrice), 0);
        let html = '<div class="metrics-grid">';

        Object.keys(sectorData)
            .sort((a, b) => sectorData[b] - sectorData[a])
            .forEach(sector => {
                const holdings = equityHoldings.filter(h => {
                    if (useAggregatedSectors && h.type === 'etf' && h.symbol === 'NUKZ') {
                        const key = aggregatedSectorMap[h.gicsSector] || aggregatedSectorMap[h.sector] || h.gicsSector || h.sector;
                        return key === sector;
                    } else if (useAggregatedSectors) {
                        const key = aggregatedSectorMap[h.gicsSector] || h.gicsSector;
                        return key === sector;
                    }
                    return h.gicsSector === sector;
                });

                const totalValue = holdings.reduce((s, h) => s + (h.quantity * h.lastPrice), 0);
                const avgChange = holdings.length
                    ? holdings.reduce((s, h) => s + (h.changePercent || 0), 0) / holdings.length
                    : 0;
                const weight = (totalValue / equityTotalValue) * 100;

                html += `
                    <div class="metric-card" onclick="showSectorDetails('${sector.replace(/'/g, "\\'")}')">
                        <h4>${sector}</h4>
                        <div class="metric-value">${weight.toFixed(1)}%</div>
                        <div class="metric-detail">Avg daily move: ${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(2)}%</div>
                        <div class="metric-holdings">${holdings.length} holdings</div>
                    </div>
                `;
            });

        html += '</div>';
        container.innerHTML = html;
    }

    function updateHoldingsChart() {
        const totalValue = portfolioData.reduce((s, h) => s + (h.quantity * h.lastPrice), 0);
        const nonIndex = equityHoldings.filter(h => !(h.type === 'etf' && h.gicsSector === 'N/A'));
        const sorted = [...nonIndex].sort((a, b) => (b.quantity * b.lastPrice) - (a.quantity * a.lastPrice)).slice(0, 10);
        const labels = sorted.map(h => h.symbol);
        const values = sorted.map(h => (h.quantity * h.lastPrice) / totalValue * 100);
        holdingsChart.data.labels = labels;
        holdingsChart.data.datasets[0].data = values;
        holdingsChart.update();
    }

    function buildSectorDetailChart(canvasId, sectorName, holdings) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const labels = holdings.map(h => h.symbol);
        const values = holdings.map(h => h.quantity * h.lastPrice);
        const total = values.reduce((s, v) => s + v, 0) || 1;
        const percents = values.map(v => (v / total) * 100);

        if (sectorDetailChart) sectorDetailChart.destroy();

        const detailColors = [
            '#ef4444', '#f97316', '#facc15', '#22c55e',
            '#16a34a', '#0ea5e9', '#6366f1', '#8b5cf6',
            '#ec4899', '#f59e0b', '#4ade80'
        ];

        sectorDetailChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data: percents,
                    backgroundColor: detailColors,
                    borderWidth: 2,
                    borderColor: '#0f1419'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#f5f5f5', font: { size: 10 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: ${ctx.parsed.toFixed(1)}% of sector`
                        }
                    }
                }
            }
        });
    }

    function showSectorDetails(sectorName) {
        // resolve which holdings belong in this sector under current view
        const holdings = equityHoldings.filter(h => {
            if (useAggregatedSectors && h.type === 'etf' && h.symbol === 'NUKZ') {
                const key = aggregatedSectorMap[h.gicsSector] || aggregatedSectorMap[h.sector] || h.gicsSector || h.sector;
                return key === sectorName;
            } else if (useAggregatedSectors) {
                const key = aggregatedSectorMap[h.gicsSector] || h.gicsSector;
                return key === sectorName;
            }
            return h.gicsSector === sectorName;
        });
        if (!holdings.length) return;

        const totalSectorValue = holdings.reduce((s, h) => s + (h.quantity * h.lastPrice), 0);
        const avgChange = holdings.length
            ? holdings.reduce((s, h) => s + (h.changePercent || 0), 0) / holdings.length
            : 0;

        const backdrop = document.createElement('div');
        backdrop.className = 'sector-details-modal';
        backdrop.innerHTML = `
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; padding:0.9rem 1.2rem; border-bottom:1px solid rgba(255,255,255,0.12);">
                    <h2 style="font-size:1.1rem;">${sectorName} â€“ Sector Detail</h2>
                    <button type="button" class="btn" style="padding:0.2rem 0.6rem; border-radius:999px;" onclick="this.closest('.sector-details-modal').remove()">Ã—</button>
                </div>
                <div class="modal-body">
                    <div class="sector-summary" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:0.8rem; margin-bottom:1rem;">
                        <div class="stat" style="background:rgba(255,255,255,0.06); border-radius:10px; padding:0.8rem;">
                            <div style="font-size:0.8rem; opacity:0.8;">Sector Market Value</div>
                            <span>${formatCurrency(totalSectorValue)}</span>
                        </div>
                        <div class="stat" style="background:rgba(255,255,255,0.06); border-radius:10px; padding:0.8rem;">
                            <div style="font-size:0.8rem; opacity:0.8;">Average Daily Move</div>
                            <span>${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(2)}%</span>
                        </div>
                        <div class="stat" style="background:rgba(255,255,255,0.06); border-radius:10px; padding:0.8rem;">
                            <div style="font-size:0.8rem; opacity:0.8;">Holdings in Sector</div>
                            <span>${holdings.length}</span>
                        </div>
                    </div>

                    <div style="margin-bottom:1.1rem;">
                        <div class="sector-detail-chart-title">Holdings Distribution within ${sectorName}</div>
                        <div class="chart-container" style="height:220px; max-height:220px;">
                            <canvas id="sectorDetailChartCanvas"></canvas>
                        </div>
                    </div>

                    <table class="sector-holdings-table" style="width:100%; border-collapse:collapse; font-size:0.8rem;">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Market Value</th>
                                <th>Day Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${holdings.map(h => {
                                const mv = h.quantity * h.lastPrice;
                                const dayChg = h.change ? h.quantity * h.change : 0;
                                const dayPct = h.changePercent || 0;
                                return `
                                    <tr>
                                        <td>
                                            <span class="symbol">
                                                ${h.symbol}
                                                <div class="symbol-tooltip">
                                                    <a href="javascript:void(0)" class="tooltip-option" onclick="event.stopPropagation(); generateIndividualTearSheet('${h.symbol}')">
                                                        <i class="fas fa-file-pdf"></i>PDF Tear Sheet
                                                    </a>
                                                    <a href="javascript:void(0)" class="tooltip-option" onclick="event.stopPropagation(); downloadTearSheetData('${h.symbol}')">
                                                        <i class="fas fa-download"></i>JSON Data
                                                    </a>
                                                    <a href="javascript:void(0)" class="tooltip-option" onclick="event.stopPropagation(); downloadSymbolCSV('${h.symbol}')">
                                                        <i class="fas fa-file-csv"></i>CSV Data
                                                    </a>
                                                </div>
                                            </span>
                                        </td>
                                        <td>${h.description}</td>
                                        <td>${h.quantity.toFixed(3)}</td>
                                        <td>${formatCurrency(h.lastPrice)}</td>
                                        <td>${formatCurrency(mv)}</td>
                                        <td class="${dayChg >= 0 ? 'change positive' : 'change negative'}">${formatCurrency(dayChg)} (${dayPct >= 0 ? '+' : ''}${dayPct.toFixed(2)}%)</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        backdrop.addEventListener('click', () => backdrop.remove());
        document.body.appendChild(backdrop);

        // build inner doughnut
        setTimeout(() => {
            buildSectorDetailChart('sectorDetailChartCanvas', sectorName, holdings);
            attachTooltipListeners(); // Attach tooltip positioning for sector modal
        }, 0);
    }

    function updateLastUpdatedTime() {
        const el = document.getElementById('updateTime');
        if (!el) return;
        if (!lastUpdateTime) {
            var now = new Date();
            el.textContent = 'Portfolio as of ' + now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        } else {
            el.textContent = lastUpdateTime.toLocaleString();
        }
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(value || 0);
    }

    function showError(message) {
        console.error(message);
        let container = document.getElementById('errorContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'errorContainer';
            container.style.marginTop = '1rem';
            const controlsShell = document.querySelector('.controls-shell');
            if (controlsShell) controlsShell.appendChild(container);
        }
        container.innerHTML = `<div class="error-message">${message}</div>`;
    }

    function showSuccessMessage(message) {
        console.log(message);
        let toast = document.getElementById('successToast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'successToast';
            toast.style.cssText = 'position:fixed; bottom:20px; right:20px; background:rgba(40,167,69,0.95); color:white; padding:0.75rem 1rem; border-radius:999px; box-shadow:0 10px 30px rgba(0,0,0,0.4); z-index:2500; font-size:0.85rem;';
            document.body.appendChild(toast);
        }
        toast.textContent = message;
        toast.style.opacity = '1';
        setTimeout(() => { toast.style.opacity = '0'; }, 3500);
    }

    function exportCSV() {
        const headers = ['Symbol','Description','GICS Sector','Quantity','Price','Market Value'];
        const rows = portfolioData.map(h => {
            const mv = h.quantity * h.lastPrice;
            return [h.symbol, h.description, h.gicsSector, h.quantity.toFixed(3), h.lastPrice.toFixed(2), mv.toFixed(2)];
        });
        const csvContent = [headers, ...rows].map(r => r.join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dig-portfolio.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showSuccessMessage('CSV export generated.');
    }

    async function generateTearSheet() {
        try {
            showProgressIndicator('Generating portfolio tear sheet...');
            await TearSheetGenerator.generate(portfolioData, { isLiveMode });
            hideProgressIndicator();
            showSuccessMessage('Portfolio tear sheet downloaded.');
        } catch (err) {
            console.error(err);
            hideProgressIndicator();
            showError('Failed to generate portfolio tear sheet.');
        }
    }

    async function generateIndividualTearSheet(symbol) {
        const holding = portfolioData.find(h => h.symbol === symbol);
        if (!holding) {
            showError(`No holding data found for ${symbol}.`);
            return;
        }
        
        let enhanced = { ...holding };
        try {
            // Check if tear sheet generator is available
            if (!window.IndividualTearSheetGenerator) {
                throw new Error('IndividualTearSheetGenerator not loaded. Please refresh the page.');
            }
            
            // Check if jsPDF is available
            if (!window.jspdf || !window.jspdf.jsPDF) {
                throw new Error('jsPDF library not loaded. Please refresh the page.');
            }
            
            showProgressIndicator(`Generating tear sheet for ${symbol}...`);
            
            if (isLiveMode) {
                updateProgressIndicator(`Fetching latest data for ${symbol}...`);
                const url = window.apiBaseURL ? `${window.apiBaseURL}/api/stock/${symbol}` : `/api/stock/${symbol}`;
                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    enhanced = { ...enhanced, ...data };
                }
            }
            
            updateProgressIndicator(`Creating PDF for ${symbol}...`);
            await IndividualTearSheetGenerator.generate(enhanced);
            hideProgressIndicator();
            showSuccessMessage(`Tear sheet generated for ${symbol}.`);
        } catch (err) {
            console.error('Tear sheet generation error:', err);
            hideProgressIndicator();
            showError(`Failed to generate tear sheet for ${symbol}: ${err.message}`);
        }
    }

    async function downloadTearSheetData(symbol) {
        const holding = portfolioData.find(h => h.symbol === symbol);
        if (!holding) {
            showError(`No holding data found for ${symbol}.`);
            return;
        }

        try {
            showProgressIndicator(`Fetching tear sheet data for ${symbol}...`);

            const apiBaseUrl = window.apiBaseURL || window.location.origin;

            // Fetch all the data that goes into the tear sheet
            const [comprehensive, historical, analytics, financials, news, valuationHistory, valueCreation] = await Promise.all([
                fetch(`${apiBaseUrl}/api/stock/${symbol}/comprehensive`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/historical?days=365`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/analytics`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/financials?limit=8`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/news?limit=10`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/valuation-history?quarters=12`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/value-creation?quarters=12`).then(r => r.json())
            ]);

            const tearSheetData = {
                holding: holding,
                comprehensive: comprehensive,
                historical: historical,
                analytics: analytics,
                financials: financials,
                news: news,
                valuationHistory: valuationHistory,
                valueCreation: valueCreation,
                timestamp: new Date().toISOString()
            };

            // Download as JSON
            const blob = new Blob([JSON.stringify(tearSheetData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${symbol}_TearSheet_Data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            hideProgressIndicator();
            showSuccessMessage(`Tear sheet data for ${symbol} downloaded as JSON`);
        } catch (err) {
            console.error(err);
            hideProgressIndicator();
            showError(`Failed to download tear sheet data for ${symbol}: ${err.message}`);
        }
    }

    async function downloadSymbolCSV(symbol) {
        const holding = portfolioData.find(h => h.symbol === symbol);
        if (!holding) {
            showError(`No holding data found for ${symbol}.`);
            return;
        }

        try {
            showProgressIndicator(`Generating CSV for ${symbol}...`);

            const apiBaseUrl = window.apiBaseURL || window.location.origin;

            // Fetch all the data that goes into the tear sheet
            const [comprehensive, historical, analytics, financials, news, valuationHistory, valueCreation] = await Promise.all([
                fetch(`${apiBaseUrl}/api/stock/${symbol}/comprehensive`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/historical?days=365`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/analytics`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/financials?limit=8`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/news?limit=10`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/valuation-history?quarters=12`).then(r => r.json()),
                fetch(`${apiBaseUrl}/api/stock/${symbol}/value-creation?quarters=12`).then(r => r.json())
            ]);

            // Build CSV structure
            const csvLines = [];

            // Header section
            csvLines.push(`Symbol,${symbol}`);
            csvLines.push(`Description,${holding.description || 'N/A'}`);
            csvLines.push(`Sector,${holding.gicsSector || 'N/A'}`);
            csvLines.push(`Quantity,${holding.quantity}`);
            csvLines.push(`Last Price,${holding.lastPrice}`);
            csvLines.push(`Market Value,${holding.quantity * holding.lastPrice}`);
            csvLines.push(`Generated,${new Date().toISOString()}`);
            csvLines.push('');

            // Quote data
            if (comprehensive.quote) {
                csvLines.push('QUOTE DATA');
                csvLines.push('Field,Value');
                csvLines.push(`Price,${comprehensive.quote.price || 'N/A'}`);
                csvLines.push(`Change,${comprehensive.quote.change || 'N/A'}`);
                csvLines.push(`Change %,${comprehensive.quote.changePercent || 'N/A'}`);
                csvLines.push(`Volume,${comprehensive.quote.volume || 'N/A'}`);
                csvLines.push(`Market Cap,${comprehensive.details?.marketCap || 'N/A'}`);
                csvLines.push('');
            }

            // Analytics
            if (analytics.analytics) {
                csvLines.push('ANALYTICS');
                csvLines.push('Metric,Value');
                csvLines.push(`Beta,${analytics.analytics.beta || 'N/A'}`);
                csvLines.push(`Volatility,${analytics.analytics.volatility || 'N/A'}`);
                csvLines.push(`52W High,${analytics.analytics.high52Week || 'N/A'}`);
                csvLines.push(`52W Low,${analytics.analytics.low52Week || 'N/A'}`);
                csvLines.push(`Avg Volume (20d),${analytics.analytics.avgVolume20 || 'N/A'}`);
                csvLines.push('');
            }

            // Financials
            if (financials.length > 0) {
                csvLines.push('FINANCIALS (Quarterly)');
                csvLines.push('Date,Period,Revenues,Net Income,EPS,Assets,Liabilities,Equity');
                financials.forEach(f => {
                    csvLines.push(`${f.filingDate || 'N/A'},${f.fiscalPeriod || 'N/A'},${f.revenues || 0},${f.netIncome || 0},${f.eps || 0},${f.assets || 0},${f.liabilities || 0},${f.equity || 0}`);
                });
                csvLines.push('');
            }

            // Value Creation Metrics
            if (valueCreation && valueCreation.length > 0) {
                csvLines.push('VALUE CREATION METRICS');
                csvLines.push('Date,Period,ROE,Profit Margin,Asset Turnover,Equity Multiplier,Gross Margin,Operating Margin,ROIC,Debt/Equity');
                valueCreation.forEach(v => {
                    csvLines.push(`${v.date || 'N/A'},${v.fiscalPeriod || 'N/A'},${v.roe || 'N/A'},${v.profitMargin || 'N/A'},${v.assetTurnover || 'N/A'},${v.equityMultiplier || 'N/A'},${v.grossMargin || 'N/A'},${v.operatingMargin || 'N/A'},${v.roic || 'N/A'},${v.debtToEquity || 'N/A'}`);
                });
                csvLines.push('');
            }

            // Valuation History
            if (valuationHistory.stockValuations && valuationHistory.stockValuations.length > 0) {
                csvLines.push('VALUATION HISTORY');
                csvLines.push('Date,Period,P/E Ratio,P/B Ratio,EPS');
                valuationHistory.stockValuations.forEach(v => {
                    csvLines.push(`${v.date || 'N/A'},${v.fiscalPeriod || 'N/A'},${v.peRatio || 'N/A'},${v.pbRatio || 'N/A'},${v.eps || 'N/A'}`);
                });
                csvLines.push('');
            }

            // Historical prices (last 30 days only to keep file size reasonable)
            if (historical.prices && historical.prices.length > 0) {
                csvLines.push('HISTORICAL PRICES (Last 30 Days)');
                csvLines.push('Date,Open,High,Low,Close,Volume');
                historical.prices.slice(-30).forEach(p => {
                    csvLines.push(`${p.date || 'N/A'},${p.open || 'N/A'},${p.high || 'N/A'},${p.low || 'N/A'},${p.close || 'N/A'},${p.volume || 'N/A'}`);
                });
                csvLines.push('');
            }

            // News headlines
            if (news.length > 0) {
                csvLines.push('NEWS HEADLINES');
                csvLines.push('Date,Headline,Publisher');
                news.forEach(n => {
                    const headline = (n.headline || '').replace(/,/g, ';'); // Replace commas to avoid CSV issues
                    csvLines.push(`${n.published || 'N/A'},${headline},${n.publisher || 'N/A'}`);
                });
            }

            // Create and download CSV
            const csvContent = csvLines.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${symbol}_TearSheet_Data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            hideProgressIndicator();
            showSuccessMessage(`CSV data for ${symbol} downloaded successfully`);
        } catch (err) {
            console.error(err);
            hideProgressIndicator();
            showError(`Failed to download CSV for ${symbol}: ${err.message}`);
        }
    }

    // ================================================================
    // PORTFOLIO HISTORY EXPLORER
    // ================================================================
    let activityData = [];
    let activityLoaded = false;
    let historySortField = 'date';
    let historySortAsc = false;
    let historyCharts = {};

    function toggleHistorySection() {
        const content = document.getElementById('historyContent');
        const arrow = document.getElementById('historyArrow');
        const isOpen = content.classList.contains('visible');
        if (isOpen) {
            content.classList.remove('visible');
            arrow.classList.remove('open');
        } else {
            content.classList.add('visible');
            arrow.classList.add('open');
            if (!activityLoaded) loadActivityData();
        }
    }

    async function loadActivityData() {
        const years = [2021, 2022, 2023, 2024, 2025, 2026];
        try {
            const csvTexts = await Promise.all(
                years.map(y => fetch(`data/DIG_${y}_Activity.csv`).then(r => {
                    if (!r.ok) throw new Error(`Failed to load ${y}`);
                    return r.text();
                }))
            );
            activityData = [];
            csvTexts.forEach(text => {
                const lines = text.split('\n').filter(l => l.trim());
                for (let i = 1; i < lines.length; i++) {
                    const parsed = parseActivityLine(lines[i]);
                    if (parsed) activityData.push(parsed);
                }
            });
            // Sort by date descending
            activityData.sort((a, b) => b.date - a.date);
            activityLoaded = true;
            renderTimeline();
            renderDividends();
            renderCashBalance();
            renderTrades();
            renderTurnover();
        } catch (err) {
            console.error('Error loading activity data:', err);
            document.getElementById('timelineBody').innerHTML = `<tr><td colspan="8" style="text-align:center;color:#dc3545;padding:2rem;">Failed to load activity data. Ensure CSV files are in the data/ directory.</td></tr>`;
        }
    }

    function parseActivityLine(line) {
        // Split by comma - handle the Fidelity CSV format
        const parts = line.split(',');
        if (parts.length < 12) return null;
        const dateStr = parts[0]?.trim();
        if (!dateStr) return null;
        // Parse date: "2/13/26" or "12/31/21"
        const dp = dateStr.split('/');
        if (dp.length !== 3) return null;
        let yr = parseInt(dp[2]);
        if (yr < 100) yr += 2000;
        const date = new Date(yr, parseInt(dp[0]) - 1, parseInt(dp[1]));
        if (isNaN(date.getTime())) return null;

        const actionText = parts[1]?.trim() || '';
        const symbol = parts[2]?.trim() || '';
        const description = parts[3]?.trim() || '';
        const type = parts[4]?.trim() || '';
        const price = parseFloat(parts[5]) || null;
        const quantity = parseFloat(parts[6]) || 0;
        const commission = parseFloat(parts[7]) || 0;
        const fees = parseFloat(parts[8]) || 0;
        const amount = parseFloat(parts[10]) || 0;
        const cashBalance = parseFloat(parts[11]) || null;

        const actionType = categorizeAction(actionText);

        return { date, dateStr, action: actionText, actionType, symbol, description, type, price, quantity, commission, fees, amount, cashBalance, year: date.getFullYear() };
    }

    function categorizeAction(text) {
        if (!text) return 'OTHER';
        const u = text.toUpperCase();
        if (u.startsWith('YOU BOUGHT')) return 'BUY';
        if (u.startsWith('YOU SOLD')) return 'SELL';
        if (u.includes('DIVIDEND RECEIVED')) return 'DIVIDEND';
        if (u.includes('REINVESTMENT')) return 'REINVESTMENT';
        if (u.includes('LONG-TERM CAP GAIN')) return 'CAP_GAIN';
        if (u.includes('SHORT-TERM CAP GAIN')) return 'CAP_GAIN';
        if (u.includes('WIRE TRANSFER')) return 'WIRE_TRANSFER';
        if (u.includes('FOREIGN TAX')) return 'TAX';
        if (u.includes('JOURNALED')) return 'JOURNAL';
        return 'OTHER';
    }

    function getActionBadge(type) {
        switch (type) {
            case 'BUY': return '<span class="action-badge action-buy">Buy</span>';
            case 'SELL': return '<span class="action-badge action-sell">Sell</span>';
            case 'DIVIDEND': return '<span class="action-badge action-dividend">Dividend</span>';
            case 'CAP_GAIN': return '<span class="action-badge action-dividend">Cap Gain</span>';
            default: return `<span class="action-badge action-other">${type.replace('_', ' ')}</span>`;
        }
    }

    function fmtHistCur(n) {
        if (n == null || isNaN(n)) return '-';
        const neg = n < 0;
        const formatted = '$' + Math.abs(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        return neg ? `<span style="color:#dc3545;">(${formatted})</span>` : formatted;
    }

    function fmtHistDate(d) {
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function switchHistoryTab(tab, event) {
        document.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.history-tab-content').forEach(c => c.classList.remove('active'));
        if (event) event.target.closest('.history-tab').classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
    }

    // --- TIMELINE ---
    function renderTimeline() {
        filterTransactions();
    }

    function filterTransactions() {
        const yearFilter = document.getElementById('filterYear').value;
        const actionFilter = document.getElementById('filterAction').value;
        const symbolFilter = (document.getElementById('filterSymbol').value || '').toUpperCase();

        let filtered = activityData;
        if (yearFilter !== 'all') filtered = filtered.filter(t => t.year === parseInt(yearFilter));
        if (actionFilter !== 'all') {
            if (actionFilter === 'OTHER') filtered = filtered.filter(t => !['BUY', 'SELL', 'DIVIDEND'].includes(t.actionType));
            else filtered = filtered.filter(t => t.actionType === actionFilter);
        }
        if (symbolFilter) filtered = filtered.filter(t => t.symbol.includes(symbolFilter));

        // Sort
        filtered.sort((a, b) => {
            let va, vb;
            switch (historySortField) {
                case 'date': va = a.date; vb = b.date; break;
                case 'symbol': va = a.symbol; vb = b.symbol; break;
                case 'quantity': va = Math.abs(a.quantity); vb = Math.abs(b.quantity); break;
                case 'price': va = a.price || 0; vb = b.price || 0; break;
                case 'amount': va = a.amount; vb = b.amount; break;
                case 'balance': va = a.cashBalance || 0; vb = b.cashBalance || 0; break;
                default: va = a.date; vb = b.date;
            }
            if (va < vb) return historySortAsc ? -1 : 1;
            if (va > vb) return historySortAsc ? 1 : -1;
            return 0;
        });

        document.getElementById('txnCount').textContent = `${filtered.length} transactions`;
        const tbody = document.getElementById('timelineBody');
        tbody.innerHTML = filtered.slice(0, 200).map(t => `<tr>
            <td style="white-space:nowrap;">${fmtHistDate(t.date)}</td>
            <td>${getActionBadge(t.actionType)}</td>
            <td style="color:#febc11;font-weight:600;">${t.symbol || '-'}</td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${t.description}">${t.description || '-'}</td>
            <td>${t.quantity ? t.quantity.toFixed(3) : '-'}</td>
            <td>${t.price ? '$' + t.price.toFixed(2) : '-'}</td>
            <td>${fmtHistCur(t.amount)}</td>
            <td>${t.cashBalance != null ? '$' + t.cashBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
        </tr>`).join('');

        if (filtered.length > 200) {
            tbody.innerHTML += `<tr><td colspan="8" style="text-align:center;opacity:0.5;padding:1rem;">Showing first 200 of ${filtered.length} transactions. Use filters to narrow results.</td></tr>`;
        }
    }

    function sortHistory(field) {
        if (historySortField === field) historySortAsc = !historySortAsc;
        else { historySortField = field; historySortAsc = field === 'symbol'; }
        filterTransactions();
    }

    // --- DIVIDENDS ---
    function renderDividends() {
        const divs = activityData.filter(t => t.actionType === 'DIVIDEND' && t.amount > 0);
        const totalDivs = divs.reduce((s, t) => s + t.amount, 0);

        // By year
        const byYear = {};
        divs.forEach(t => { byYear[t.year] = (byYear[t.year] || 0) + t.amount; });
        const years = Object.keys(byYear).sort();

        // By symbol
        const bySymbol = {};
        divs.forEach(t => {
            if (!t.symbol) return;
            if (!bySymbol[t.symbol]) bySymbol[t.symbol] = { total: 0, count: 0 };
            bySymbol[t.symbol].total += t.amount;
            bySymbol[t.symbol].count++;
        });
        const symbolList = Object.entries(bySymbol).sort((a, b) => b[1].total - a[1].total);

        // Stats
        document.getElementById('dividendStats').innerHTML = `
            <div class="history-stat"><div class="stat-label">Total Dividends</div><div class="stat-value">$${totalDivs.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div></div>
            <div class="history-stat"><div class="stat-label">Payments</div><div class="stat-value">${divs.length}</div></div>
            <div class="history-stat"><div class="stat-label">Unique Holdings</div><div class="stat-value">${symbolList.length}</div></div>
            <div class="history-stat"><div class="stat-label">Avg/Year</div><div class="stat-value">$${years.length > 0 ? (totalDivs / years.length).toFixed(2) : '0'}</div></div>`;

        // Table
        _lastDivList = symbolList;
        _renderDividendBody(symbolList);

        // Chart
        if (historyCharts.dividend) historyCharts.dividend.destroy();
        const ctx = document.getElementById('dividendChart');
        if (ctx) {
            historyCharts.dividend = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{ label: 'Dividend Income ($)', data: years.map(y => byYear[y]), backgroundColor: 'rgba(254,188,17,0.4)', borderColor: '#febc11', borderWidth: 1 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#e5e5e5' } } },
                    scales: { x: { ticks: { color: '#aaa' }, grid: { display: false } }, y: { ticks: { color: '#aaa', callback: v => '$' + v.toLocaleString() }, grid: { color: 'rgba(255,255,255,0.05)' } } }
                }
            });
        }
    }

    // --- CASH BALANCE ---
    function renderCashBalance() {
        // Get all entries with cash balance, sorted chronologically
        const withBalance = activityData.filter(t => t.cashBalance != null).sort((a, b) => a.date - b.date);
        if (withBalance.length === 0) return;

        if (historyCharts.cashBalance) historyCharts.cashBalance.destroy();
        const ctx = document.getElementById('cashBalanceChart');
        if (ctx) {
            historyCharts.cashBalance = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: withBalance.map(t => fmtHistDate(t.date)),
                    datasets: [{
                        label: 'Cash Balance ($)',
                        data: withBalance.map(t => t.cashBalance),
                        borderColor: '#febc11', backgroundColor: 'rgba(254,188,17,0.08)',
                        fill: true, tension: 0.2, pointRadius: 1, pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#e5e5e5' } } },
                    scales: {
                        x: { ticks: { color: '#aaa', maxTicksLimit: 20, maxRotation: 45 }, grid: { display: false } },
                        y: { ticks: { color: '#aaa', callback: v => '$' + v.toLocaleString() }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }
    }

    // --- TRADES ---
    function renderTrades() {
        const trades = activityData.filter(t => t.actionType === 'BUY' || t.actionType === 'SELL');
        const totalBuys = trades.filter(t => t.actionType === 'BUY').reduce((s, t) => s + Math.abs(t.amount), 0);
        const totalSells = trades.filter(t => t.actionType === 'SELL').reduce((s, t) => s + Math.abs(t.amount), 0);

        document.getElementById('tradeStats').innerHTML = `
            <div class="history-stat"><div class="stat-label">Total Trades</div><div class="stat-value">${trades.length}</div></div>
            <div class="history-stat"><div class="stat-label">Total Buys</div><div class="stat-value" style="color:#28a745;">$${totalBuys.toLocaleString('en-US', {maximumFractionDigits: 0})}</div></div>
            <div class="history-stat"><div class="stat-label">Total Sells</div><div class="stat-value" style="color:#dc3545;">$${totalSells.toLocaleString('en-US', {maximumFractionDigits: 0})}</div></div>
            <div class="history-stat"><div class="stat-label">Net Flow</div><div class="stat-value" style="color:${totalSells - totalBuys >= 0 ? '#28a745' : '#dc3545'};">$${(totalSells - totalBuys).toLocaleString('en-US', {maximumFractionDigits: 0})}</div></div>`;

        document.getElementById('tradeBody').innerHTML = trades.map(t => `<tr>
            <td style="white-space:nowrap;">${fmtHistDate(t.date)}</td>
            <td>${getActionBadge(t.actionType)}</td>
            <td style="color:#febc11;font-weight:600;">${t.symbol}</td>
            <td>${t.quantity ? t.quantity.toFixed(3) : '-'}</td>
            <td>${t.price ? '$' + t.price.toFixed(2) : '-'}</td>
            <td>${fmtHistCur(t.amount)}</td>
        </tr>`).join('');
    }

    // --- TURNOVER ---
    // ---- Dividend table sort ----
    let _divSortField = 'total', _divSortAsc = false;
    let _lastDivList = [];

    function _renderDividendBody(list) {
        document.getElementById('dividendBody').innerHTML = list.map(([sym, data]) =>
            `<tr><td style="color:#febc11;font-weight:600;">${sym}</td><td>$${data.total.toFixed(2)}</td><td>${data.count}</td><td>$${(data.total / data.count).toFixed(2)}</td></tr>`
        ).join('');
    }

    function sortDividendTable(field) {
        if (_divSortField === field) { _divSortAsc = !_divSortAsc; } else { _divSortField = field; _divSortAsc = false; }
        document.querySelectorAll('#dividendTable thead th[data-divkey]').forEach(th => {
            const arrow = th.querySelector('.div-sort-arrow');
            if (!arrow) return;
            arrow.textContent = th.dataset.divkey === field ? (_divSortAsc ? ' â†‘' : ' â†“') : ' â†•';
        });
        const sorted = _lastDivList.slice().sort((a, b) => {
            let aVal, bVal;
            if (field === 'symbol') { return _divSortAsc ? a[0].localeCompare(b[0]) : b[0].localeCompare(a[0]); }
            if (field === 'total') { aVal = a[1].total; bVal = b[1].total; }
            else if (field === 'count') { aVal = a[1].count; bVal = b[1].count; }
            else if (field === 'avg') { aVal = a[1].total / a[1].count; bVal = b[1].total / b[1].count; }
            return _divSortAsc ? aVal - bVal : bVal - aVal;
        });
        _renderDividendBody(sorted);
    }

    // ---- Turnover table sort ----
    let _toSortField = 'year', _toSortAsc = false;
    let _lastTurnoverData = [];

    function _renderTurnoverBody(data) {
        document.getElementById('turnoverBody').innerHTML = data.map(d => `<tr>
            <td style="font-weight:700;">${d.year}</td>
            <td style="color:#28a745;">$${d.buys.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
            <td style="color:#dc3545;">$${d.sells.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
            <td>${d.buys + d.sells > 0 ? Math.round((d.buys + d.sells) / 2).toLocaleString() : '0'}</td>
            <td style="color:#febc11;">$${d.dividends.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
            <td>${d.total}</td>
        </tr>`).join('');
    }

    function sortTurnoverTable(field) {
        if (_toSortField === field) { _toSortAsc = !_toSortAsc; } else { _toSortField = field; _toSortAsc = false; }
        document.querySelectorAll('#turnoverTable thead th[data-tokey]').forEach(th => {
            const arrow = th.querySelector('.to-sort-arrow');
            if (!arrow) return;
            arrow.textContent = th.dataset.tokey === field ? (_toSortAsc ? ' â†‘' : ' â†“') : ' â†•';
        });
        const sorted = _lastTurnoverData.slice().sort((a, b) => {
            let aVal, bVal;
            if (field === 'year')  { aVal = a.year;      bVal = b.year; }
            else if (field === 'buys')  { aVal = a.buys;      bVal = b.buys; }
            else if (field === 'sells') { aVal = a.sells;     bVal = b.sells; }
            else if (field === 'net')   { aVal = a.buys + a.sells; bVal = b.buys + b.sells; }
            else if (field === 'divs')  { aVal = a.dividends; bVal = b.dividends; }
            else if (field === 'total') { aVal = a.total;     bVal = b.total; }
            return _toSortAsc ? aVal - bVal : bVal - aVal;
        });
        _renderTurnoverBody(sorted);
    }

    function renderTurnover() {
        const years = [2021, 2022, 2023, 2024, 2025, 2026];
        const annualData = years.map(yr => {
            const yearTxns = activityData.filter(t => t.year === yr);
            const buys = yearTxns.filter(t => t.actionType === 'BUY').reduce((s, t) => s + Math.abs(t.amount), 0);
            const sells = yearTxns.filter(t => t.actionType === 'SELL').reduce((s, t) => s + Math.abs(t.amount), 0);
            const divs = yearTxns.filter(t => t.actionType === 'DIVIDEND').reduce((s, t) => s + t.amount, 0);
            return { year: yr, buys, sells, dividends: divs, total: yearTxns.length };
        });

        _lastTurnoverData = annualData;
        _renderTurnoverBody(annualData);

        if (historyCharts.turnover) historyCharts.turnover.destroy();
        const ctx = document.getElementById('turnoverChart');
        if (ctx) {
            historyCharts.turnover = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: years.map(String),
                    datasets: [
                        { label: 'Buys ($)', data: annualData.map(d => d.buys), backgroundColor: 'rgba(40,167,69,0.4)', borderColor: '#28a745', borderWidth: 1 },
                        { label: 'Sells ($)', data: annualData.map(d => d.sells), backgroundColor: 'rgba(220,53,69,0.4)', borderColor: '#dc3545', borderWidth: 1 },
                        { label: 'Dividends ($)', data: annualData.map(d => d.dividends), backgroundColor: 'rgba(254,188,17,0.4)', borderColor: '#febc11', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#e5e5e5' } } },
                    scales: { x: { ticks: { color: '#aaa' }, grid: { display: false } }, y: { ticks: { color: '#aaa', callback: v => '$' + (v/1000).toFixed(0) + 'K' }, grid: { color: 'rgba(255,255,255,0.05)' } } }
                }
            });
        }
    }

    /* =============================================
       PERFORMANCE INTELLIGENCE ENGINE
       ============================================= */
    var perfIntelData = null;
    var perfSparklineChart = null;
    var riskRadarChart = null;
    var currentHeatmapPeriod = 'ret1d';
    var currentPerfPeriod = '1y';
    var currentPerfMode = 'current';
    var perfAbortController = null;
    var modalChart = null;
    var currentModalType = null;

    // --- PERIOD SELECTOR + MODE TOGGLE HANDLERS ---
    document.querySelectorAll('.perf-period-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.perf-period-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            currentPerfPeriod = btn.dataset.period;
            loadPerformanceIntel(currentPerfPeriod, currentPerfMode);
        });
    });
    document.querySelectorAll('.perf-mode-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.perf-mode-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            currentPerfMode = btn.dataset.mode;
            loadPerformanceIntel(currentPerfPeriod, currentPerfMode);
        });
    });

    async function loadPerformanceIntel(period, mode) {
        period = period || currentPerfPeriod;
        mode = mode || currentPerfMode;
        const apiBase = window.apiBaseURL || window.location.origin;
        const loadingEl = document.getElementById('perfLoading');
        const inlineLoading = document.getElementById('perfInlineLoading');
        const inlineMsg = document.getElementById('perfInlineLoadingMsg');

        // Cancel any in-flight request
        if (perfAbortController) { try { perfAbortController.abort(); } catch(e) {} }
        perfAbortController = new AbortController();

        // Show appropriate loading state
        const isFirstLoad = !perfIntelData;
        if (isFirstLoad) {
            if (loadingEl) loadingEl.style.display = '';
        } else {
            if (inlineLoading) {
                inlineMsg.textContent = mode === 'historical' ? 'Reconstructing historical portfolio...' : 'Loading ' + period.toUpperCase() + '...';
                inlineLoading.style.display = 'flex';
            }
        }

        try {
            const totalValue = portfolioData.reduce(function(s, h) { return s + h.quantity * h.lastPrice; }, 0) || 1;
            var endpoint, body;

            if (mode === 'historical') {
                endpoint = '/api/portfolio/historical-analytics';
                body = {
                    currentHoldings: portfolioData.map(function(h) { return { symbol: h.symbol, quantity: h.quantity }; }),
                    period: period
                };
            } else {
                endpoint = '/api/portfolio/analytics';
                body = {
                    holdings: portfolioData.map(function(h) { return { symbol: h.symbol, weight: (h.quantity * h.lastPrice) / totalValue }; }),
                    period: period
                };
            }

            var res = await fetch(apiBase + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
                signal: perfAbortController.signal
            });

            if (!res.ok) throw new Error('API returned ' + res.status);
            perfIntelData = await res.json();
            if (perfIntelData.error && perfIntelData.partial) throw new Error('Insufficient data');

            if (loadingEl) loadingEl.style.display = 'none';
            if (inlineLoading) inlineLoading.style.display = 'none';
            renderPerformanceIntel();
        } catch (err) {
            if (err.name === 'AbortError') return; // cancelled, ignore
            console.warn('Performance Intelligence unavailable:', err.message);
            if (inlineLoading) inlineLoading.style.display = 'none';
            if (isFirstLoad && loadingEl) {
                loadingEl.innerHTML = '<div style="color:rgba(255,255,255,0.3);font-size:0.85rem;"><i class="fas fa-chart-line" style="margin-right:0.5rem;"></i>Performance Intelligence requires API connection. Connect to load analytics.</div>';
            }
        }
    }

    function renderPerformanceIntel() {
        var d = perfIntelData;
        if (!d || !d.portfolio) return;
        renderTickerTape(d);
        renderReturnsCard(d);
        renderRiskCard(d);
        renderHeatmap(d);
        document.getElementById('perfTicker').style.display = '';
        document.getElementById('perfScoreboard').style.display = '';
        document.getElementById('perfHeatmap').style.display = '';
        // Refresh summary cards with perf intel data (e.g. last trading day return)
        updateSummaryCards();
    }

    function renderTickerTape(d) {
        var p = d.portfolio, b = d.benchmark;
        var items = [
            { label: 'Portfolio YTD', value: fmtRet(p.returnYtd), cls: retCls(p.returnYtd) },
            { label: 'S&P 500 YTD', value: fmtRet(b.returnYtd), cls: retCls(b.returnYtd) },
            { label: 'Alpha', value: fmtRet(p.alpha), cls: retCls(p.alpha) },
            { label: 'Beta', value: p.beta.toFixed(2), cls: 'neutral' },
            { label: 'Sharpe', value: p.sharpe.toFixed(2), cls: p.sharpe >= 1 ? 'positive' : p.sharpe >= 0.5 ? 'neutral' : 'negative' },
            { label: 'Sortino', value: p.sortino.toFixed(2), cls: p.sortino >= 1.5 ? 'positive' : p.sortino >= 0.8 ? 'neutral' : 'negative' },
            { label: 'Volatility', value: p.annualizedVol.toFixed(1) + '%', cls: p.annualizedVol < 15 ? 'positive' : p.annualizedVol < 25 ? 'neutral' : 'negative' },
            { label: 'Max Drawdown', value: '-' + p.maxDrawdown.toFixed(1) + '%', cls: p.maxDrawdown < 10 ? 'positive' : p.maxDrawdown < 20 ? 'neutral' : 'negative' },
            { label: '1M Return', value: fmtRet(p.return1m), cls: retCls(p.return1m) },
            { label: 'Eff. Positions', value: p.effectivePositions.toFixed(1), cls: 'neutral' },
        ];
        var html = items.map(function(i) {
            return '<span class="ticker-item"><span class="ticker-label">' + i.label + '</span><span class="ticker-value ' + i.cls + '">' + i.value + '</span></span><span class="ticker-sep">\u25CF</span>';
        }).join('');
        document.getElementById('perfTickerInner').innerHTML = html + html;
    }

    function getSparklineConfig(d, canvasId) {
        return {
            type: 'line',
            data: {
                labels: d.sparkline.dates,
                datasets: [
                    { label: 'DIG Portfolio', data: d.sparkline.portfolio, borderColor: '#febc11', backgroundColor: 'rgba(254,188,17,0.08)', fill: true, tension: 0.3, borderWidth: 2.5, pointRadius: 0, pointHitRadius: 8 },
                    { label: 'S&P 500', data: d.sparkline.spy, borderColor: 'rgba(77,171,247,0.7)', backgroundColor: 'transparent', fill: false, tension: 0.3, borderWidth: 1.5, borderDash: [4, 3], pointRadius: 0, pointHitRadius: 8 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { color: '#c9d1d9', usePointStyle: true, pointStyleWidth: 12, font: { size: 11 } } },
                    tooltip: { backgroundColor: 'rgba(0,0,0,0.85)', titleColor: '#febc11', bodyColor: '#e5e5e5',
                        callbacks: { label: function(ctx) { return ctx.dataset.label + ': ' + (ctx.parsed.y >= 0 ? '+' : '') + ctx.parsed.y.toFixed(2) + '%'; } }
                    }
                },
                scales: {
                    x: { display: true, ticks: { color: 'rgba(255,255,255,0.3)', maxTicksLimit: 8, font: { size: 10 } }, grid: { display: false } },
                    y: { display: true, ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 10 }, callback: function(v) { return (v >= 0 ? '+' : '') + v.toFixed(1) + '%'; } }, grid: { color: 'rgba(255,255,255,0.04)' } }
                }
            }
        };
    }

    function getRadarConfig(d) {
        var p = d.portfolio;
        var betaScore = Math.min(100, Math.max(0, (2 - Math.abs(p.beta - 1)) / 2 * 100));
        var sharpeScore = Math.min(100, Math.max(0, p.sharpe / 3 * 100));
        var volScore = Math.min(100, Math.max(0, (40 - p.annualizedVol) / 40 * 100));
        var ddScore = Math.min(100, Math.max(0, (30 - p.maxDrawdown) / 30 * 100));
        var divScore = Math.min(100, Math.max(0, p.effectivePositions / 20 * 100));
        var sortinoScore = Math.min(100, Math.max(0, p.sortino / 3 * 100));
        return {
            type: 'radar',
            data: {
                labels: ['Beta Stability', 'Sharpe Ratio', 'Low Volatility', 'Drawdown Protection', 'Diversification', 'Sortino Ratio'],
                datasets: [{ label: 'DIG Portfolio', data: [betaScore, sharpeScore, volScore, ddScore, divScore, sortinoScore],
                    backgroundColor: 'rgba(254,188,17,0.15)', borderColor: '#febc11', borderWidth: 2, pointBackgroundColor: '#febc11', pointRadius: 4, pointHoverRadius: 6 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { r: { beginAtZero: true, max: 100, ticks: { display: false, stepSize: 25 }, grid: { color: 'rgba(255,255,255,0.08)' }, angleLines: { color: 'rgba(255,255,255,0.08)' }, pointLabels: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } } } }
            }
        };
    }

    function renderReturnsCard(d) {
        var p = d.portfolio, b = d.benchmark;
        if (perfSparklineChart) perfSparklineChart.destroy();
        var ctx = document.getElementById('perfSparklineChart');
        if (ctx) { perfSparklineChart = new Chart(ctx.getContext('2d'), getSparklineConfig(d)); }

        var periods = ['return1m', 'return3m', 'return6m', 'returnYtd', 'return1y'];
        function retCell(val) {
            if (val == null) return '<td>\u2014</td>';
            var cls = val >= 0 ? 'ret-positive' : 'ret-negative';
            return '<td class="' + cls + '">' + (val >= 0 ? '+' : '') + val.toFixed(2) + '%</td>';
        }
        var tbody = '<tr><td class="ret-label" style="color:#febc11;">\u26A1 DIG Portfolio</td>';
        periods.forEach(function(k) { tbody += retCell(p[k]); });
        tbody += '</tr><tr><td class="ret-label" style="color:#4dabf7;">\uD83D\uDCCA S&P 500</td>';
        periods.forEach(function(k) { tbody += retCell(b[k]); });
        tbody += '</tr><tr class="alpha-row"><td class="ret-label">\uD83C\uDFC6 Alpha</td>';
        periods.forEach(function(k) {
            var pv = p[k], bv = b[k];
            if (pv == null || bv == null) { tbody += '<td>\u2014</td>'; return; }
            var alpha = pv - bv;
            var cls = alpha >= 0 ? 'ret-positive' : 'ret-negative';
            tbody += '<td class="' + cls + '">' + (alpha >= 0 ? '+' : '') + alpha.toFixed(2) + '%</td>';
        });
        tbody += '</tr>';
        document.getElementById('perfReturnsBody').innerHTML = tbody;
    }

    function renderRiskCard(d) {
        var p = d.portfolio;
        if (riskRadarChart) riskRadarChart.destroy();
        var ctx = document.getElementById('riskRadarChart');
        if (ctx) { riskRadarChart = new Chart(ctx.getContext('2d'), getRadarConfig(d)); }

        var metrics = [
            { label: 'Beta', value: p.beta.toFixed(2), cls: Math.abs(p.beta - 1) < 0.2 ? 'good' : Math.abs(p.beta - 1) < 0.5 ? 'warn' : 'bad' },
            { label: 'Sharpe', value: p.sharpe.toFixed(2), cls: p.sharpe >= 1.0 ? 'good' : p.sharpe >= 0.5 ? 'warn' : 'bad' },
            { label: 'Sortino', value: p.sortino.toFixed(2), cls: p.sortino >= 1.5 ? 'good' : p.sortino >= 0.8 ? 'warn' : 'bad' },
            { label: 'Vol (Ann.)', value: p.annualizedVol.toFixed(1) + '%', cls: p.annualizedVol < 15 ? 'good' : p.annualizedVol < 25 ? 'warn' : 'bad' },
            { label: 'Max DD', value: '-' + p.maxDrawdown.toFixed(1) + '%', cls: p.maxDrawdown < 10 ? 'good' : p.maxDrawdown < 20 ? 'warn' : 'bad' },
            { label: 'Alpha', value: (p.alpha >= 0 ? '+' : '') + p.alpha.toFixed(2) + '%', cls: p.alpha >= 0 ? 'good' : 'bad' }
        ];
        document.getElementById('riskMetricsGrid').innerHTML = metrics.map(function(m) {
            return '<div class="risk-metric-pill"><span class="rmp-label">' + m.label + '</span><span class="rmp-value ' + m.cls + '">' + m.value + '</span></div>';
        }).join('');
    }

    function renderHeatmap(d) {
        if (!d.stockPerformance || d.stockPerformance.length === 0) return;
        document.querySelectorAll('.heatmap-period-tab').forEach(function(tab) {
            tab.onclick = function() {
                document.querySelectorAll('.heatmap-period-tab').forEach(function(t) { t.classList.remove('active'); });
                tab.classList.add('active');
                currentHeatmapPeriod = tab.dataset.period;
                buildHeatmapGrid(d.stockPerformance, currentHeatmapPeriod);
            };
        });
        buildHeatmapGrid(d.stockPerformance, currentHeatmapPeriod);
    }

    function buildHeatmapGrid(stocks, period, targetEl) {
        var grid = targetEl || document.getElementById('heatmapGrid');
        var sorted = stocks.slice().sort(function(a, b) { return b.weight - a.weight; });
        grid.innerHTML = sorted.map(function(s) {
            var ret = s[period];
            var bg = heatmapColor(ret);
            var retStr = ret != null ? (ret >= 0 ? '+' : '') + ret.toFixed(1) + '%' : '\u2014';
            return '<div class="heatmap-cell" style="background:' + bg + ';" title="' + s.symbol + ': ' + retStr + ' (' + s.weight.toFixed(1) + '% of portfolio)">' +
                '<div class="hm-symbol">' + s.symbol + '</div>' +
                '<div class="hm-return">' + retStr + '</div>' +
                '<div class="hm-weight">' + s.weight.toFixed(1) + '%</div></div>';
        }).join('');
    }

    function heatmapColor(ret) {
        if (ret == null) return 'rgba(255,255,255,0.06)';
        if (ret >= 0) {
            var intensity = Math.min(ret / 15, 1);
            return 'rgba(' + Math.round(20 + (1 - intensity) * 30) + ',' + Math.round(80 + intensity * 120) + ',' + Math.round(40 + (1 - intensity) * 30) + ',' + (0.4 + intensity * 0.4) + ')';
        } else {
            var intensity = Math.min(Math.abs(ret) / 15, 1);
            return 'rgba(' + Math.round(180 + intensity * 60) + ',' + Math.round(60 - intensity * 30) + ',' + Math.round(60 - intensity * 30) + ',' + (0.4 + intensity * 0.4) + ')';
        }
    }

    function fmtRet(val) { return val == null ? '\u2014' : (val >= 0 ? '+' : '') + val.toFixed(2) + '%'; }
    function retCls(val) { return val == null ? 'neutral' : val >= 0 ? 'positive' : 'negative'; }

    /* =============================================
       CHART MODAL (Enlarge + PNG Download)
       ============================================= */
    function openChartModal(type) {
        currentModalType = type;
        var modal = document.getElementById('chartModal');
        var title = document.getElementById('chartModalTitle');
        var canvas = document.getElementById('chartModalCanvas');
        var heatmapDiv = document.getElementById('chartModalHeatmap');
        var body = document.getElementById('chartModalBody');

        if (modalChart) { modalChart.destroy(); modalChart = null; }

        var titles = { sparkline: 'Portfolio vs S&P 500 â€” Cumulative Returns', radar: 'Risk Profile â€” Radar Analysis', heatmap: 'Holdings Performance Heatmap â€” ' + currentHeatmapPeriod.replace('ret','').toUpperCase() };
        title.textContent = titles[type] || 'Chart';

        if (type === 'heatmap') {
            canvas.style.display = 'none';
            heatmapDiv.style.display = '';
            body.style.minHeight = '400px';
            if (perfIntelData && perfIntelData.stockPerformance) {
                buildHeatmapGrid(perfIntelData.stockPerformance, currentHeatmapPeriod, heatmapDiv);
            }
        } else {
            canvas.style.display = '';
            heatmapDiv.style.display = 'none';
            body.style.minHeight = type === 'radar' ? '500px' : '450px';

            // Give the modal a frame to render so canvas has dimensions
            modal.style.display = 'flex';
            requestAnimationFrame(function() {
                if (type === 'sparkline' && perfIntelData) {
                    var cfg = getSparklineConfig(perfIntelData);
                    cfg.options.plugins.legend.labels.font = { size: 13 };
                    cfg.options.scales.x.ticks.font = { size: 12 };
                    cfg.options.scales.y.ticks.font = { size: 12 };
                    modalChart = new Chart(canvas.getContext('2d'), cfg);
                } else if (type === 'radar' && perfIntelData) {
                    var cfg = getRadarConfig(perfIntelData);
                    cfg.options.scales.r.pointLabels.font = { size: 13 };
                    cfg.data.datasets[0].pointRadius = 6;
                    cfg.data.datasets[0].borderWidth = 3;
                    modalChart = new Chart(canvas.getContext('2d'), cfg);
                }
                modal.classList.add('visible');
            });
            return; // skip showing below since we did it above
        }

        modal.style.display = 'flex';
        requestAnimationFrame(function() { modal.classList.add('visible'); });

        // Escape key handler
        document.addEventListener('keydown', chartModalEscHandler);
    }

    function closeChartModal() {
        var modal = document.getElementById('chartModal');
        modal.classList.remove('visible');
        setTimeout(function() {
            modal.style.display = 'none';
            if (modalChart) { modalChart.destroy(); modalChart = null; }
            document.getElementById('chartModalHeatmap').innerHTML = '';
        }, 250);
        document.removeEventListener('keydown', chartModalEscHandler);
    }

    function closeChartModalBackdrop(e) {
        if (e.target === e.currentTarget) closeChartModal();
    }

    function chartModalEscHandler(e) {
        if (e.key === 'Escape') closeChartModal();
    }

    function downloadChartPNG() {
        var filename = 'DIG_' + (currentModalType || 'chart') + '_' + currentPerfPeriod + '.png';

        if (currentModalType === 'heatmap') {
            // Draw heatmap manually on canvas
            var stocks = perfIntelData && perfIntelData.stockPerformance ? perfIntelData.stockPerformance.slice().sort(function(a, b) { return b.weight - a.weight; }) : [];
            var cols = Math.ceil(Math.sqrt(stocks.length * 1.5));
            var cellW = 130, cellH = 70, pad = 6, titleH = 50;
            var rows = Math.ceil(stocks.length / cols);
            var cvs = document.createElement('canvas');
            cvs.width = cols * (cellW + pad) + pad;
            cvs.height = rows * (cellH + pad) + pad + titleH;
            var ctx = cvs.getContext('2d');
            ctx.fillStyle = '#0f1419';
            ctx.fillRect(0, 0, cvs.width, cvs.height);
            ctx.fillStyle = '#febc11';
            ctx.font = 'bold 18px Segoe UI, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('DIG Holdings Heatmap â€” ' + currentHeatmapPeriod.replace('ret','').toUpperCase(), cvs.width / 2, 32);

            stocks.forEach(function(s, i) {
                var col = i % cols, row = Math.floor(i / cols);
                var x = pad + col * (cellW + pad), y = titleH + pad + row * (cellH + pad);
                var ret = s[currentHeatmapPeriod];
                ctx.fillStyle = heatmapColor(ret);
                roundRect(ctx, x, y, cellW, cellH, 8);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Segoe UI, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(s.symbol, x + cellW / 2, y + 25);
                ctx.font = '12px Segoe UI, sans-serif';
                var retStr = ret != null ? (ret >= 0 ? '+' : '') + ret.toFixed(1) + '%' : '\u2014';
                ctx.fillText(retStr, x + cellW / 2, y + 43);
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.font = '10px Segoe UI, sans-serif';
                ctx.fillText(s.weight.toFixed(1) + '%', x + cellW / 2, y + 58);
            });
            triggerDownload(cvs.toDataURL('image/png'), filename);
        } else {
            var canvas = document.getElementById('chartModalCanvas');
            if (canvas) triggerDownload(canvas.toDataURL('image/png'), filename);
        }
    }

    function roundRect(ctx, x, y, w, h, r) {
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.lineTo(x + w - r, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + r);
        ctx.lineTo(x + w, y + h - r);
        ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
        ctx.lineTo(x + r, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - r);
        ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y);
        ctx.closePath();
    }

    function triggerDownload(dataUrl, filename) {
        var a = document.createElement('a');
        a.href = dataUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Hook into dashboard updates
    var originalUpdateDashboard = updateDashboard;
    updateDashboard = function() {
        originalUpdateDashboard();
        setTimeout(function() { loadPerformanceIntel(); }, 500);
    };

    // Also load on page ready if API is already connected
    setTimeout(function() {
        if (window.apiBaseURL) { loadPerformanceIntel(); }
    }, 3000);

    </script>
</body>
</html>
