<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Valuation Analysis Lab - UCSB Dean's Investment Group</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="portfolio-config.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6; color: #333; overflow-x: hidden; background: transparent;
        }
        .bg-animation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f1419, #1e3c72, #2a3c5f, #0f1419);
            background-size: 300% 300%; animation: gradientShift 20s ease infinite; z-index: -2;
        }
        @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .particle { position: absolute; border-radius: 50%; animation: float 12s ease-in-out infinite; opacity: 0.3; }
        .particle.gold { background: radial-gradient(circle, rgba(254,188,17,0.6), rgba(255,215,0,0.3)); box-shadow: 0 0 10px rgba(254,188,17,0.2); }
        .particle.blue { background: radial-gradient(circle, rgba(30,60,114,0.6), rgba(42,60,95,0.3)); box-shadow: 0 0 10px rgba(30,60,114,0.2); }
        .particle.white { background: radial-gradient(circle, rgba(255,255,255,0.4), rgba(255,255,255,0.2)); box-shadow: 0 0 8px rgba(255,255,255,0.1); }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); opacity: 0.3; }
            25% { transform: translateY(-20px) rotate(45deg) scale(1.1); opacity: 0.5; }
            50% { transform: translateY(-40px) rotate(90deg) scale(0.9); opacity: 0.2; }
            75% { transform: translateY(-20px) rotate(135deg) scale(1.05); opacity: 0.4; }
        }
        header {
            position: fixed; top: 0; width: 100%;
            background: rgba(15, 20, 25, 0.95); backdrop-filter: blur(20px);
            z-index: 1000; padding: 1rem 0; transition: all 0.3s ease;
            border-bottom: 1px solid rgba(254, 188, 17, 0.2);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        nav { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; padding: 0 2rem; }
        .logo { display: flex; align-items: center; gap: 1rem; color: white; font-size: 1.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .logo i { color: #febc11; font-size: 2rem; transition: transform 0.3s ease; }
        .logo:hover i { transform: scale(1.1); }
        .nav-links { display: flex; list-style: none; gap: 3rem; }
        .nav-links a { color: white; text-decoration: none; font-weight: 600; font-size: 1.1rem; transition: all 0.3s ease; position: relative; }
        .nav-links a::after { content: ''; position: absolute; width: 0; height: 2px; bottom: -5px; left: 0; background: #febc11; transition: width 0.3s ease; }
        .nav-links a:hover::after { width: 100%; }
        .nav-links a:hover { color: #febc11; transform: translateY(-2px); }
        .nav-links a.active { color: #febc11; }
        .nav-links a.active::after { width: 100%; }
        .live-portfolio-link {
            background: linear-gradient(135deg, #28a745, #20c997) !important; color: white !important;
            padding: 0.5rem 1rem !important; border-radius: 20px !important; font-weight: 600 !important; transition: all 0.3s ease !important;
        }
        .live-portfolio-link:hover { background: linear-gradient(135deg, #20c997, #28a745) !important; transform: translateY(-3px) !important; box-shadow: 0 4px 12px rgba(40,167,69,0.3) !important; }
        .mobile-menu-toggle { display: none; flex-direction: column; cursor: pointer; padding: 0.5rem; }
        .mobile-menu-toggle span { width: 25px; height: 3px; background: #febc11; margin: 3px 0; transition: 0.3s; border-radius: 2px; }
        @media (max-width: 768px) {
            .mobile-menu-toggle { display: flex; }
            .nav-links { position: fixed; top: 80px; left: -100%; width: 100%; height: calc(100vh - 80px); background: rgba(0,0,0,0.95); flex-direction: column; justify-content: flex-start; align-items: center; padding-top: 3rem; transition: left 0.3s ease; backdrop-filter: blur(20px); }
            .nav-links.active { left: 0; }
            .nav-links li { margin: 1rem 0; }
            .nav-links a { font-size: 1.5rem; }
        }

        /* Page Layout */
        .page-wrapper { max-width: 1400px; margin: 0 auto; padding: 7rem 2rem 3rem; color: white; }
        .dashboard-hero { text-align: center; margin-bottom: 2.5rem; }
        .dashboard-hero h1 {
            font-size: 3rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;
            background: linear-gradient(135deg, #ffffff, #febc11, #ffffff); background-size: 200% 200%;
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
            animation: shimmer 6s ease-in-out infinite;
        }
        @keyframes shimmer { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .dashboard-hero .subtitle { font-size: 1.4rem; opacity: 0.9; margin-bottom: 0.75rem; }
        .dashboard-hero p { font-size: 1rem; opacity: 0.8; max-width: 800px; margin: 0.5rem auto 1.5rem; }
        .section-separator { height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent); margin: 2.5rem 0; }

        /* Analysis Grid */
        .analysis-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem; margin-bottom: 2.5rem;
        }
        .analysis-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            border-radius: 16px; padding: 1.8rem; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(16px); cursor: pointer; transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        .analysis-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, #febc11, #ffd700); opacity: 0; transition: opacity 0.3s ease;
        }
        .analysis-card:hover { transform: translateY(-4px); border-color: rgba(254,188,17,0.4); box-shadow: 0 12px 40px rgba(0,0,0,0.4); }
        .analysis-card:hover::before { opacity: 1; }
        .analysis-card.disabled { opacity: 0.5; cursor: not-allowed; }
        .analysis-card.disabled:hover { transform: none; border-color: rgba(255,255,255,0.1); box-shadow: none; }
        .analysis-card.disabled::before { display: none; }
        .analysis-card .card-icon { font-size: 2.2rem; margin-bottom: 1rem; }
        .analysis-card .card-title { font-size: 1.15rem; font-weight: 700; margin-bottom: 0.3rem; color: #fff; }
        .analysis-card .card-firm { font-size: 0.8rem; color: #febc11; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.6rem; }
        .analysis-card .card-desc { font-size: 0.85rem; opacity: 0.75; line-height: 1.5; }
        .analysis-card .status-badge {
            position: absolute; top: 1rem; right: 1rem; padding: 0.25rem 0.7rem;
            border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .status-badge.active { background: rgba(40,167,69,0.2); color: #28a745; border: 1px solid rgba(40,167,69,0.4); }
        .status-badge.coming-soon { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.15); }

        /* Workspace */
        #analysisWorkspace {
            display: none; background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(16px); padding: 2rem; margin-bottom: 3rem;
        }
        #analysisWorkspace.visible { display: block; animation: fadeInUp 0.4s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .workspace-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .workspace-header h2 { font-size: 1.5rem; color: #febc11; }
        .workspace-close { background: none; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease; }
        .workspace-close:hover { background: rgba(255,255,255,0.1); border-color: #febc11; color: #febc11; }

        /* Ticker Selector */
        .ticker-selector { margin-bottom: 2rem; }
        .ticker-input-row { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap; }
        .ticker-input {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 0.8rem 1.2rem; border-radius: 8px; font-size: 1.1rem;
            font-weight: 600; text-transform: uppercase; width: 160px; outline: none; transition: border-color 0.3s;
        }
        .ticker-input:focus { border-color: #febc11; }
        .ticker-input::placeholder { color: rgba(255,255,255,0.4); text-transform: none; font-weight: 400; }
        .run-btn {
            background: linear-gradient(135deg, #febc11, #ffd700); color: #1e3c72; padding: 0.8rem 2rem;
            border: none; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease;
        }
        .run-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(254,188,17,0.4); }
        .run-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .quick-picks { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .quick-pick {
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.8); padding: 0.3rem 0.7rem; border-radius: 6px;
            font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .quick-pick:hover { background: rgba(254,188,17,0.15); border-color: #febc11; color: #febc11; }

        /* Analysis Output */
        #analysisOutput { min-height: 200px; }
        .analysis-loading {
            text-align: center; padding: 3rem; color: rgba(255,255,255,0.7);
        }
        .analysis-loading .spinner { display: inline-block; width: 40px; height: 40px; border: 3px solid rgba(254,188,17,0.2); border-top-color: #febc11; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .result-grid.full-width { grid-template-columns: 1fr; }
        @media (max-width: 900px) { .result-grid { grid-template-columns: 1fr; } }

        .result-card {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px; padding: 1.5rem; transition: border-color 0.3s;
        }
        .result-card:hover { border-color: rgba(254,188,17,0.25); }
        .result-card.span-2 { grid-column: 1 / -1; }
        .result-card h3 { font-size: 1rem; color: #febc11; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; font-weight: 700; }
        .result-card h3 i { margin-right: 0.5rem; }

        /* Tables */
        .val-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .val-table th { text-align: left; padding: 0.6rem 0.8rem; background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.7); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .val-table td { padding: 0.6rem 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05); color: rgba(255,255,255,0.85); }
        .val-table tr:hover td { background: rgba(255,255,255,0.03); }
        .val-table .positive { color: #28a745; }
        .val-table .negative { color: #dc3545; }
        .val-table .highlight { color: #febc11; font-weight: 700; }

        /* Sensitivity Table */
        .sensitivity-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; text-align: center; }
        .sensitivity-table th { padding: 0.5rem; background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7); font-size: 0.7rem; }
        .sensitivity-table td { padding: 0.5rem; border: 1px solid rgba(255,255,255,0.05); font-weight: 600; }
        .sensitivity-table .cell-green { background: rgba(40,167,69,0.25); color: #28a745; }
        .sensitivity-table .cell-light-green { background: rgba(40,167,69,0.12); color: #6fcf8b; }
        .sensitivity-table .cell-yellow { background: rgba(255,193,7,0.15); color: #ffc107; }
        .sensitivity-table .cell-orange { background: rgba(253,126,20,0.15); color: #fd7e14; }
        .sensitivity-table .cell-red { background: rgba(220,53,69,0.2); color: #dc3545; }
        .sensitivity-table .current-cell { outline: 2px solid #febc11; outline-offset: -2px; }

        /* Verdict */
        .verdict-card { text-align: center; padding: 2rem !important; }
        .verdict-badge {
            display: inline-block; padding: 0.8rem 2rem; border-radius: 12px; font-size: 1.3rem;
            font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1rem;
        }
        .verdict-badge.undervalued { background: rgba(40,167,69,0.2); color: #28a745; border: 2px solid #28a745; }
        .verdict-badge.fairly-valued { background: rgba(255,193,7,0.15); color: #ffc107; border: 2px solid #ffc107; }
        .verdict-badge.overvalued { background: rgba(220,53,69,0.2); color: #dc3545; border: 2px solid #dc3545; }
        .verdict-price { font-size: 2.5rem; font-weight: 800; margin: 0.5rem 0; }
        .verdict-detail { font-size: 1rem; opacity: 0.8; }

        /* Heat Map */
        .heat-map-container { overflow-x: auto; }
        .heat-map { border-collapse: collapse; font-size: 0.75rem; text-align: center; min-width: 100%; }
        .heat-map th { padding: 0.4rem 0.6rem; background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.7); font-size: 0.7rem; white-space: nowrap; }
        .heat-map td { padding: 0.4rem 0.6rem; border: 1px solid rgba(255,255,255,0.03); font-weight: 600; min-width: 50px; }

        /* Risk Score Badges */
        .risk-badge {
            display: inline-block; padding: 0.2rem 0.6rem; border-radius: 8px; font-size: 0.75rem; font-weight: 700;
        }
        .risk-low { background: rgba(40,167,69,0.2); color: #28a745; }
        .risk-medium { background: rgba(255,193,7,0.2); color: #ffc107; }
        .risk-high { background: rgba(220,53,69,0.2); color: #dc3545; }

        /* Chart containers */
        .chart-box { position: relative; height: 280px; margin-top: 0.5rem; }
        .chart-box.tall { height: 350px; }

        /* Key metrics row */
        .metrics-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .metric-item { text-align: center; padding: 1rem; background: rgba(255,255,255,0.04); border-radius: 10px; border: 1px solid rgba(255,255,255,0.06); }
        .metric-item .metric-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.5); margin-bottom: 0.3rem; }
        .metric-item .metric-value { font-size: 1.4rem; font-weight: 800; color: #febc11; }
        .metric-item .metric-sub { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.2rem; }

        /* Error/info messages */
        .analysis-error { text-align: center; padding: 2rem; color: #dc3545; }
        .analysis-error i { font-size: 2rem; margin-bottom: 0.5rem; display: block; }
        .analysis-info { text-align: center; padding: 2rem; color: rgba(255,255,255,0.6); }

        /* Assumptions box */
        .assumptions-box {
            background: rgba(254,188,17,0.06); border: 1px solid rgba(254,188,17,0.2);
            border-radius: 10px; padding: 1.2rem; margin-top: 1rem;
        }
        .assumptions-box h4 { color: #febc11; font-size: 0.85rem; margin-bottom: 0.5rem; }
        .assumptions-box ul { list-style: none; padding: 0; }
        .assumptions-box li { font-size: 0.8rem; color: rgba(255,255,255,0.7); padding: 0.2rem 0; }
        .assumptions-box li::before { content: ''; margin-right: 0.5rem; color: #febc11; }

        /* Disclaimer */
        .disclaimer {
            text-align: center; font-size: 0.75rem; color: rgba(255,255,255,0.35);
            margin-top: 3rem; padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.08);
        }

        /* Grade badges (Competitive Analysis, Capital Allocation) */
        .grade-badge {
            display: inline-block; padding: 0.6rem 1.5rem; border-radius: 12px; font-size: 1.8rem;
            font-weight: 800; letter-spacing: 2px; margin-bottom: 0.5rem;
        }
        .grade-a { background: rgba(40,167,69,0.2); color: #28a745; border: 2px solid #28a745; }
        .grade-b { background: rgba(40,167,69,0.12); color: #6fcf8b; border: 2px solid #6fcf8b; }
        .grade-c { background: rgba(255,193,7,0.15); color: #ffc107; border: 2px solid #ffc107; }
        .grade-d { background: rgba(253,126,20,0.15); color: #fd7e14; border: 2px solid #fd7e14; }
        .grade-f { background: rgba(220,53,69,0.2); color: #dc3545; border: 2px solid #dc3545; }

        /* ESG rating badges */
        .esg-rating-badge {
            display: inline-block; padding: 0.5rem 1.2rem; border-radius: 10px; font-size: 1.3rem;
            font-weight: 800; letter-spacing: 2px; text-transform: uppercase;
        }
        .esg-aaa { background: rgba(40,167,69,0.2); color: #28a745; border: 2px solid #28a745; }
        .esg-aa { background: rgba(40,167,69,0.15); color: #6fcf8b; border: 2px solid #6fcf8b; }
        .esg-a { background: rgba(40,167,69,0.1); color: #8dd; border: 2px solid #8dd; }
        .esg-bbb { background: rgba(255,193,7,0.15); color: #ffc107; border: 2px solid #ffc107; }
        .esg-bb { background: rgba(253,126,20,0.12); color: #fd7e14; border: 2px solid #fd7e14; }
        .esg-b { background: rgba(220,53,69,0.12); color: #e88; border: 2px solid #e88; }
        .esg-ccc { background: rgba(220,53,69,0.2); color: #dc3545; border: 2px solid #dc3545; }

        /* Positive / Negative utility classes (outside tables) */
        .positive { color: #28a745; }
        .negative { color: #dc3545; }

        /* Download CSV button style */
        .download-csv-btn {
            background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none;
            padding: 0.7rem 2rem; border-radius: 10px; font-weight: 700; cursor: pointer;
            transition: all 0.3s; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .download-csv-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(40,167,69,0.3); }
        .download-csv-btn i { font-size: 0.85rem; }

        /* Score bar (ESG component bars) */
        .score-bar-container { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-top: 0.3rem; }
        .score-bar-fill { height: 100%; border-radius: 4px; transition: width 0.8s ease; }

        /* Advanced Settings Panel */
        .advanced-settings-toggle {
            display: flex; align-items: center; gap: 0.5rem; cursor: pointer;
            color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-top: 0.75rem;
            padding: 0.4rem 0; transition: color 0.2s; user-select: none;
        }
        .advanced-settings-toggle:hover { color: #febc11; }
        .advanced-settings-toggle i { font-size: 0.65rem; transition: transform 0.3s; }
        .advanced-settings-toggle.open i { transform: rotate(90deg); }
        .advanced-settings-toggle.open { color: #febc11; }
        .advanced-settings-panel {
            display: none; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px; padding: 1rem 1.2rem; margin-top: 0.5rem;
        }
        .advanced-settings-panel.visible { display: block; animation: fadeIn 0.25s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .settings-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem;
        }
        .setting-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .setting-group label {
            font-size: 0.72rem; color: rgba(255,255,255,0.5); text-transform: uppercase;
            letter-spacing: 0.5px; font-weight: 600;
        }
        .setting-group input, .setting-group textarea {
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
            border-radius: 6px; padding: 0.45rem 0.6rem; color: #e5e5e5; font-size: 0.85rem;
            font-family: 'SF Mono', 'Fira Code', monospace; transition: border-color 0.2s;
        }
        .setting-group input:focus, .setting-group textarea:focus {
            outline: none; border-color: rgba(254,188,17,0.5);
        }
        .setting-group input::placeholder, .setting-group textarea::placeholder { color: rgba(255,255,255,0.25); }
        .setting-group .setting-hint {
            font-size: 0.65rem; color: rgba(255,255,255,0.3); margin-top: 0.1rem;
        }
        .settings-reset-btn {
            background: none; border: 1px solid rgba(255,255,255,0.12); color: rgba(255,255,255,0.4);
            padding: 0.3rem 0.8rem; border-radius: 6px; font-size: 0.72rem; cursor: pointer;
            margin-top: 0.5rem; transition: all 0.2s;
        }
        .settings-reset-btn:hover { border-color: rgba(254,188,17,0.4); color: #febc11; }

        /* Print friendly */
        @media print {
            .bg-animation, .particles, header { display: none; }
            .page-wrapper { padding-top: 0; }
            body { background: white; }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="particles" id="particles"></div>

    <header>
        <nav>
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <span>DIG</span>
            </div>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html#home">Home</a></li>
                <li><a href="index.html#board">Advisory Board</a></li>
                <li><a href="live-portfolio.html" class="live-portfolio-link">üìä Live Portfolio</a></li>
                <li><a href="stock-history.html">üìú Stock History</a></li>
                <li><a href="valuation.html" class="active">üíé Valuation</a></li>
                <li><a href="TrackingError/tracking_error_analyzer.html">üìà Tracking Error</a></li>
            </ul>
            <div class="mobile-menu-toggle" id="mobileMenuToggle">
                <span></span><span></span><span></span>
            </div>
        </nav>
    </header>

    <div class="page-wrapper">
        <div class="dashboard-hero">
            <h1>Valuation Analysis Lab</h1>
            <p class="subtitle">Institutional-Grade Financial Analysis</p>
            <p>Select an analysis model below to run comprehensive valuation and risk assessments on individual stocks or the full DIG portfolio using real-time financial data.</p>
        </div>

        <div class="section-separator"></div>

        <!-- Analysis Model Grid -->
        <div class="analysis-grid" id="analysisGrid">
            <div class="analysis-card" onclick="selectAnalysis('dcf')">
                <span class="status-badge active">Active</span>
                <div class="card-icon">üìä</div>
                <div class="card-title">DCF Valuation</div>
                <div class="card-firm">Morgan Stanley Style</div>
                <div class="card-desc">Full discounted cash flow analysis with 5-year revenue projections, WACC estimation, terminal value, sensitivity tables, and fair value verdict.</div>
            </div>
            <div class="analysis-card" onclick="selectAnalysis('risk')">
                <span class="status-badge active">Active</span>
                <div class="card-icon">üõ°Ô∏è</div>
                <div class="card-title">Portfolio Risk Assessment</div>
                <div class="card-firm">Bridgewater Style</div>
                <div class="card-desc">Comprehensive risk analysis with correlation matrix, sector concentration, recession stress test, VaR, tail risk scenarios, and hedging recommendations.</div>
            </div>
            <div class="analysis-card" onclick="selectAnalysis('comps')">
                <span class="status-badge active">Active</span>
                <div class="card-icon">üèõÔ∏è</div>
                <div class="card-title">Comparable Company Analysis</div>
                <div class="card-firm">Goldman Sachs Style</div>
                <div class="card-desc">Peer comparison using EV/EBITDA, P/E, P/S multiples across industry comps with relative valuation ranges.</div>
            </div>
            <div class="analysis-card" onclick="selectAnalysis('technical')">
                <span class="status-badge active">Active</span>
                <div class="card-icon">üìà</div>
                <div class="card-title">Technical Analysis Dashboard</div>
                <div class="card-firm">Citadel Style</div>
                <div class="card-desc">Multi-timeframe technical analysis with moving averages, RSI, MACD, Bollinger Bands, and support/resistance levels.</div>
            </div>
            <div class="analysis-card" onclick="selectAnalysis('dividend')">
                <span class="status-badge active">Active</span>
                <div class="card-icon">üí∞</div>
                <div class="card-title">Dividend Growth Model</div>
                <div class="card-firm">Wellington Style</div>
                <div class="card-desc">Gordon Growth Model with dividend sustainability analysis, payout ratios, and income projection over 10+ years.</div>
            </div>
            <div class="analysis-card" onclick="selectAnalysis('factor')">
                <span class="status-badge active">Active</span>
                <div class="card-icon">üß¨</div>
                <div class="card-title">Factor Exposure Analysis</div>
                <div class="card-firm">AQR Style</div>
                <div class="card-desc">Multi-factor decomposition: value, momentum, quality, size, and low volatility factor loadings for each position.</div>
            </div>
            <div class="analysis-card" onclick="selectAnalysis('esg')">
                <span class="status-badge active">Active</span>
                <div class="card-icon">üåç</div>
                <div class="card-title">ESG Scoring & Analysis</div>
                <div class="card-firm">BlackRock Style</div>
                <div class="card-desc">Estimated ESG proxy scoring using financial data ‚Äî environmental risk, social metrics, and governance quality indicators.</div>
            </div>
            <div class="analysis-card" onclick="selectAnalysis('competitive')">
                <span class="status-badge active">Active</span>
                <div class="card-icon">‚öîÔ∏è</div>
                <div class="card-title">Competitive Strategy Analysis</div>
                <div class="card-firm">Bain & Company Style</div>
                <div class="card-desc">Competitive landscape mapping, economic moat scoring, SWOT analysis, management quality assessment, and best-in-class stock pick.</div>
            </div>
            <div class="analysis-card" onclick="selectAnalysis('capital')">
                <span class="status-badge active">Active</span>
                <div class="card-icon">üèóÔ∏è</div>
                <div class="card-title">Capital Allocation Scorecard</div>
                <div class="card-firm">Berkshire Style</div>
                <div class="card-desc">ROIC vs WACC analysis, reinvestment rate, margin expansion, capital efficiency rating, and economic moat assessment.</div>
            </div>
            <div class="analysis-card" onclick="selectAnalysis('macro')">
                <span class="status-badge active">Active</span>
                <div class="card-icon">üåê</div>
                <div class="card-title">Macro Sensitivity Analysis</div>
                <div class="card-firm">Bridgewater Style</div>
                <div class="card-desc">Portfolio sensitivity to interest rates, inflation, GDP growth, dollar strength, and commodity prices with scenario modeling.</div>
            </div>
        </div>

        <!-- Analysis Workspace (hidden until card selected) -->
        <div id="analysisWorkspace">
            <div class="workspace-header">
                <h2 id="workspaceTitle">Analysis</h2>
                <button class="workspace-close" onclick="closeWorkspace()"><i class="fas fa-times"></i> Close</button>
            </div>

            <div class="ticker-selector" id="tickerSelector">
                <div class="ticker-input-row">
                    <input type="text" class="ticker-input" id="tickerInput" placeholder="AAPL" maxlength="6" />
                    <button class="run-btn" id="runBtn" onclick="runAnalysis()">
                        <i class="fas fa-play"></i> Run Analysis
                    </button>
                </div>
                <div class="quick-picks" id="quickPicks"></div>
            </div>

            <div id="analysisOutput">
                <div class="analysis-info">
                    <i class="fas fa-arrow-up" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block; opacity: 0.4;"></i>
                    Enter a ticker symbol above and click Run Analysis
                </div>
            </div>
        </div>

        <div class="disclaimer">
            This analysis is for educational purposes only and does not constitute investment advice.<br>
            Models use simplified assumptions and publicly available data via Polygon.io.<br>
            Past performance does not guarantee future results. UCSB Dean's Investment Group.
        </div>
    </div>

    <script>
    // ============================================================
    // PORTFOLIO HOLDINGS (embedded for quick-pick buttons)
    // ============================================================
    const equityHoldings = [
        { symbol: 'TSM', description: 'Taiwan Semiconductor', gicsSector: 'Information Technology', quantity: 137.398, lastPrice: 209.87 },
        { symbol: 'GOOGL', description: 'Alphabet Inc', gicsSector: 'Communication Services', quantity: 137.343, lastPrice: 305.72 },
        { symbol: 'MSFT', description: 'Microsoft Corp', gicsSector: 'Information Technology', quantity: 55.274, lastPrice: 401.32 },
        { symbol: 'AMZN', description: 'Amazon.com', gicsSector: 'Consumer Discretionary', quantity: 112.118, lastPrice: 228.68 },
        { symbol: 'ASML', description: 'ASML Holding NV', gicsSector: 'Information Technology', quantity: 19.917, lastPrice: 747.56 },
        { symbol: 'SNOW', description: 'Snowflake Inc', gicsSector: 'Information Technology', quantity: 62.096, lastPrice: 186.41 },
        { symbol: 'NUKZ', description: 'Range Nuclear Renaissance ETF', gicsSector: 'Energy', quantity: 226.815, lastPrice: 48.69 },
        { symbol: 'VRT', description: 'Vertiv Holdings', gicsSector: 'Industrials', quantity: 77, lastPrice: 113.04 },
        { symbol: 'COST', description: 'Costco Wholesale', gicsSector: 'Consumer Staples', quantity: 15, lastPrice: 1049.47 },
        { symbol: 'XLV', description: 'Health Care Select Sector SPDR', gicsSector: 'Health Care', quantity: 94.93, lastPrice: 148.47 },
        { symbol: 'CEG', description: 'Constellation Energy', gicsSector: 'Utilities', quantity: 33.189, lastPrice: 313.33 },
        { symbol: 'JPM', description: 'JPMorgan Chase', gicsSector: 'Financials', quantity: 40, lastPrice: 276.32 },
        { symbol: 'PANW', description: 'Palo Alto Networks', gicsSector: 'Information Technology', quantity: 54, lastPrice: 197.76 },
        { symbol: 'FLUT', description: 'Flutter Entertainment', gicsSector: 'Consumer Discretionary', quantity: 35.91, lastPrice: 272.35 },
        { symbol: 'SCHW', description: 'Charles Schwab', gicsSector: 'Financials', quantity: 92.199, lastPrice: 81.71 },
        { symbol: 'REMX', description: 'VanEck Rare Earth/Strategic Metals ETF', gicsSector: 'Materials', quantity: 61.438, lastPrice: 89.52 },
        { symbol: 'FCX', description: 'Freeport-McMoRan', gicsSector: 'Materials', quantity: 195.831, lastPrice: 42.31 },
        { symbol: 'DXCM', description: 'DexCom Inc', gicsSector: 'Health Care', quantity: 112.945, lastPrice: 75.52 },
        { symbol: 'PSA', description: 'Public Storage', gicsSector: 'Real Estate', quantity: 20.725, lastPrice: 316.72 }
    ];
    const broadMarketETFs = [
        { symbol: 'VOO', description: 'Vanguard S&P 500 ETF', gicsSector: 'N/A', quantity: 590.669, lastPrice: 626.89 },
        { symbol: 'VTV', description: 'Vanguard Value ETF', gicsSector: 'N/A', quantity: 131.11, lastPrice: 197.27 },
        { symbol: 'SPY', description: 'SPDR S&P 500 ETF', gicsSector: 'N/A', quantity: 34.281, lastPrice: 691.32 }
    ];
    const allHoldings = [...broadMarketETFs, ...equityHoldings];

    // ============================================================
    // STATE
    // ============================================================
    let currentAnalysis = null;
    let apiBaseURL = null;
    const chartInstances = {};

    // ============================================================
    // INITIALIZATION
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
        createParticles();
        initMobileMenu();
        initScrollHeader();
        buildQuickPicks();
        detectAPI();

        document.getElementById('tickerInput').addEventListener('keydown', e => {
            if (e.key === 'Enter') runAnalysis();
        });
    });

    function createParticles() {
        const container = document.getElementById('particles');
        const types = ['gold', 'blue', 'white'];
        for (let i = 0; i < 15; i++) {
            const p = document.createElement('div');
            p.className = `particle ${types[i % 3]}`;
            p.style.left = `${Math.random() * 100}%`;
            p.style.top = `${Math.random() * 100}%`;
            p.style.width = p.style.height = `${Math.random() * 6 + 2}px`;
            p.style.animationDelay = `${Math.random() * 12}s`;
            p.style.animationDuration = `${Math.random() * 8 + 8}s`;
            container.appendChild(p);
        }
    }

    function initMobileMenu() {
        const toggle = document.getElementById('mobileMenuToggle');
        const links = document.getElementById('navLinks');
        toggle.addEventListener('click', () => { toggle.classList.toggle('active'); links.classList.toggle('active'); });
        links.querySelectorAll('a').forEach(a => a.addEventListener('click', () => { toggle.classList.remove('active'); links.classList.remove('active'); }));
    }

    function initScrollHeader() {
        window.addEventListener('scroll', () => {
            const header = document.querySelector('header');
            if (window.scrollY > 50) { header.style.boxShadow = '0 4px 30px rgba(0,0,0,0.3)'; header.style.borderBottomColor = 'rgba(254,188,17,0.3)'; }
            else { header.style.boxShadow = '0 2px 20px rgba(0,0,0,0.1)'; header.style.borderBottomColor = 'rgba(254,188,17,0.2)'; }
        });
    }

    async function detectAPI() {
        const candidates = [];
        const origin = window.location.origin;
        const isHTTPS = origin && origin.startsWith('https');
        if (origin && origin !== 'null') {
            // On production (HTTPS), try same-origin first ‚Äî API routes are on the same domain
            candidates.push(origin);
            // On local dev, also try common dev ports
            if (!isHTTPS) {
                candidates.push(origin.replace(/:\d+$/, ':3002'));
                candidates.push(origin.replace(/:\d+$/, ':3001'));
            }
        }
        if (!isHTTPS) {
            candidates.push('http://127.0.0.1:3002', 'http://127.0.0.1:3001');
        }
        for (const base of candidates) {
            try {
                const res = await fetch(base + '/api/health', { cache: 'no-store' });
                if (res.ok) { const data = await res.json(); if (data.status === 'OK') { apiBaseURL = base; console.log('API connected:', base); return; } }
            } catch (e) { continue; }
        }
        console.warn('No API detected. Valuation analysis requires a running API server.');
    }

    function buildQuickPicks() {
        const container = document.getElementById('quickPicks');
        const tickers = equityHoldings.map(h => h.symbol);
        container.innerHTML = '<span style="font-size:0.8rem;opacity:0.5;margin-right:0.5rem;">Portfolio:</span>' +
            tickers.map(t => `<span class="quick-pick" onclick="pickTicker('${t}')">${t}</span>`).join('');
    }

    function pickTicker(symbol) {
        document.getElementById('tickerInput').value = symbol;
    }

    // ============================================================
    // WORKSPACE MANAGEMENT
    // ============================================================
    // Model configuration for all 10 analysis types
    const MODEL_CONFIG = {
        dcf:       { title: '<i class="fas fa-calculator"></i> DCF Valuation ‚Äî Morgan Stanley Style', ticker: true, btnLabel: 'Run DCF Analysis' },
        risk:      { title: '<i class="fas fa-shield-alt"></i> Portfolio Risk Assessment ‚Äî Bridgewater Style', ticker: false, btnLabel: 'Run Portfolio Risk Assessment' },
        comps:     { title: '<i class="fas fa-university"></i> Comparable Company Analysis ‚Äî Goldman Sachs Style', ticker: true, btnLabel: 'Run Comp Analysis' },
        technical: { title: '<i class="fas fa-chart-line"></i> Technical Analysis Dashboard ‚Äî Citadel Style', ticker: true, btnLabel: 'Run Technical Analysis' },
        dividend:  { title: '<i class="fas fa-coins"></i> Dividend Growth Model ‚Äî Wellington Style', ticker: true, btnLabel: 'Run Dividend Analysis' },
        factor:    { title: '<i class="fas fa-dna"></i> Factor Exposure Analysis ‚Äî AQR Style', ticker: false, btnLabel: 'Run Factor Analysis' },
        esg:       { title: '<i class="fas fa-globe"></i> ESG Scoring & Analysis ‚Äî BlackRock Style', ticker: 'optional', btnLabel: 'Run ESG Analysis' },
        competitive: { title: '<i class="fas fa-chess-knight"></i> Competitive Strategy Analysis ‚Äî Bain & Company Style', ticker: true, btnLabel: 'Run Competitive Analysis' },
        capital:   { title: '<i class="fas fa-building"></i> Capital Allocation Scorecard ‚Äî Berkshire Style', ticker: true, btnLabel: 'Run Capital Analysis' },
        macro:     { title: '<i class="fas fa-globe-americas"></i> Macro Sensitivity Analysis ‚Äî Bridgewater Style', ticker: false, btnLabel: 'Run Macro Analysis' }
    };

    // ============================================================
    // ADVANCED SETTINGS
    // ============================================================
    function toggleAdvancedSettings() {
        const toggle = document.getElementById('advSettingsToggle');
        const panel = document.getElementById('advSettingsPanel');
        if (!toggle || !panel) return;
        const isOpen = panel.classList.contains('visible');
        panel.classList.toggle('visible');
        toggle.classList.toggle('open');
    }

    function resetAdvancedSettings() {
        const inputs = document.querySelectorAll('#advSettingsPanel input, #advSettingsPanel textarea');
        inputs.forEach(inp => { inp.value = ''; });
    }

    function getModelOverrides() {
        const o = {};
        const panel = document.getElementById('advSettingsPanel');
        if (!panel || !panel.classList.contains('visible')) return o;
        const inputs = panel.querySelectorAll('input[data-key], textarea[data-key]');
        inputs.forEach(inp => {
            const key = inp.getAttribute('data-key');
            const val = inp.value.trim();
            if (val !== '') {
                // Parse as number if it looks numeric; strip trailing %
                const cleaned = val.replace(/%$/, '');
                const num = parseFloat(cleaned);
                if (!isNaN(num)) {
                    // If user typed a percentage (e.g. "12" or "12%"), convert to decimal
                    o[key] = inp.hasAttribute('data-pct') ? num / 100 : num;
                } else {
                    o[key] = val; // string value (e.g. custom peers)
                }
            }
        });
        return o;
    }

    function getAdvancedSettingsHTML(type) {
        if (type === 'dcf') {
            return `
                <div class="advanced-settings-toggle" id="advSettingsToggle" onclick="toggleAdvancedSettings()">
                    <i class="fas fa-caret-right"></i> Advanced Settings
                </div>
                <div class="advanced-settings-panel" id="advSettingsPanel">
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label>Revenue Growth Rate</label>
                            <input type="text" data-key="revenueGrowth" data-pct placeholder="Auto" />
                            <div class="setting-hint">e.g. 12 for 12% (blank = historical avg)</div>
                        </div>
                        <div class="setting-group">
                            <label>Terminal Growth Rate</label>
                            <input type="text" data-key="terminalGrowth" data-pct placeholder="3%" />
                            <div class="setting-hint">Long-run GDP growth (default 3%)</div>
                        </div>
                        <div class="setting-group">
                            <label>WACC Override</label>
                            <input type="text" data-key="wacc" data-pct placeholder="Auto (CAPM)" />
                            <div class="setting-hint">e.g. 10 for 10% (blank = CAPM-derived)</div>
                        </div>
                        <div class="setting-group">
                            <label>Exit Multiple</label>
                            <input type="text" data-key="exitMultiple" placeholder="15x" />
                            <div class="setting-hint">Terminal EV/EBIT multiple (default 15x)</div>
                        </div>
                        <div class="setting-group">
                            <label>Operating Margin</label>
                            <input type="text" data-key="opMargin" data-pct placeholder="Auto" />
                            <div class="setting-hint">e.g. 25 for 25% (blank = historical avg)</div>
                        </div>
                    </div>
                    <button class="settings-reset-btn" onclick="resetAdvancedSettings()"><i class="fas fa-undo"></i> Reset to Defaults</button>
                </div>`;
        }
        if (type === 'comps') {
            return `
                <div class="advanced-settings-toggle" id="advSettingsToggle" onclick="toggleAdvancedSettings()">
                    <i class="fas fa-caret-right"></i> Advanced Settings
                </div>
                <div class="advanced-settings-panel" id="advSettingsPanel">
                    <div class="settings-grid">
                        <div class="setting-group" style="grid-column: 1 / -1;">
                            <label>Custom Peer Tickers</label>
                            <input type="text" data-key="customPeers" placeholder="e.g. AAPL, MSFT, GOOGL" style="width:100%;" />
                            <div class="setting-hint">Comma-separated tickers to use as comps (blank = auto sector peers)</div>
                        </div>
                    </div>
                    <button class="settings-reset-btn" onclick="resetAdvancedSettings()"><i class="fas fa-undo"></i> Reset to Defaults</button>
                </div>`;
        }
        if (type === 'dividend') {
            return `
                <div class="advanced-settings-toggle" id="advSettingsToggle" onclick="toggleAdvancedSettings()">
                    <i class="fas fa-caret-right"></i> Advanced Settings
                </div>
                <div class="advanced-settings-panel" id="advSettingsPanel">
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label>Dividend Growth Rate</label>
                            <input type="text" data-key="divGrowthRate" data-pct placeholder="Auto" />
                            <div class="setting-hint">e.g. 7 for 7% (blank = historical CAGR)</div>
                        </div>
                        <div class="setting-group">
                            <label>Cost of Equity Override</label>
                            <input type="text" data-key="costOfEquity" data-pct placeholder="Auto (CAPM)" />
                            <div class="setting-hint">e.g. 10 for 10% (blank = CAPM-derived)</div>
                        </div>
                    </div>
                    <button class="settings-reset-btn" onclick="resetAdvancedSettings()"><i class="fas fa-undo"></i> Reset to Defaults</button>
                </div>`;
        }
        if (type === 'macro') {
            return `
                <div class="advanced-settings-toggle" id="advSettingsToggle" onclick="toggleAdvancedSettings()">
                    <i class="fas fa-caret-right"></i> Custom Scenario Builder
                </div>
                <div class="advanced-settings-panel" id="advSettingsPanel">
                    <div style="font-size:0.75rem;color:rgba(255,255,255,0.5);margin-bottom:0.75rem;">
                        Define a custom macro scenario. Values represent standard deviation moves (e.g., +1 = one œÉ increase).
                        Leave blank to use the default four scenarios only.
                    </div>
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label>Interest Rates</label>
                            <input type="text" data-key="customRates" placeholder="e.g. +1.0" />
                            <div class="setting-hint">œÉ move (+ = rates rise)</div>
                        </div>
                        <div class="setting-group">
                            <label>Inflation</label>
                            <input type="text" data-key="customInflation" placeholder="e.g. +0.5" />
                            <div class="setting-hint">œÉ move (+ = inflation rises)</div>
                        </div>
                        <div class="setting-group">
                            <label>GDP Growth</label>
                            <input type="text" data-key="customGDP" placeholder="e.g. -1.0" />
                            <div class="setting-hint">œÉ move (+ = growth accelerates)</div>
                        </div>
                        <div class="setting-group">
                            <label>USD Strength</label>
                            <input type="text" data-key="customUSD" placeholder="e.g. +0.5" />
                            <div class="setting-hint">œÉ move (+ = dollar strengthens)</div>
                        </div>
                        <div class="setting-group">
                            <label>Commodities</label>
                            <input type="text" data-key="customCommodity" placeholder="e.g. +1.0" />
                            <div class="setting-hint">œÉ move (+ = prices rise)</div>
                        </div>
                        <div class="setting-group">
                            <label>Scenario Name</label>
                            <input type="text" data-key="customScenarioName" placeholder="My Custom Scenario" />
                            <div class="setting-hint">Label for the custom scenario</div>
                        </div>
                    </div>
                    <button class="settings-reset-btn" onclick="resetAdvancedSettings()"><i class="fas fa-undo"></i> Reset</button>
                </div>`;
        }
        return ''; // No settings panel for other models
    }

    function selectAnalysis(type) {
        const config = MODEL_CONFIG[type];
        if (!config) return;
        currentAnalysis = type;
        const workspace = document.getElementById('analysisWorkspace');
        const title = document.getElementById('workspaceTitle');
        const output = document.getElementById('analysisOutput');
        const tickerDiv = document.getElementById('tickerSelector');

        title.innerHTML = config.title;
        const settingsHTML = getAdvancedSettingsHTML(type);

        if (config.ticker === true) {
            // Single-ticker model: show ticker input + quick picks + optional settings
            tickerDiv.style.display = 'block';
            tickerDiv.innerHTML = `
                <div class="ticker-input-row">
                    <input type="text" class="ticker-input" id="tickerInput" placeholder="AAPL" maxlength="6" />
                    <button class="run-btn" id="runBtn" onclick="runAnalysis()"><i class="fas fa-play"></i> ${config.btnLabel}</button>
                </div>
                <div class="quick-picks" id="quickPicks"></div>
                ${settingsHTML}`;
            buildQuickPicks();
            document.getElementById('tickerInput').addEventListener('keydown', e => { if (e.key === 'Enter') runAnalysis(); });
            output.innerHTML = '<div class="analysis-info"><i class="fas fa-arrow-up" style="font-size:1.5rem;margin-bottom:0.5rem;display:block;opacity:0.4;"></i>Enter a ticker symbol above and click Run Analysis</div>';
        } else if (config.ticker === 'optional') {
            // Dual mode (ESG): ticker input + portfolio button
            tickerDiv.style.display = 'block';
            tickerDiv.innerHTML = `
                <div class="ticker-input-row">
                    <input type="text" class="ticker-input" id="tickerInput" placeholder="AAPL (or leave blank for portfolio)" maxlength="6" />
                    <button class="run-btn" id="runBtn" onclick="runAnalysis()"><i class="fas fa-play"></i> Run Single Stock</button>
                </div>
                <div style="text-align:center;margin:0.5rem 0;color:rgba(255,255,255,0.4);font-size:0.85rem;">‚Äî or ‚Äî</div>
                <button class="run-btn" onclick="runPortfolioESG()" style="width:100%;background:linear-gradient(135deg,#20c997,#28a745);"><i class="fas fa-briefcase"></i> Run Full Portfolio ESG</button>
                <div class="quick-picks" id="quickPicks"></div>`;
            buildQuickPicks();
            document.getElementById('tickerInput').addEventListener('keydown', e => { if (e.key === 'Enter') runAnalysis(); });
            output.innerHTML = '<div class="analysis-info"><i class="fas fa-globe" style="font-size:1.5rem;margin-bottom:0.5rem;display:block;opacity:0.4;"></i>Enter a ticker for single-stock ESG, or run full portfolio analysis</div>';
        } else {
            // Portfolio-wide model: just a run button + optional settings
            tickerDiv.style.display = 'block';
            tickerDiv.innerHTML = `<button class="run-btn" onclick="runAnalysis()" style="width:100%;"><i class="fas fa-play"></i> ${config.btnLabel}</button>${settingsHTML}`;
            output.innerHTML = '<div class="analysis-info"><i class="fas fa-briefcase" style="font-size:1.5rem;margin-bottom:0.5rem;display:block;opacity:0.4;"></i>Click Run to analyze the full DIG equity portfolio</div>';
        }

        workspace.classList.add('visible');
        workspace.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function closeWorkspace() {
        document.getElementById('analysisWorkspace').classList.remove('visible');
        destroyCharts();
        currentAnalysis = null;
    }

    function destroyCharts() {
        Object.values(chartInstances).forEach(c => { try { c.destroy(); } catch(e) {} });
        for (const k in chartInstances) delete chartInstances[k];
    }

    // ESG portfolio mode helper
    function runPortfolioESG() {
        currentAnalysis = 'esg';
        destroyCharts();
        if (!apiBaseURL) {
            document.getElementById('analysisOutput').innerHTML = '<div class="analysis-error"><i class="fas fa-exclamation-triangle"></i>No API connection. Start the server with <code>node server.js</code> and refresh.</div>';
            return;
        }
        runESGAnalysis(null); // null = portfolio mode
    }

    async function runAnalysis() {
        if (!apiBaseURL) {
            document.getElementById('analysisOutput').innerHTML = '<div class="analysis-error"><i class="fas fa-exclamation-triangle"></i>No API connection. Start the server with <code>node server.js</code> and refresh.</div>';
            return;
        }
        destroyCharts();

        // For ticker-based models, get the ticker
        const config = MODEL_CONFIG[currentAnalysis];
        let ticker = null;
        if (config && (config.ticker === true || config.ticker === 'optional')) {
            ticker = (document.getElementById('tickerInput')?.value || '').trim().toUpperCase();
            if (config.ticker === true && !ticker) {
                document.getElementById('analysisOutput').innerHTML = '<div class="analysis-error"><i class="fas fa-exclamation-triangle"></i>Please enter a ticker symbol.</div>';
                return;
            }
        }

        // Read any user overrides from Advanced Settings panel
        const overrides = getModelOverrides();

        try {
            switch (currentAnalysis) {
                case 'dcf': await runDCF(ticker, overrides); break;
                case 'risk': await runRiskAssessment(); break;
                case 'comps': await runComparableAnalysis(ticker, overrides); break;
                case 'technical': await runTechnicalAnalysis(ticker); break;
                case 'dividend': await runDividendGrowth(ticker, overrides); break;
                case 'factor': await runFactorExposure(); break;
                case 'esg': await runESGAnalysis(ticker || null); break;
                case 'competitive': await runCompetitiveAnalysis(ticker); break;
                case 'capital': await runCapitalAllocation(ticker); break;
                case 'macro': await runMacroSensitivity(overrides); break;
                default:
                    document.getElementById('analysisOutput').innerHTML = '<div class="analysis-error"><i class="fas fa-exclamation-triangle"></i>Unknown analysis type.</div>';
            }
        } catch (err) {
            console.error('Analysis error:', err);
            document.getElementById('analysisOutput').innerHTML = `<div class="analysis-error"><i class="fas fa-exclamation-triangle"></i>Error running analysis: ${err.message}</div>`;
        }
    }

    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================
    function fmt(n, dec = 2) { if (n == null || isNaN(n)) return 'N/A'; return n.toLocaleString('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec }); }
    function fmtCur(n) { if (n == null || isNaN(n)) return 'N/A'; return (n < 0 ? '-' : '') + '$' + Math.abs(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function fmtBig(n) {
        if (n == null || isNaN(n)) return 'N/A';
        const abs = Math.abs(n);
        if (abs >= 1e12) return (n/1e12).toFixed(2) + 'T';
        if (abs >= 1e9) return (n/1e9).toFixed(2) + 'B';
        if (abs >= 1e6) return (n/1e6).toFixed(2) + 'M';
        if (abs >= 1e3) return (n/1e3).toFixed(1) + 'K';
        return fmt(n);
    }
    function fmtPct(n) { if (n == null || isNaN(n)) return 'N/A'; return (n >= 0 ? '+' : '') + n.toFixed(2) + '%'; }
    function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

    // ============================================================
    // API CACHE (5-minute TTL to avoid redundant calls)
    // ============================================================
    const _apiCache = new Map();
    const _API_CACHE_TTL = 5 * 60 * 1000;
    async function cachedFetch(url) {
        const cached = _apiCache.get(url);
        if (cached && Date.now() - cached.ts < _API_CACHE_TTL) return cached.data;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`API error ${res.status} for ${url}`);
        const data = await res.json();
        _apiCache.set(url, { data, ts: Date.now() });
        return data;
    }

    // ============================================================
    // CSV EXPORT DATA STORE
    // ============================================================
    window._lastAnalysisData = {};

    // ============================================================
    // DCF VALUATION ENGINE
    // ============================================================
    async function runDCF(symbol, overrides) {
        overrides = overrides || {};
        const output = document.getElementById('analysisOutput');
        output.innerHTML = '<div class="analysis-loading"><div class="spinner"></div><br>Fetching financial data for ' + symbol + '...</div>';

        try {
            // Fetch all required data in parallel
            const [financialsRes, detailsRes, analyticsRes, quoteRes] = await Promise.all([
                fetch(`${apiBaseURL}/api/stock/${symbol}/financials?limit=12`).then(r => r.json()),
                fetch(`${apiBaseURL}/api/stock/${symbol}/details`).then(r => r.json()),
                fetch(`${apiBaseURL}/api/stock/${symbol}/analytics`).then(r => r.json()),
                fetch(`${apiBaseURL}/api/stock/${symbol}/comprehensive`).then(r => r.json())
            ]);

            const financials = financialsRes.financials || financialsRes || [];
            const details = detailsRes || {};
            const analytics = analyticsRes.analytics || analyticsRes || {};
            const quote = quoteRes.quote || quoteRes || {};
            // Use prevClose as fallback when price is 0 (market closed / weekends)
            const rawPrice = quote.price || 0;
            const currentPrice = (rawPrice > 0 ? rawPrice : (quote.prevClose || quote.prev_close || 0)) || details.lastPrice || 0;
            const marketCap = details.marketCap || 0;
            const sharesOutstanding = details.weightedSharesOutstanding || details.shareClassSharesOutstanding || 0;
            const companyName = details.name || symbol;
            const beta = analytics.beta || 1.0;

            if (!financials.length || financials.length < 2) {
                output.innerHTML = `<div class="analysis-error"><i class="fas fa-exclamation-triangle"></i>Insufficient financial data for ${symbol}. Need at least 2 quarters of data.</div>`;
                return;
            }

            // Filter to quarterly only
            const quarterly = financials.filter(f => f.fiscalPeriod !== 'FY');
            if (quarterly.length < 2) {
                output.innerHTML = `<div class="analysis-error"><i class="fas fa-exclamation-triangle"></i>Insufficient quarterly financial data for ${symbol}.</div>`;
                return;
            }

            // --- STEP 1: Historical Metrics ---
            const recentQ = quarterly.slice(0, Math.min(4, quarterly.length));
            const ttmRevenue = recentQ.reduce((s, q) => s + (q.revenues || 0), 0);
            const ttmOpIncome = recentQ.reduce((s, q) => s + (q.operatingIncome || 0), 0);
            const ttmNetIncome = recentQ.reduce((s, q) => s + (q.netIncome || 0), 0);
            const ttmCashFlow = recentQ.reduce((s, q) => s + (q.cashFlow || 0), 0);
            const ttmOperatingCF = recentQ.reduce((s, q) => s + (q.operatingCashFlow || 0), 0);
            let avgOpMargin = ttmRevenue > 0 ? ttmOpIncome / ttmRevenue : 0.15;

            // For companies with negative operating margins, use a floor that mean-reverts
            // toward a modest positive margin over the projection period
            const hasNegativeMargin = avgOpMargin < 0;
            const dcfWarnings = [];

            if (hasNegativeMargin) {
                dcfWarnings.push(`Current TTM operating margin is ${(avgOpMargin * 100).toFixed(1)}% (negative). The model assumes margin improvement toward profitability over 5 years.`);
            }

            // YoY growth rates
            const growthRates = [];
            for (let i = 0; i < quarterly.length - 4; i++) {
                const current = quarterly[i].revenues;
                const yearAgo = quarterly[i + 4]?.revenues;
                if (current && yearAgo && yearAgo > 0) {
                    growthRates.push((current - yearAgo) / yearAgo);
                }
            }
            let historicalGrowth = growthRates.length > 0
                ? growthRates.reduce((s, g) => s + g, 0) / growthRates.length
                : 0.08; // default 8%
            historicalGrowth = clamp(historicalGrowth, -0.05, 0.30);

            // Apply user overrides
            if (overrides.revenueGrowth != null) historicalGrowth = overrides.revenueGrowth;
            if (overrides.opMargin != null) avgOpMargin = overrides.opMargin;

            // --- STEP 2: Revenue Projections (5 years) ---
            const terminalGrowthRate = overrides.terminalGrowth != null ? overrides.terminalGrowth : 0.03;
            const projections = [];
            let prevRevenue = ttmRevenue;

            // For negative-margin companies, mean-revert toward a target margin (10%) over 5 years
            const targetMargin = hasNegativeMargin ? 0.10 : 0.15;

            for (let yr = 1; yr <= 5; yr++) {
                const blendedGrowth = historicalGrowth * (1 - yr / 6) + terminalGrowthRate * (yr / 6);
                const revenue = prevRevenue * (1 + blendedGrowth);

                let opMargin;
                if (hasNegativeMargin) {
                    // For negative-margin companies, linearly interpolate toward target margin
                    // This assumes the company is working toward profitability
                    opMargin = avgOpMargin + (targetMargin - avgOpMargin) * (yr / 5);
                } else {
                    opMargin = avgOpMargin * (1 - yr * 0.01) + targetMargin * (yr * 0.01); // mild mean reversion
                }

                const opIncome = revenue * opMargin;

                // FCF conversion ratio: use operating cash flow / operating income if available
                // For negative operating income companies, use operating cash flow directly if positive
                let fcf;
                if (hasNegativeMargin && ttmOperatingCF > 0) {
                    // Company generates cash despite negative GAAP op income (common for high-growth companies)
                    const cashMargin = ttmRevenue > 0 ? ttmOperatingCF / ttmRevenue : 0.05;
                    const projectedCashMargin = cashMargin + (0.12 - cashMargin) * (yr / 5); // mean-revert toward 12%
                    fcf = revenue * Math.max(projectedCashMargin, opMargin * 0.70);
                } else if (opIncome > 0) {
                    const fcfRatio = ttmOpIncome > 0 ? clamp(ttmCashFlow / ttmOpIncome, 0.4, 1.0) : 0.70;
                    fcf = opIncome * fcfRatio;
                } else {
                    // Negative FCF ‚Äî discount the loss but floor at a fraction of revenue
                    const fcfRatio = 0.70;
                    fcf = opIncome * fcfRatio; // will be negative
                }

                projections.push({ year: yr, revenue, growth: blendedGrowth, opMargin, opIncome, fcf });
                prevRevenue = revenue;
            }

            // --- STEP 3: WACC ---
            const riskFreeRate = 0.045;
            const equityRiskPremium = 0.055;
            const costOfEquity = riskFreeRate + beta * equityRiskPremium;
            const latestFinancial = quarterly[0];

            // Use long-term debt (financial debt) instead of total liabilities
            // Total liabilities includes accounts payable, deferred revenue, lease obligations, etc.
            // which shouldn't be treated as financial debt in WACC or net debt calculations
            const longTermDebt = latestFinancial.longTermDebt || 0;
            const nonCurrentLiabilities = latestFinancial.nonCurrentLiabilities || 0;
            // Best estimate of financial debt: long-term debt if available, otherwise non-current liabilities
            // Fallback: 40% of total liabilities (industry average for non-financial companies)
            const financialDebt = longTermDebt > 0 ? longTermDebt :
                                  nonCurrentLiabilities > 0 ? nonCurrentLiabilities * 0.70 :
                                  (latestFinancial.liabilities || 0) * 0.40;

            const totalEquity = latestFinancial.equity || 1;
            const debtToEquity = Math.max(financialDebt, 0) / Math.max(totalEquity, 1);
            const debtWeight = debtToEquity / (1 + debtToEquity);
            const equityWeight = 1 - debtWeight;
            const costOfDebt = riskFreeRate + 0.02;
            const taxRate = 0.21;
            const waccCalc = clamp(equityWeight * costOfEquity + debtWeight * costOfDebt * (1 - taxRate), 0.06, 0.15);
            const wacc = overrides.wacc != null ? overrides.wacc : waccCalc;

            // --- STEP 4: Terminal Value ---
            const lastFCF = projections[4].fcf;
            const lastOpIncome = projections[4].opIncome;

            // Guard against negative terminal values
            const tvPerpGrowth = lastFCF > 0
                ? lastFCF * (1 + terminalGrowthRate) / (wacc - terminalGrowthRate)
                : 0; // Don't capitalize negative cash flows into perpetuity
            const exitMultiple = overrides.exitMultiple != null ? overrides.exitMultiple : 15;
            const tvExitMultiple = lastOpIncome > 0 ? lastOpIncome * exitMultiple : 0;

            let terminalValue;
            if (tvPerpGrowth > 0 && tvExitMultiple > 0) {
                terminalValue = (tvPerpGrowth + tvExitMultiple) / 2; // blend both
            } else if (tvPerpGrowth > 0) {
                terminalValue = tvPerpGrowth;
            } else if (tvExitMultiple > 0) {
                terminalValue = tvExitMultiple;
            } else {
                // Both negative ‚Äî company isn't projected to be profitable by Year 5
                // Use revenue multiple as last resort (2x Year 5 revenue as conservative EV)
                terminalValue = projections[4].revenue * 2;
                dcfWarnings.push('Terminal value based on revenue multiple (2x) because projected FCF and operating income remain negative in Year 5.');
            }

            // --- STEP 5: DCF ---
            let pvFCFs = 0;
            projections.forEach(p => { pvFCFs += p.fcf / Math.pow(1 + wacc, p.year); });
            const pvTerminal = terminalValue / Math.pow(1 + wacc, 5);
            const enterpriseValue = pvFCFs + pvTerminal;

            // Estimate cash: use current assets as proxy (includes cash, receivables, inventory)
            // A better proxy is ~50% of current assets for cash + short-term investments
            const currentAssets = latestFinancial.currentAssets || 0;
            const estCash = currentAssets > 0
                ? currentAssets * 0.50
                : (latestFinancial.assets || 0) * 0.10; // fallback

            // Net debt = financial debt - cash (not total liabilities)
            const netDebt = financialDebt - estCash;
            // If net cash position (netDebt < 0), ADD cash to equity value
            const equityValue = enterpriseValue - netDebt;
            const fairValue = sharesOutstanding > 0 ? Math.max(equityValue / sharesOutstanding, 0) : 0;
            const upside = currentPrice > 0 ? ((fairValue - currentPrice) / currentPrice) * 100 : 0;

            if (fairValue <= 0) {
                dcfWarnings.push('DCF model produces a non-positive equity value. This typically occurs for highly leveraged or unprofitable companies. Consider adjusting growth or margin assumptions.');
            }

            let verdict, verdictClass;
            if (upside > 15) { verdict = 'UNDERVALUED'; verdictClass = 'undervalued'; }
            else if (upside > -15) { verdict = 'FAIRLY VALUED'; verdictClass = 'fairly-valued'; }
            else { verdict = 'OVERVALUED'; verdictClass = 'overvalued'; }

            // --- STEP 6: Sensitivity Table ---
            const waccRange = [];
            for (let w = wacc - 0.015; w <= wacc + 0.0151; w += 0.005) waccRange.push(w);
            const growthRange = [0.015, 0.02, 0.025, 0.03, 0.035, 0.04, 0.045];
            const sensTable = waccRange.map(w => growthRange.map(g => {
                // Guard: if lastFCF is negative, perpetuity growth model breaks ‚Äî use exit multiple only
                const tvPerp = lastFCF > 0 ? lastFCF * (1 + g) / (w - g) : 0;
                const tvExit = lastOpIncome > 0 ? tvExitMultiple : 0;
                let tvBlend;
                if (tvPerp > 0 && tvExit > 0) tvBlend = (tvPerp + tvExit) / 2;
                else if (tvPerp > 0) tvBlend = tvPerp;
                else if (tvExit > 0) tvBlend = tvExit;
                else tvBlend = projections[4].revenue * 2; // revenue multiple fallback
                let pv = 0;
                projections.forEach(p => { pv += p.fcf / Math.pow(1 + w, p.year); });
                pv += tvBlend / Math.pow(1 + w, 5);
                const eq = pv - netDebt; // netDebt can be negative (net cash), which adds value
                return sharesOutstanding > 0 ? Math.max(eq / sharesOutstanding, 0) : 0;
            }));

            // --- RENDER ---
            renderDCFOutput(symbol, companyName, currentPrice, marketCap, sharesOutstanding, beta,
                ttmRevenue, ttmOpIncome, ttmNetIncome, ttmCashFlow, avgOpMargin, historicalGrowth,
                projections, wacc, costOfEquity, costOfDebt, equityWeight, debtWeight, riskFreeRate, taxRate,
                tvPerpGrowth, tvExitMultiple, terminalValue, pvFCFs, pvTerminal, enterpriseValue,
                netDebt, equityValue, fairValue, upside, verdict, verdictClass,
                sensTable, waccRange, growthRange, quarterly, dcfWarnings);

        } catch (err) {
            console.error('DCF Error:', err);
            output.innerHTML = `<div class="analysis-error"><i class="fas fa-exclamation-triangle"></i>Error running DCF for ${symbol}: ${err.message}</div>`;
        }
    }

    function renderDCFOutput(symbol, companyName, currentPrice, marketCap, sharesOut, beta,
        ttmRev, ttmOp, ttmNet, ttmFCF, avgMargin, histGrowth,
        projections, wacc, coe, cod, eqW, debtW, rf, taxR,
        tvPerp, tvExit, tv, pvFCFs, pvTV, ev, netDebt, eqVal, fairVal, upside, verdict, verdictClass,
        sensTable, waccRange, growthRange, quarterly, dcfWarnings) {

        const output = document.getElementById('analysisOutput');

        // Historical margin data for chart
        const marginData = quarterly.slice(0, 8).reverse().filter(q => q.revenues > 0).map(q => ({
            label: `${q.fiscalPeriod} ${q.fiscalYear}`,
            margin: (q.operatingIncome / q.revenues) * 100
        }));

        output.innerHTML = `
        <!-- VERDICT -->
        <div class="result-card span-2 verdict-card">
            <div class="verdict-badge ${verdictClass}">${verdict}</div>
            <div class="verdict-price" style="color: ${upside >= 0 ? '#28a745' : '#dc3545'};">${fmtCur(fairVal)}</div>
            <div class="verdict-detail">DCF Fair Value vs Current Price of ${fmtCur(currentPrice)} &mdash; ${fmtPct(upside)} ${upside >= 0 ? 'Upside' : 'Downside'}</div>
        </div>

        ${dcfWarnings && dcfWarnings.length > 0 ? `
        <div class="result-card span-2" style="border-left:3px solid #f0ad4e;background:rgba(240,173,78,0.08);">
            <h3 style="color:#f0ad4e;margin-bottom:0.5rem;"><i class="fas fa-exclamation-triangle"></i> Model Caveats</h3>
            <ul style="margin:0;padding-left:1.2rem;font-size:0.85rem;opacity:0.85;">
                ${dcfWarnings.map(w => `<li style="margin-bottom:0.3rem;">${w}</li>`).join('')}
            </ul>
        </div>` : ''}

        <div class="result-grid">
            <!-- COMPANY OVERVIEW -->
            <div class="result-card">
                <h3><i class="fas fa-building"></i> Company Overview</h3>
                <div class="metrics-row">
                    <div class="metric-item"><div class="metric-label">Ticker</div><div class="metric-value">${symbol}</div></div>
                    <div class="metric-item"><div class="metric-label">Price</div><div class="metric-value">${fmtCur(currentPrice)}</div></div>
                    <div class="metric-item"><div class="metric-label">Market Cap</div><div class="metric-value">${fmtBig(marketCap)}</div></div>
                    <div class="metric-item"><div class="metric-label">Beta</div><div class="metric-value">${fmt(beta)}</div></div>
                </div>
                <table class="val-table">
                    <tr><td>Company</td><td class="highlight">${companyName}</td></tr>
                    <tr><td>Shares Outstanding</td><td>${fmtBig(sharesOut)}</td></tr>
                    <tr><td>TTM Revenue</td><td>${fmtBig(ttmRev)}</td></tr>
                    <tr><td>TTM Operating Income</td><td>${fmtBig(ttmOp)}</td></tr>
                    <tr><td>TTM Net Income</td><td>${fmtBig(ttmNet)}</td></tr>
                    <tr><td>TTM Free Cash Flow</td><td>${fmtBig(ttmFCF)}</td></tr>
                </table>
            </div>

            <!-- WACC -->
            <div class="result-card">
                <h3><i class="fas fa-percentage"></i> WACC Calculation</h3>
                <table class="val-table">
                    <tr><td>Risk-Free Rate (10Y Treasury)</td><td>${fmtPct(rf * 100)}</td></tr>
                    <tr><td>Beta</td><td>${fmt(beta)}</td></tr>
                    <tr><td>Equity Risk Premium</td><td>5.50%</td></tr>
                    <tr><td>Cost of Equity (CAPM)</td><td class="highlight">${fmtPct(coe * 100)}</td></tr>
                    <tr><td>Cost of Debt (est.)</td><td>${fmtPct(cod * 100)}</td></tr>
                    <tr><td>Tax Rate</td><td>${(taxR * 100).toFixed(0)}%</td></tr>
                    <tr><td>Equity Weight</td><td>${fmtPct(eqW * 100)}</td></tr>
                    <tr><td>Debt Weight</td><td>${fmtPct(debtW * 100)}</td></tr>
                    <tr><td style="font-weight:700;border-top:1px solid rgba(255,255,255,0.15);">WACC</td><td class="highlight" style="border-top:1px solid rgba(255,255,255,0.15);">${fmtPct(wacc * 100)}</td></tr>
                </table>
            </div>

            <!-- REVENUE PROJECTIONS -->
            <div class="result-card">
                <h3><i class="fas fa-chart-line"></i> 5-Year Revenue Projection</h3>
                <table class="val-table">
                    <thead><tr><th>Year</th><th>Revenue</th><th>Growth</th><th>Op Margin</th><th>Op Income</th><th>FCF</th></tr></thead>
                    <tbody>
                        <tr><td>Base (TTM)</td><td>${fmtBig(ttmRev)}</td><td>-</td><td>${(avgMargin * 100).toFixed(1)}%</td><td>${fmtBig(ttmOp)}</td><td>${fmtBig(ttmFCF)}</td></tr>
                        ${projections.map(p => `<tr>
                            <td>Year ${p.year}</td>
                            <td>${fmtBig(p.revenue)}</td>
                            <td class="${p.growth >= 0 ? 'positive' : 'negative'}">${fmtPct(p.growth * 100)}</td>
                            <td>${(p.opMargin * 100).toFixed(1)}%</td>
                            <td>${fmtBig(p.opIncome)}</td>
                            <td>${fmtBig(p.fcf)}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
                <div class="chart-box"><canvas id="revenueChart"></canvas></div>
            </div>

            <!-- OPERATING MARGIN TREND -->
            <div class="result-card">
                <h3><i class="fas fa-chart-area"></i> Operating Margin Trend</h3>
                <div class="chart-box"><canvas id="marginChart"></canvas></div>
            </div>

            <!-- TERMINAL VALUE -->
            <div class="result-card">
                <h3><i class="fas fa-infinity"></i> Terminal Value & DCF Bridge</h3>
                <table class="val-table">
                    <tr><td>Terminal Value (Perpetuity Growth @ ${(0.03 * 100).toFixed(1)}%)</td><td>${fmtBig(tvPerp)}</td></tr>
                    <tr><td>Terminal Value (Exit Multiple @ ${15}x Op Income)</td><td>${fmtBig(tvExit)}</td></tr>
                    <tr><td>Blended Terminal Value</td><td class="highlight">${fmtBig(tv)}</td></tr>
                    <tr style="border-top:1px solid rgba(255,255,255,0.15);"><td>PV of Projected FCFs</td><td>${fmtBig(pvFCFs)}</td></tr>
                    <tr><td>PV of Terminal Value</td><td>${fmtBig(pvTV)}</td></tr>
                    <tr><td style="font-weight:700;">Enterprise Value</td><td class="highlight">${fmtBig(ev)}</td></tr>
                    <tr><td>${netDebt >= 0 ? 'Less: Net Debt' : 'Plus: Net Cash'}</td><td>${netDebt >= 0 ? '(' + fmtBig(netDebt) + ')' : fmtBig(Math.abs(netDebt))}</td></tr>
                    <tr><td style="font-weight:700;">Equity Value</td><td class="highlight">${fmtBig(eqVal)}</td></tr>
                    <tr><td style="font-weight:700;">Fair Value Per Share</td><td class="highlight" style="font-size:1.1rem;">${fmtCur(fairVal)}</td></tr>
                </table>
                <div class="chart-box"><canvas id="bridgeChart"></canvas></div>
            </div>

            <!-- SENSITIVITY TABLE -->
            <div class="result-card span-2">
                <h3><i class="fas fa-th"></i> Sensitivity Analysis ‚Äî Fair Value per Share</h3>
                <p style="font-size:0.8rem;opacity:0.6;margin-bottom:1rem;">Rows = Discount Rate (WACC) &nbsp;|&nbsp; Columns = Terminal Growth Rate</p>
                <div style="overflow-x:auto;">
                    <table class="sensitivity-table">
                        <thead><tr><th>WACC \\ Growth</th>${growthRange.map(g => `<th>${(g * 100).toFixed(1)}%</th>`).join('')}</tr></thead>
                        <tbody>
                            ${sensTable.map((row, ri) => {
                                const isCurrentWacc = Math.abs(waccRange[ri] - wacc) < 0.001;
                                return `<tr>${[`<th>${(waccRange[ri] * 100).toFixed(1)}%</th>`, ...row.map((val, ci) => {
                                    const pctDiff = currentPrice > 0 ? ((val - currentPrice) / currentPrice) * 100 : 0;
                                    let cls = 'cell-yellow';
                                    if (pctDiff > 20) cls = 'cell-green';
                                    else if (pctDiff > 5) cls = 'cell-light-green';
                                    else if (pctDiff > -5) cls = 'cell-yellow';
                                    else if (pctDiff > -20) cls = 'cell-orange';
                                    else cls = 'cell-red';
                                    const isCurrent = isCurrentWacc && Math.abs(growthRange[ci] - 0.03) < 0.001;
                                    return `<td class="${cls}${isCurrent ? ' current-cell' : ''}">${fmtCur(val)}</td>`;
                                })].join('')}</tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ASSUMPTIONS -->
        <div class="assumptions-box">
            <h4><i class="fas fa-info-circle"></i> Key Assumptions & Model Risks</h4>
            <ul>
                <li>Revenue growth decays linearly from ${(histGrowth * 100).toFixed(1)}% historical to 3.0% terminal over 5 years</li>
                <li>Operating margins mean-revert mildly toward 15% sector median</li>
                <li>FCF conversion ratio based on historical Operating Income to Cash Flow relationship</li>
                <li>WACC uses CAPM with 4.5% risk-free rate and 5.5% equity risk premium</li>
                <li>Terminal value is average of perpetuity growth (3%) and 15x exit multiple methods</li>
                <li>Net debt estimated from balance sheet; actual cash position may differ</li>
                <li>Model does not account for one-time items, M&A, or capital structure changes</li>
            </ul>
        </div>

        <!-- DOWNLOAD CSV -->
        <button class="run-btn" onclick="downloadModelCSV('dcf')" style="margin-top:1rem;background:linear-gradient(135deg,#28a745,#20c997);width:100%;">
            <i class="fas fa-download"></i> Download DCF Analysis CSV
        </button>`;

        // --- STORE CSV DATA ---
        storeAnalysisData('dcf', {
            modelName: 'DCF Valuation',
            firmStyle: 'Morgan Stanley Style',
            runDate: new Date().toISOString(),
            ticker: symbol,
            sections: [
                { title: 'Valuation Summary', type: 'metrics', rows: [
                    { label: 'Current Price', formatted: fmtCur(currentPrice), formula: 'Polygon.io quote (prevClose fallback)' },
                    { label: 'DCF Fair Value', formatted: fmtCur(fairVal), formula: 'Equity Value / Shares Outstanding' },
                    { label: 'Upside/Downside', formatted: fmtPct(upside), formula: '(Fair Value - Current Price) / Current Price' },
                    { label: 'Verdict', formatted: upside > 15 ? 'UNDERVALUED' : upside < -15 ? 'OVERVALUED' : 'FAIRLY VALUED' }
                ]},
                { title: 'WACC Inputs', type: 'metrics', rows: [
                    { label: 'Risk-Free Rate', formatted: fmtPct(rf * 100), formula: '10-Year US Treasury yield' },
                    { label: 'Beta', formatted: fmt(beta), formula: 'Market data' },
                    { label: 'Equity Risk Premium', formatted: '5.50%', formula: 'Historical average' },
                    { label: 'Cost of Equity (CAPM)', formatted: fmtPct(coe * 100), formula: 'Rf + Œ≤ √ó ERP' },
                    { label: 'Cost of Debt', formatted: fmtPct(cod * 100), formula: 'Estimated from interest coverage' },
                    { label: 'Tax Rate', formatted: (taxR * 100).toFixed(0) + '%' },
                    { label: 'WACC', formatted: fmtPct(wacc * 100), formula: 'E/(E+D) √ó CoE + D/(E+D) √ó CoD √ó (1-t)' }
                ]},
                { title: '5-Year Revenue Projections', type: 'table',
                  headers: ['Year', 'Revenue', 'Growth', 'Op Margin', 'Op Income', 'FCF'],
                  rows: [['Base (TTM)', fmtBig(ttmRev), '-', (avgMargin * 100).toFixed(1) + '%', fmtBig(ttmOp), fmtBig(ttmFCF)],
                    ...projections.map(p => ['Year ' + p.year, fmtBig(p.revenue), fmtPct(p.growth * 100), (p.opMargin * 100).toFixed(1) + '%', fmtBig(p.opIncome), fmtBig(p.fcf)])]
                },
                { title: 'Terminal Value & Equity Value', type: 'metrics', rows: [
                    { label: 'Terminal Value (Perpetuity Growth)', formatted: fmtBig(tvPerp), formula: 'FCF‚ÇÖ √ó (1+g) / (WACC-g), g=3%' },
                    { label: 'Terminal Value (Exit Multiple)', formatted: fmtBig(tvExit), formula: 'Year 5 Op Income √ó 15x' },
                    { label: 'Blended Terminal Value', formatted: fmtBig(tv), formula: 'Average of both methods' },
                    { label: 'PV of Projected FCFs', formatted: fmtBig(pvFCFs) },
                    { label: 'PV of Terminal Value', formatted: fmtBig(pvTV) },
                    { label: 'Enterprise Value', formatted: fmtBig(ev), formula: 'PV(FCFs) + PV(TV)' },
                    { label: netDebt >= 0 ? 'Less: Net Debt' : 'Plus: Net Cash', formatted: netDebt >= 0 ? '(' + fmtBig(netDebt) + ')' : fmtBig(Math.abs(netDebt)) },
                    { label: 'Equity Value', formatted: fmtBig(eqVal) },
                    { label: 'Shares Outstanding', formatted: fmtBig(sharesOut) },
                    { label: 'Fair Value Per Share', formatted: fmtCur(fairVal) }
                ]},
                { title: 'Sensitivity Table (Fair Value by WACC √ó Growth Rate)', type: 'table',
                  headers: ['WACC \\ Growth', ...growthRange.map(g => (g * 100).toFixed(1) + '%')],
                  rows: sensTable.map((row, ri) => [(waccRange[ri] * 100).toFixed(1) + '%', ...row.map(v => fmtCur(v))])
                },
                { title: 'Raw Quarterly Financial Data', type: 'table',
                  headers: ['Period', 'Filing Date', 'Revenue', 'Gross Profit', 'Op Income', 'Net Income', 'Cash Flow', 'Total Assets', 'Equity', 'Liabilities'],
                  rows: quarterly.slice(0, 8).map(q => [
                      (q.fiscalPeriod || '') + ' ' + (q.fiscalYear || ''),
                      q.filingDate || q.date || '',
                      q.revenues || 0,
                      q.grossProfit || 0,
                      q.operatingIncome || 0,
                      q.netIncome || 0,
                      q.cashFlow || 0,
                      q.assets || 0,
                      q.equity || 0,
                      q.liabilities || 0
                  ])
                }
            ]
        });

        // --- RENDER CHARTS ---
        setTimeout(() => {
            // Revenue projection chart
            const revCtx = document.getElementById('revenueChart');
            if (revCtx) {
                chartInstances.revenue = new Chart(revCtx.getContext('2d'), {
                    type: 'bar', data: {
                        labels: ['TTM', ...projections.map(p => `Yr ${p.year}`)],
                        datasets: [{
                            label: 'Revenue', data: [ttmRev, ...projections.map(p => p.revenue)],
                            backgroundColor: 'rgba(254,188,17,0.3)', borderColor: '#febc11', borderWidth: 1
                        }, {
                            label: 'Free Cash Flow', data: [ttmFCF, ...projections.map(p => p.fcf)],
                            backgroundColor: 'rgba(40,167,69,0.3)', borderColor: '#28a745', borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#e5e5e5' } } },
                        scales: { x: { ticks: { color: '#aaa' }, grid: { display: false } }, y: { ticks: { color: '#aaa', callback: v => fmtBig(v) }, grid: { color: 'rgba(255,255,255,0.05)' } } }
                    }
                });
            }

            // Margin chart
            const marginCtx = document.getElementById('marginChart');
            if (marginCtx && marginData.length > 0) {
                const projMargins = projections.map(p => ({ label: `Yr ${p.year} (Proj)`, margin: p.opMargin * 100 }));
                const allMargins = [...marginData, ...projMargins];
                chartInstances.margin = new Chart(marginCtx.getContext('2d'), {
                    type: 'line', data: {
                        labels: allMargins.map(m => m.label),
                        datasets: [{
                            label: 'Operating Margin %', data: allMargins.map(m => m.margin),
                            borderColor: '#febc11', backgroundColor: 'rgba(254,188,17,0.1)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#febc11'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#e5e5e5' } } },
                        scales: { x: { ticks: { color: '#aaa', maxRotation: 45 }, grid: { display: false } }, y: { ticks: { color: '#aaa', callback: v => v.toFixed(1) + '%' }, grid: { color: 'rgba(255,255,255,0.05)' } } }
                    }
                });
            }

            // Bridge chart (waterfall-style bar)
            const bridgeCtx = document.getElementById('bridgeChart');
            if (bridgeCtx) {
                chartInstances.bridge = new Chart(bridgeCtx.getContext('2d'), {
                    type: 'bar', data: {
                        labels: ['PV of FCFs', 'PV of Terminal Value', 'Enterprise Value', 'Less Net Debt', 'Equity Value'],
                        datasets: [{
                            data: [pvFCFs, pvTV, ev, -Math.max(netDebt, 0), eqVal],
                            backgroundColor: ['rgba(254,188,17,0.4)', 'rgba(77,171,247,0.4)', 'rgba(254,188,17,0.6)', 'rgba(220,53,69,0.4)', 'rgba(40,167,69,0.5)'],
                            borderColor: ['#febc11', '#4dabf7', '#febc11', '#dc3545', '#28a745'], borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                        scales: { x: { ticks: { color: '#aaa' }, grid: { display: false } }, y: { ticks: { color: '#aaa', callback: v => fmtBig(v) }, grid: { color: 'rgba(255,255,255,0.05)' } } }
                    }
                });
            }
        }, 100);
    }

    // ============================================================
    // RISK ASSESSMENT ENGINE
    // ============================================================
    async function runRiskAssessment() {
        const output = document.getElementById('analysisOutput');
        output.innerHTML = '<div class="analysis-loading"><div class="spinner"></div><br>Running portfolio risk analysis across ' + equityHoldings.length + ' holdings...</div>';

        try {
            const symbols = equityHoldings.map(h => h.symbol);

            // Fetch correlation + analytics in parallel
            const [corrRes, ...analyticsResults] = await Promise.all([
                fetch(`${apiBaseURL}/api/portfolio/correlation`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols })
                }).then(r => r.json()),
                ...symbols.map(s => fetch(`${apiBaseURL}/api/stock/${s}/analytics`).then(r => r.json()).catch(() => ({})))
            ]);

            const corrMatrix = corrRes.correlationMatrix || [];
            const analyticsMap = {};
            symbols.forEach((s, i) => { analyticsMap[s] = analyticsResults[i]?.analytics || analyticsResults[i] || {}; });

            // Portfolio weights
            const totalValue = equityHoldings.reduce((s, h) => s + h.quantity * h.lastPrice, 0);
            const holdings = equityHoldings.map((h, i) => {
                const mv = h.quantity * h.lastPrice;
                const w = mv / totalValue;
                const a = analyticsMap[h.symbol] || {};
                return { ...h, marketValue: mv, weight: w, beta: a.beta || 1.0, volatility: a.volatility || 0.25, high52: a.high52Week, low52: a.low52Week };
            });

            // --- Portfolio Beta ---
            const portfolioBeta = holdings.reduce((s, h) => s + h.weight * h.beta, 0);

            // --- Portfolio Volatility (using full covariance) ---
            let portfolioVariance = 0;
            for (let i = 0; i < holdings.length; i++) {
                for (let j = 0; j < holdings.length; j++) {
                    const corr = corrMatrix[i] && corrMatrix[j] ? (corrMatrix[i][j] || 0) : (i === j ? 1 : 0);
                    portfolioVariance += holdings[i].weight * holdings[j].weight * corr * holdings[i].volatility * holdings[j].volatility;
                }
            }
            const portfolioVol = Math.sqrt(Math.max(portfolioVariance, 0));

            // --- Sector Concentration ---
            const sectorWeights = {};
            holdings.forEach(h => {
                const sec = h.gicsSector || 'Other';
                sectorWeights[sec] = (sectorWeights[sec] || 0) + h.weight;
            });
            const hhi = Object.values(sectorWeights).reduce((s, w) => s + Math.pow(w * 100, 2), 0);
            let hhiLabel, hhiClass;
            if (hhi < 1500) { hhiLabel = 'Diversified'; hhiClass = 'risk-low'; }
            else if (hhi < 2500) { hhiLabel = 'Moderate'; hhiClass = 'risk-medium'; }
            else { hhiLabel = 'Concentrated'; hhiClass = 'risk-high'; }

            // --- Recession Stress Test ---
            const recessionDrawdowns = {
                'Information Technology': -0.35, 'Consumer Discretionary': -0.40,
                'Communication Services': -0.30, 'Financials': -0.45,
                'Health Care': -0.20, 'Industrials': -0.35, 'Energy': -0.45,
                'Consumer Staples': -0.15, 'Materials': -0.35, 'Real Estate': -0.30, 'Utilities': -0.15
            };
            const stressResults = holdings.map(h => {
                const sectorDraw = recessionDrawdowns[h.gicsSector] || -0.30;
                const adjDraw = sectorDraw * clamp(h.beta, 0.5, 2.0);
                const stressedVal = h.marketValue * (1 + adjDraw);
                return { ...h, sectorDrawdown: sectorDraw, adjustedDrawdown: adjDraw, stressedValue: stressedVal, loss: h.marketValue * adjDraw };
            });
            const totalStressedValue = stressResults.reduce((s, h) => s + h.stressedValue, 0);
            const portfolioDrawdown = (totalStressedValue - totalValue) / totalValue;

            // --- VaR ---
            const dailyVol = portfolioVol / Math.sqrt(252);
            const var95 = totalValue * 1.645 * dailyVol;
            const var99 = totalValue * 2.326 * dailyVol;
            const cvar95 = var95 * 1.25;

            // --- Risk Parity Weights ---
            const totalInvVol = holdings.reduce((s, h) => s + 1 / Math.max(h.volatility, 0.05), 0);
            const riskParityWeights = holdings.map(h => (1 / Math.max(h.volatility, 0.05)) / totalInvVol);

            // --- Risk Scores ---
            const avgCorrelations = holdings.map((h, i) => {
                if (!corrMatrix[i]) return 0.5;
                const others = corrMatrix[i].filter((_, j) => j !== i);
                return others.length > 0 ? others.reduce((s, c) => s + Math.abs(c), 0) / others.length : 0.5;
            });

            const riskScores = holdings.map((h, i) => {
                let score = 0;
                score += h.beta > 1.5 ? 3 : h.beta > 1.0 ? 2 : 1;
                score += h.volatility > 0.40 ? 3 : h.volatility > 0.25 ? 2 : 1;
                score += h.weight > 0.10 ? 2 : h.weight > 0.05 ? 1 : 0;
                score += avgCorrelations[i] > 0.7 ? 2 : avgCorrelations[i] > 0.4 ? 1 : 0;
                return Math.min(10, Math.max(1, score));
            });

            // --- RENDER ---
            renderRiskOutput(symbols, holdings, corrMatrix, portfolioBeta, portfolioVol, totalValue,
                sectorWeights, hhi, hhiLabel, hhiClass, stressResults, portfolioDrawdown,
                var95, var99, cvar95, riskParityWeights, riskScores, avgCorrelations);

        } catch (err) {
            console.error('Risk Assessment Error:', err);
            output.innerHTML = `<div class="analysis-error"><i class="fas fa-exclamation-triangle"></i>Error running risk assessment: ${err.message}</div>`;
        }
    }

    function renderRiskOutput(symbols, holdings, corrMatrix, pBeta, pVol, totalVal,
        sectorWeights, hhi, hhiLabel, hhiClass, stressResults, pDrawdown,
        var95, var99, cvar95, rpWeights, riskScores, avgCorr) {

        const output = document.getElementById('analysisOutput');
        const sortedSectors = Object.entries(sectorWeights).sort((a, b) => b[1] - a[1]);

        output.innerHTML = `
        <!-- PORTFOLIO OVERVIEW -->
        <div class="metrics-row">
            <div class="metric-item"><div class="metric-label">Holdings</div><div class="metric-value">${holdings.length}</div></div>
            <div class="metric-item"><div class="metric-label">Portfolio Value</div><div class="metric-value">${fmtBig(totalVal)}</div></div>
            <div class="metric-item"><div class="metric-label">Portfolio Beta</div><div class="metric-value">${fmt(pBeta)}</div></div>
            <div class="metric-item"><div class="metric-label">Annual Volatility</div><div class="metric-value">${(pVol * 100).toFixed(1)}%</div></div>
            <div class="metric-item"><div class="metric-label">Daily VaR (95%)</div><div class="metric-value" style="color:#dc3545;">${fmtCur(var95)}</div></div>
            <div class="metric-item"><div class="metric-label">HHI Concentration</div><div class="metric-value"><span class="risk-badge ${hhiClass}">${hhiLabel}</span></div><div class="metric-sub">${fmt(hhi, 0)}</div></div>
        </div>

        <div class="result-grid">
            <!-- CORRELATION HEAT MAP -->
            <div class="result-card span-2">
                <h3><i class="fas fa-th"></i> Correlation Matrix (90-Day Rolling)</h3>
                <div class="heat-map-container">
                    <table class="heat-map">
                        <thead><tr><th></th>${symbols.map(s => `<th>${s}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${symbols.map((s, i) => `<tr><th>${s}</th>${symbols.map((_, j) => {
                                const val = corrMatrix[i] ? corrMatrix[i][j] || 0 : 0;
                                const abs = Math.abs(val);
                                let bg;
                                if (i === j) bg = 'rgba(254,188,17,0.2)';
                                else if (val > 0.7) bg = 'rgba(220,53,69,0.35)';
                                else if (val > 0.4) bg = 'rgba(253,126,20,0.25)';
                                else if (val > 0) bg = 'rgba(255,193,7,0.15)';
                                else bg = 'rgba(40,167,69,0.2)';
                                return `<td style="background:${bg}">${val.toFixed(2)}</td>`;
                            }).join('')}</tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SECTOR CONCENTRATION -->
            <div class="result-card">
                <h3><i class="fas fa-chart-pie"></i> Sector Concentration</h3>
                <table class="val-table">
                    <thead><tr>
                        <th data-valcol="0" onclick="sortValTable('sectorConcBody',0)" style="cursor:pointer;">Sector<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="1" onclick="sortValTable('sectorConcBody',1)" style="cursor:pointer;">Weight<span class="val-sort-arrow"> ‚Üì</span></th>
                        <th data-valcol="2" onclick="sortValTable('sectorConcBody',2)" style="cursor:pointer;">Holdings<span class="val-sort-arrow"> ‚Üï</span></th>
                    </tr></thead>
                    <tbody id="sectorConcBody">
                        ${sortedSectors.map(([sec, w]) => {
                            const cnt = holdings.filter(h => h.gicsSector === sec).length;
                            const barW = Math.min(w * 100 / sortedSectors[0][1] * 100, 100);
                            return `<tr><td>${sec}</td><td><div style="display:flex;align-items:center;gap:0.5rem;"><span>${(w*100).toFixed(1)}%</span><div style="flex:1;height:6px;background:rgba(255,255,255,0.06);border-radius:3px;"><div style="height:100%;width:${barW}%;background:#febc11;border-radius:3px;"></div></div></div></td><td>${cnt}</td></tr>`;
                        }).join('')}
                    </tbody>
                </table>
                <div class="chart-box"><canvas id="sectorPieChart"></canvas></div>
            </div>

            <!-- BETA vs VOLATILITY SCATTER -->
            <div class="result-card">
                <h3><i class="fas fa-crosshairs"></i> Beta vs Volatility Map</h3>
                <div class="chart-box tall"><canvas id="scatterChart"></canvas></div>
            </div>

            <!-- STRESS TEST -->
            <div class="result-card span-2">
                <h3><i class="fas fa-bolt"></i> Recession Stress Test</h3>
                <div class="metrics-row" style="margin-bottom:1rem;">
                    <div class="metric-item"><div class="metric-label">Portfolio Drawdown</div><div class="metric-value" style="color:#dc3545;">${(pDrawdown * 100).toFixed(1)}%</div></div>
                    <div class="metric-item"><div class="metric-label">Stressed Value</div><div class="metric-value">${fmtBig(stressResults.reduce((s,h) => s+h.stressedValue, 0))}</div></div>
                    <div class="metric-item"><div class="metric-label">Est. Loss</div><div class="metric-value" style="color:#dc3545;">${fmtBig(totalVal * pDrawdown)}</div></div>
                </div>
                <table class="val-table">
                    <thead><tr>
                        <th data-valcol="0" onclick="sortValTable('stressBody',0)" style="cursor:pointer;">Symbol<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="1" onclick="sortValTable('stressBody',1)" style="cursor:pointer;">Sector<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="2" onclick="sortValTable('stressBody',2)" style="cursor:pointer;">Weight<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="3" onclick="sortValTable('stressBody',3)" style="cursor:pointer;">Beta<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="4" onclick="sortValTable('stressBody',4)" style="cursor:pointer;">Sector Draw<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="5" onclick="sortValTable('stressBody',5)" style="cursor:pointer;">Adj. Draw<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="6" onclick="sortValTable('stressBody',6)" style="cursor:pointer;">Current Value<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="7" onclick="sortValTable('stressBody',7)" style="cursor:pointer;">Stressed Value<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="8" onclick="sortValTable('stressBody',8)" style="cursor:pointer;">Est. Loss<span class="val-sort-arrow"> ‚Üì</span></th>
                    </tr></thead>
                    <tbody id="stressBody">
                        ${stressResults.sort((a,b) => a.loss - b.loss).map(h => `<tr>
                            <td class="highlight">${h.symbol}</td><td>${h.gicsSector}</td>
                            <td>${(h.weight * 100).toFixed(1)}%</td><td>${fmt(h.beta)}</td>
                            <td class="negative">${(h.sectorDrawdown * 100).toFixed(0)}%</td>
                            <td class="negative">${(h.adjustedDrawdown * 100).toFixed(1)}%</td>
                            <td>${fmtCur(h.marketValue)}</td><td>${fmtCur(h.stressedValue)}</td>
                            <td class="negative">${fmtCur(Math.abs(h.loss))}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>

            <!-- TAIL RISK -->
            <div class="result-card">
                <h3><i class="fas fa-exclamation-triangle"></i> Tail Risk (Value at Risk)</h3>
                <table class="val-table">
                    <tr><td>Daily VaR (95%)</td><td class="negative">${fmtCur(var95)}</td></tr>
                    <tr><td>Daily VaR (99%)</td><td class="negative">${fmtCur(var99)}</td></tr>
                    <tr><td>Expected Shortfall (CVaR 95%)</td><td class="negative">${fmtCur(cvar95)}</td></tr>
                    <tr><td>Annual Vol</td><td>${(pVol * 100).toFixed(1)}%</td></tr>
                    <tr><td>Max 1-Day Loss (est. 3-sigma)</td><td class="negative">${fmtCur(totalVal * 3 * pVol / Math.sqrt(252))}</td></tr>
                </table>
                <div class="assumptions-box" style="margin-top:1rem;">
                    <h4>Methodology</h4>
                    <ul>
                        <li>Parametric VaR assuming normal distribution of returns</li>
                        <li>CVaR estimated as 1.25x VaR (normal approximation)</li>
                        <li>Portfolio volatility computed from full covariance matrix</li>
                    </ul>
                </div>
            </div>

            <!-- POSITION SIZING -->
            <div class="result-card">
                <h3><i class="fas fa-balance-scale"></i> Risk Parity vs Current Weights</h3>
                <table class="val-table">
                    <thead><tr>
                        <th data-valcol="0" onclick="sortValTable('riskParityBody',0)" style="cursor:pointer;">Symbol<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="1" onclick="sortValTable('riskParityBody',1)" style="cursor:pointer;">Current<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="2" onclick="sortValTable('riskParityBody',2)" style="cursor:pointer;">Risk Parity<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="3" onclick="sortValTable('riskParityBody',3)" style="cursor:pointer;">Delta<span class="val-sort-arrow"> ‚Üï</span></th>
                        <th data-valcol="4" onclick="sortValTable('riskParityBody',4)" style="cursor:pointer;">Risk Score<span class="val-sort-arrow"> ‚Üï</span></th>
                    </tr></thead>
                    <tbody id="riskParityBody">
                        ${holdings.map((h, i) => {
                            const delta = rpWeights[i] - h.weight;
                            const score = riskScores[i];
                            const scoreClass = score <= 3 ? 'risk-low' : score <= 6 ? 'risk-medium' : 'risk-high';
                            return `<tr>
                                <td class="highlight">${h.symbol}</td>
                                <td>${(h.weight * 100).toFixed(1)}%</td>
                                <td>${(rpWeights[i] * 100).toFixed(1)}%</td>
                                <td class="${delta >= 0 ? 'positive' : 'negative'}">${(delta > 0 ? '+' : '') + (delta * 100).toFixed(1)}%</td>
                                <td><span class="risk-badge ${scoreClass}">${score}/10</span></td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="assumptions-box">
            <h4><i class="fas fa-info-circle"></i> Risk Assessment Methodology</h4>

            <h4 style="margin-top:1rem;color:#febc11;font-size:0.85rem;">Recession Stress Test ‚Äî How It Works</h4>
            <p style="font-size:0.8rem;color:rgba(255,255,255,0.65);line-height:1.6;margin:0.5rem 0;">
                The stress test estimates portfolio losses under a recession scenario using a <strong>sector-based drawdown model</strong>:
            </p>
            <ol style="font-size:0.8rem;color:rgba(255,255,255,0.6);line-height:1.7;padding-left:1.2rem;margin:0.5rem 0;">
                <li><strong>Historical Sector Drawdowns</strong> ‚Äî Each GICS sector is assigned a typical recession drawdown based on historical recessions (2008-09, 2020):
                    Tech ‚àí35%, Consumer Disc ‚àí40%, Comm Services ‚àí30%, Financials ‚àí45%, Health Care ‚àí20%, Industrials ‚àí35%, Energy ‚àí45%, Consumer Staples ‚àí15%, Materials ‚àí35%, Real Estate ‚àí30%, Utilities ‚àí15%</li>
                <li><strong>Beta Adjustment</strong> ‚Äî Each holding's sector drawdown is multiplied by its beta (clamped 0.5‚Äì2.0). Higher-beta stocks get larger drawdowns: <code>Adjusted Drawdown = Sector Drawdown √ó clamp(Œ≤, 0.5, 2.0)</code></li>
                <li><strong>Stressed Value</strong> ‚Äî <code>Stressed Value = Current Value √ó (1 + Adjusted Drawdown)</code></li>
                <li><strong>Portfolio Impact</strong> ‚Äî Sum of all stressed values vs total current value gives the overall portfolio drawdown estimate</li>
            </ol>

            <h4 style="margin-top:1rem;color:#febc11;font-size:0.85rem;">To Verify These Results</h4>
            <ol style="font-size:0.8rem;color:rgba(255,255,255,0.6);line-height:1.7;padding-left:1.2rem;margin:0.5rem 0;">
                <li>Download the CSV and open in Excel</li>
                <li>Find each holding's sector drawdown in the "Stress Test Results" table</li>
                <li>Multiply by the holding's beta to get Adjusted Drawdown</li>
                <li>Multiply Current Value √ó (1 + Adjusted Drawdown) to get Stressed Value</li>
                <li>Sum all Stressed Values and divide by Total Portfolio Value for the portfolio drawdown</li>
            </ol>

            <h4 style="margin-top:1rem;color:#febc11;font-size:0.85rem;">Other Metrics</h4>
            <ul style="font-size:0.8rem;color:rgba(255,255,255,0.6);line-height:1.7;">
                <li><strong>Correlation Matrix</strong> ‚Äî Computed from 90 days of daily returns via Polygon.io; values near 1.0 mean holdings move together</li>
                <li><strong>VaR (Value at Risk)</strong> ‚Äî Estimates maximum daily loss at 95%/99% confidence: <code>VaR = Portfolio Value √ó z-score √ó Daily Volatility</code>. Uses z=1.645 (95%) and z=2.326 (99%). Assumes normally distributed returns; actual tail risk may be higher</li>
                <li><strong>CVaR (Conditional VaR)</strong> ‚Äî Expected loss beyond VaR threshold, estimated as <code>1.25 √ó VaR(95%)</code></li>
                <li><strong>HHI (Herfindahl-Hirschman Index)</strong> ‚Äî Sum of squared portfolio weights √ó 10,000. Under 1500 = Diversified, 1500-2500 = Moderate, above 2500 = Concentrated</li>
                <li><strong>Risk Parity Weights</strong> ‚Äî Proportional to inverse annualized volatility: <code>w_i = (1/œÉ_i) / Œ£(1/œÉ_j)</code>. Equalizes each holding's risk contribution</li>
                <li><strong>Risk Score (1-10)</strong> ‚Äî Composite of beta (2.5 pts), volatility (2.5 pts), concentration (2.5 pts), and average correlation (2.5 pts)</li>
            </ul>
        </div>

        <!-- DOWNLOAD CSV -->
        <button class="run-btn" onclick="downloadModelCSV('risk')" style="margin-top:1rem;background:linear-gradient(135deg,#28a745,#20c997);width:100%;">
            <i class="fas fa-download"></i> Download Risk Assessment CSV
        </button>`;

        // --- STORE CSV DATA ---
        storeAnalysisData('risk', {
            modelName: 'Portfolio Risk Assessment',
            firmStyle: 'Bridgewater Style',
            runDate: new Date().toISOString(),
            ticker: 'PORTFOLIO',
            sections: [
                { title: 'Portfolio Risk Summary', type: 'metrics', rows: [
                    { label: 'Number of Holdings', formatted: holdings.length.toString() },
                    { label: 'Portfolio Value', formatted: fmtBig(totalVal) },
                    { label: 'Portfolio Beta', formatted: fmt(pBeta) },
                    { label: 'Annual Volatility', formatted: (pVol * 100).toFixed(1) + '%' },
                    { label: 'Daily VaR (95%)', formatted: fmtCur(var95) },
                    { label: 'Daily VaR (99%)', formatted: fmtCur(var99) },
                    { label: 'CVaR (95%)', formatted: fmtCur(cvar95) },
                    { label: 'HHI Concentration', formatted: fmt(hhi, 0) + ' (' + hhiLabel + ')' },
                    { label: 'Recession Drawdown Est.', formatted: (pDrawdown * 100).toFixed(1) + '%' }
                ]},
                { title: 'Sector Weights', type: 'table',
                  headers: ['Sector', 'Weight'],
                  rows: sortedSectors.map(s => [s[0], (s[1] * 100).toFixed(1) + '%'])
                },
                { title: 'Holdings Risk Detail', type: 'table',
                  headers: ['Symbol', 'Weight', 'Beta', 'Volatility', 'Avg Correlation', 'Risk Score'],
                  rows: holdings.map((h, i) => [h.symbol, (h.weight * 100).toFixed(1) + '%', fmt(h.beta), (h.volatility * 100).toFixed(1) + '%', fmt(avgCorr[i]), riskScores[i] + '/10'])
                },
                { title: 'Stress Test Results', type: 'table',
                  headers: ['Symbol', 'Sector', 'Beta', 'Sector Drawdown', 'Adj Drawdown', 'Current Value', 'Stressed Value', 'Est Loss'],
                  rows: stressResults.map(h => [h.symbol, h.gicsSector, fmt(h.beta), (h.sectorDrawdown * 100).toFixed(0) + '%', (h.adjustedDrawdown * 100).toFixed(1) + '%', fmtCur(h.marketValue), fmtCur(h.stressedValue), fmtCur(Math.abs(h.loss))])
                },
                { title: 'Risk Parity Weights', type: 'table',
                  headers: ['Symbol', 'Current Weight', 'Risk Parity Weight', 'Delta'],
                  rows: holdings.map((h, i) => [h.symbol, (h.weight * 100).toFixed(1) + '%', (rpWeights[i] * 100).toFixed(1) + '%', ((rpWeights[i] - h.weight) * 100).toFixed(1) + '%'])
                },
                { title: 'Correlation Matrix', type: 'matrix',
                  headers: ['', ...holdings.map(h => h.symbol)],
                  rows: holdings.map((h, i) => [h.symbol, ...holdings.map((_, j) => corrMatrix[i] && corrMatrix[i][j] != null ? corrMatrix[i][j].toFixed(3) : 'N/A')])
                },
                { title: 'Raw Holdings Data', type: 'table',
                  headers: ['Symbol', 'Description', 'Sector', 'Quantity', 'Last Price', 'Market Value', 'Weight %', 'Beta', 'Ann. Volatility %'],
                  rows: holdings.map(h => [h.symbol, h.description || '', h.gicsSector || '', h.quantity || 0, h.lastPrice || 0, (h.lastPrice * h.quantity).toFixed(2), (h.weight * 100).toFixed(2), h.beta || 'N/A', h.volatility ? (h.volatility * 100).toFixed(2) : 'N/A'])
                }
            ]
        });

        // --- RENDER CHARTS ---
        setTimeout(() => {
            // Sector pie chart
            const pieCtx = document.getElementById('sectorPieChart');
            if (pieCtx) {
                const sectorColors = ['#febc11', '#4dabf7', '#28a745', '#dc3545', '#fd7e14', '#20c997', '#6f42c1', '#e83e8c', '#17a2b8', '#ffc107', '#adb5bd'];
                chartInstances.sectorPie = new Chart(pieCtx.getContext('2d'), {
                    type: 'doughnut', data: {
                        labels: sortedSectors.map(s => s[0]),
                        datasets: [{ data: sortedSectors.map(s => (s[1] * 100).toFixed(1)), backgroundColor: sectorColors.slice(0, sortedSectors.length), borderWidth: 2, borderColor: '#0f1419' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#e5e5e5', boxWidth: 12, font: { size: 10 } } } } }
                });
            }

            // Scatter chart
            const scatterCtx = document.getElementById('scatterChart');
            if (scatterCtx) {
                chartInstances.scatter = new Chart(scatterCtx.getContext('2d'), {
                    type: 'bubble', data: {
                        datasets: holdings.map((h, i) => ({
                            label: h.symbol,
                            data: [{ x: h.beta, y: h.volatility * 100, r: Math.max(4, h.weight * 80) }],
                            backgroundColor: riskScores[i] <= 3 ? 'rgba(40,167,69,0.6)' : riskScores[i] <= 6 ? 'rgba(255,193,7,0.6)' : 'rgba(220,53,69,0.6)',
                            borderColor: riskScores[i] <= 3 ? '#28a745' : riskScores[i] <= 6 ? '#ffc107' : '#dc3545'
                        }))
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Beta', color: '#aaa' }, ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                            y: { title: { display: true, text: 'Volatility (%)', color: '#aaa' }, ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                        },
                        plugins: { legend: { display: false }, tooltip: {
                            callbacks: { label: ctx => `${ctx.dataset.label}: Beta ${ctx.raw.x.toFixed(2)}, Vol ${ctx.raw.y.toFixed(1)}%` }
                        }}
                    }
                });
            }
        }, 100);
    }
    // Generic DOM table sorter for val-tables
    const _valSortState = {};
    function sortValTable(tbodyId, colIndex) {
        const state = _valSortState[tbodyId] = _valSortState[tbodyId] || { col: -1, asc: true };
        if (state.col === colIndex) { state.asc = !state.asc; } else { state.col = colIndex; state.asc = true; }
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
            const aText = a.cells[colIndex]?.innerText?.trim() || '';
            const bText = b.cells[colIndex]?.innerText?.trim() || '';
            const aNum = parseFloat(aText.replace(/[^0-9.-]/g, ''));
            const bNum = parseFloat(bText.replace(/[^0-9.-]/g, ''));
            if (!isNaN(aNum) && !isNaN(bNum)) return state.asc ? aNum - bNum : bNum - aNum;
            return state.asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
        });
        rows.forEach(r => tbody.appendChild(r));
        // Update header arrows in parent thead
        const thead = tbody.closest('table')?.querySelector('thead');
        if (thead) {
            thead.querySelectorAll('th[data-valcol]').forEach(th => {
                const arrow = th.querySelector('.val-sort-arrow');
                if (!arrow) return;
                arrow.textContent = parseInt(th.dataset.valcol) === colIndex ? (state.asc ? ' ‚Üë' : ' ‚Üì') : ' ‚Üï';
            });
        }
    }
    </script>

    <!-- Valuation Model Engines -->
    <script src="valuation-models/val-csv-export.js"></script>
    <script src="valuation-models/val-technical.js"></script>
    <script src="valuation-models/val-dividend.js"></script>
    <script src="valuation-models/val-competitive.js"></script>
    <script src="valuation-models/val-capital-allocation.js"></script>
    <script src="valuation-models/val-comparable.js"></script>
    <script src="valuation-models/val-esg.js"></script>
    <script src="valuation-models/val-factor.js"></script>
    <script src="valuation-models/val-macro.js"></script>
</body>
</html>
